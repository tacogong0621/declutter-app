<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Declutter">
    <meta name="description" content="Minimalism challenge - declutter and earn points">
    <title>Declutter Challenge (Online)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
        }

        .online-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4ade80;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #764ba2;
            margin: 20px 0;
        }

        .score-label {
            color: #666;
            font-size: 14px;
        }

        .streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .username-input {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            width: 200px;
            display: inline-block;
        }

        .badges-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .badge {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge.locked {
            background: #e0e0e0;
            color: #999;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 10px 4px;
            background: none;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            white-space: nowrap;
            min-width: 60px;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-area.has-image {
            border-style: solid;
            padding: 0;
        }

        .preview-image {
            width: 100%;
            border-radius: 15px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .item-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .item-date {
            font-size: 12px;
            color: #999;
        }

        .item-note {
            font-size: 13px;
            color: #667eea;
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .item-points {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .like-btn {
            background: none;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .like-btn:hover {
            border-color: #667eea;
        }

        .like-btn.liked {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .comment-btn {
            background: none;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .comment-btn:hover {
            border-color: #764ba2;
        }

        .delete-btn {
            background: none;
            border: 2px solid #ff4444;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #ff4444;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #ff4444;
            color: white;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment {
            padding: 10px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #333;
            font-size: 14px;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .comment-input button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .rank.top3 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #333;
        }

        .leaderboard-items {
            font-size: 12px;
            color: #999;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #667eea;
            font-size: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .category-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: inherit;
            background: white;
        }

        .points-info {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version {
            text-align: center;
            color: white;
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }

        .badge-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .badge-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .badge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .badge-modal-overlay.show {
            display: block;
        }

        .badge-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .badge-title {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .badge-desc {
            color: #666;
            margin-bottom: 20px;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #999;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            margin-bottom: 12px;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .social-btn:active {
            transform: translateY(0);
        }

        .social-btn-google {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .social-btn-google svg {
            width: 20px;
            height: 20px;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        .user-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .user-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .user-provider-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            background: #4285F4;
            color: white;
        }

        .lang-switch {
            text-align: center;
            margin-top: 10px;
        }

        .lang-switch a {
            color: white;
            opacity: 0.7;
            font-size: 12px;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .lang-switch a:hover {
            opacity: 1;
        }

        /* Space Bingo Styles */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            position: relative;
        }

        .bingo-cell.completed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-color: #38a169;
            color: white;
        }

        .bingo-cell .cell-emoji {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .bingo-cell .cell-name {
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
        }

        .bingo-cell.completed .cell-name {
            color: white;
        }

        .bingo-cell .cell-count {
            font-size: 10px;
            color: #718096;
            margin-top: 2px;
        }

        .bingo-cell.completed .cell-count {
            color: rgba(255, 255, 255, 0.9);
        }

        .bingo-cell .cell-progress {
            width: 80%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .bingo-cell.completed .cell-progress {
            background: rgba(255, 255, 255, 0.3);
        }

        .bingo-cell .cell-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .bingo-cell.completed .cell-progress-bar {
            background: white;
        }

        .bingo-lines-info {
            background: #f7fafc;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .bingo-lines-info .line-count {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .bingo-lines-info .line-label {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .bingo-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bingo-stat {
            background: #f7fafc;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
        }

        .bingo-stat .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }

        .bingo-stat .stat-label {
            font-size: 11px;
            color: #718096;
            margin-top: 4px;
        }

        .bingo-reset-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .space-hint {
            font-size: 13px;
            color: #48bb78;
            font-weight: 600;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f0fff4;
            border-radius: 8px;
            display: none;
        }

        /* Achievement Animation */
        .achievement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .achievement-overlay.show {
            display: flex;
        }

        .achievement-badge {
            font-size: 120px;
            animation: spinBadge 2s ease-in-out infinite;
        }

        @keyframes spinBadge {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .achievement-title {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }

        .achievement-subtitle {
            color: white;
            font-size: 18px;
            margin-top: 10px;
            text-align: center;
        }

        .achievement-points {
            color: #48bb78;
            font-size: 36px;
            font-weight: bold;
            margin-top: 15px;
        }

        .achievement-dismiss {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 30px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 3001;
            pointer-events: none;
            animation: confettiFall 3s ease-in-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üéØ</div>
            <div class="login-title">Declutter Challenge</div>
            <div class="login-subtitle">Start easily with your social account</div>

            <button class="social-btn social-btn-google" id="googleLoginBtn" onclick="handleGoogleLogin()">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="logout-btn" id="logoutBtn" onclick="handleLogout()">Logout</button>
            <div class="online-badge">
                <div class="online-dot"></div>
                Online
            </div>
            <h1>üéØ Declutter Challenge</h1>
            <div class="score-display" id="totalScore">0</div>
            <div class="score-label">Total Points</div>
            <div class="streak-badge" id="streakBadge">üî• 0 Day Streak</div>
            <div class="user-profile" id="userProfile">
                <div class="user-avatar-placeholder" id="userAvatar">?</div>
                <input type="text" class="username-input" id="usernameInput" placeholder="Enter nickname" maxlength="15">
                <span class="user-provider-badge" id="providerBadge"></span>
            </div>
            <div class="badges-container" id="badgesContainer"></div>
        </div>

        <div class="tabs">
            <button class="tab active" id="addTabBtn">‚ûï Add</button>
            <button class="tab" id="bingoTabBtn">üé≤ Bingo</button>
            <button class="tab" id="historyTabBtn">üìã Feed</button>
            <button class="tab" id="calendarTabBtn">üìÖ Calendar</button>
            <button class="tab" id="leaderboardTabBtn">üèÜ Ranks</button>
            <button class="tab" id="shareTabBtn">üì§ Share</button>
        </div>

        <div id="addTab" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Declutter Verification</h2>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <img id="previewImage" class="preview-image" alt="Preview">
                    <div id="uploadPrompt">
                        <div class="upload-icon">üì∏</div>
                        <div style="color: #667eea; font-weight: 600;">Take Photo / Choose from Gallery</div>
                        <div style="color: #999; font-size: 14px; margin-top: 5px;">Verify your decluttered item</div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*">

                <input type="text" id="itemName" placeholder="Item name (e.g., Old clothes)">
                
                <select class="category-select" id="itemCategory">
                    <option value="">Select Category</option>
                    <option value="clothes">Clothing (+10 pts)</option>
                    <option value="books">Books/Magazines (+15 pts)</option>
                    <option value="electronics">Electronics (+20 pts)</option>
                    <option value="furniture">Furniture (+30 pts)</option>
                    <option value="kitchen">Kitchenware (+10 pts)</option>
                    <option value="shoes">Shoes (+10 pts)</option>
                    <option value="food">Food (+5 pts)</option>
                    <option value="toys">Toys (+5 pts)</option>
                    <option value="sports">Sports Equipment (+15 pts)</option>
                    <option value="digital">Digital Photos/Docs (+5 pts)</option>
                    <option value="etc">Other (+5 pts)</option>
                </select>

                <select class="category-select" id="itemSpace">
                    <option value="">Select Space (Required)</option>
                    <option value="kitchen_space">üç≥ Kitchen</option>
                    <option value="bathroom">üöø Bathroom</option>
                    <option value="bedroom">üõèÔ∏è Bedroom</option>
                    <option value="living">üõãÔ∏è Living Room</option>
                    <option value="kids_room">üßí Kids Room</option>
                    <option value="closet">üëî Closet</option>
                    <option value="office">üíª Office</option>
                    <option value="garage">üîß Garage</option>
                    <option value="pantry">ü•´ Pantry</option>
                </select>
                <div class="space-hint" id="spaceHint"></div>

                <div class="points-info" id="pointsInfo" style="display: none;">
                    Expected Points: <span id="expectedPoints">0</span> pts
                </div>

                <textarea id="itemNote" placeholder="Your thoughts (optional)"></textarea>

                <button class="btn" id="submitBtn" onclick="addItem()">‚úÖ Complete!</button>
            </div>
        </div>

        <div id="bingoTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">üé≤ Space Bingo</h2>
                <p style="color: #666; margin-bottom: 15px; text-align: center; font-size: 14px;">Declutter 10 items per space for bingo! Complete lines for bonus!</p>

                <div class="bingo-stats">
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoCompleted">0</div>
                        <div class="stat-label">Spaces Done</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoLines">0</div>
                        <div class="stat-label">Bingo Lines</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoPoints">0</div>
                        <div class="stat-label">Bingo Points</div>
                    </div>
                </div>

                <div class="bingo-grid" id="bingoGrid"></div>

                <div class="bingo-lines-info" id="bingoLinesInfo">
                    <div class="line-count" id="bingoLineCount">0 / 8 Lines</div>
                    <div class="line-label">3 Horizontal + 3 Vertical + 2 Diagonal</div>
                </div>

                <button class="bingo-reset-btn" id="bingoResetBtn">üîÑ Reset Bingo</button>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Community Feed</h2>
                <div class="item-list" id="itemList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <div id="calendarTab" class="tab-content">
            <div class="card" style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <button onclick="changeMonth(-1)" style="background: none; border: 2px solid #667eea; color: #667eea; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">‚Üê</button>
                    <h2 id="calendarTitle" style="color: #333; margin: 0; font-size: 16px;">February 2026</h2>
                    <button onclick="changeMonth(1)" style="background: none; border: 2px solid #667eea; color: #667eea; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">‚Üí</button>
                </div>
                <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;"></div>
                <div style="margin-top: 12px; padding: 10px; background: #f8f9ff; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; justify-content: center; font-size: 11px;">
                        <span>üî• Decluttered</span>
                        <span style="color: #999;">‚ö™ Not yet</span>
                    </div>
                </div>
                <div id="monthStats" style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; text-align: center;">
                    <div style="font-size: 11px; opacity: 0.9;">This Month's Stats</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 6px 0;" id="monthItemCount">0</div>
                    <div style="font-size: 11px; opacity: 0.9;">items ‚Ä¢ <span id="monthPoints">0</span> pts earned</div>
                </div>
            </div>
        </div>

        <div id="leaderboardTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Global Rankings</h2>
                <div id="leaderboardList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading rankings...
                    </div>
                </div>
            </div>
        </div>

        <div id="shareTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">üì§ Share Story</h2>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">Select a template and download to share on Instagram Stories!</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="generateStoryTemplate('minimal')" style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        ‚ú® Minimal
                    </button>
                    <button onclick="generateStoryTemplate('stats')" style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        üìä Stats
                    </button>
                    <button onclick="generateStoryTemplate('streak')" style="padding: 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        üî• Streak
                    </button>
                    <button onclick="generateStoryTemplate('grid')" style="padding: 15px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        üì∏ Photo Grid
                    </button>
                </div>

                <canvas id="storyCanvas" style="width: 100%; max-width: 400px; margin: 0 auto; display: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);"></canvas>
                
                <div id="downloadSection" style="display: none; text-align: center; margin-top: 20px;">
                    <button onclick="downloadStoryImage()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;">
                        üì• Download Image
                    </button>
                    <p style="color: #999; font-size: 13px; margin-top: 10px;">Download and upload to Instagram Stories!</p>
                </div>
            </div>
        </div>

        <div class="version">v2.4 - Space Bingo Added</div>
        <div class="lang-switch">
            <a href="ko.html">üá∞üá∑ ÌïúÍµ≠Ïñ¥</a>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal-overlay" id="badgeOverlay" onclick="closeBadgeModal()"></div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-icon" id="badgeModalIcon">üèÜ</div>
        <div class="badge-title" id="badgeModalTitle">New Badge Earned!</div>
        <div class="badge-desc" id="badgeModalDesc">First item decluttered!</div>
        <button class="btn" onclick="closeBadgeModal()">OK</button>
    </div>

    <!-- Achievement Overlay -->
    <div class="achievement-overlay" id="achievementOverlay">
        <div class="achievement-badge" id="achievementBadge">üèÜ</div>
        <div class="achievement-title" id="achievementTitle">Space Complete!</div>
        <div class="achievement-subtitle" id="achievementSubtitle">Kitchen 10 items decluttered!</div>
        <div class="achievement-points" id="achievementPoints">+100 pts</div>
        <div class="achievement-dismiss">Tap to dismiss</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCgRc0r845aR7tTS7GNUmm8TMdLtSzeljY",
            authDomain: "declutter-challenge-94366.firebaseapp.com",
            projectId: "declutter-challenge-94366",
            storageBucket: "declutter-challenge-94366.firebasestorage.app",
            messagingSenderId: "781105372309",
            appId: "1:781105372309:web:4ce495d1dc8eac2b0d8f9c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        window.db = db;
        window.firestore = { collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment };

        let currentUserId = localStorage.getItem('userId') || null;
        let userName = localStorage.getItem('userName') || '';
        let totalScore = 0;
        let currentImage = null;
        let userStreak = 0;
        let userBadges = [];
        let bingoProgress = {};

        const bingoSpaces = [
            { key: 'kitchen_space', name: 'Kitchen', emoji: 'üç≥' },
            { key: 'bathroom', name: 'Bathroom', emoji: 'üöø' },
            { key: 'bedroom', name: 'Bedroom', emoji: 'üõèÔ∏è' },
            { key: 'living', name: 'Living Room', emoji: 'üõãÔ∏è' },
            { key: 'kids_room', name: 'Kids Room', emoji: 'üßí' },
            { key: 'closet', name: 'Closet', emoji: 'üëî' },
            { key: 'office', name: 'Office', emoji: 'üíª' },
            { key: 'garage', name: 'Garage', emoji: 'üîß' },
            { key: 'pantry', name: 'Pantry', emoji: 'ü•´' }
        ];

        const bingoLines = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        function getSpaceName(spaceKey) {
            const space = bingoSpaces.find(s => s.key === spaceKey);
            return space ? space.name : spaceKey;
        }

        function countBingoLines() {
            let count = 0;
            for (const line of bingoLines) {
                const allComplete = line.every(i => (bingoProgress[bingoSpaces[i].key] || 0) >= 10);
                if (allComplete) count++;
            }
            return count;
        }

        function countCompletedSpaces() {
            return bingoSpaces.filter(s => (bingoProgress[s.key] || 0) >= 10).length;
        }

        function renderBingoGrid() {
            const grid = document.getElementById('bingoGrid');
            if (!grid) return;

            const completedCount = countCompletedSpaces();
            const lineCount = countBingoLines();
            const bingoPointsEarned = completedCount * 100 + lineCount * 500 + (completedCount === 9 ? 3000 : 0);

            document.getElementById('bingoCompleted').textContent = completedCount;
            document.getElementById('bingoLines').textContent = lineCount;
            document.getElementById('bingoPoints').textContent = bingoPointsEarned;
            document.getElementById('bingoLineCount').textContent = `${lineCount} / 8 Lines`;

            const resetBtn = document.getElementById('bingoResetBtn');
            resetBtn.style.display = completedCount === 9 ? 'block' : 'none';

            grid.innerHTML = bingoSpaces.map(space => {
                const count = bingoProgress[space.key] || 0;
                const isComplete = count >= 10;
                const percent = Math.min(100, (count / 10) * 100);

                return `
                    <div class="bingo-cell ${isComplete ? 'completed' : ''}">
                        <div class="cell-emoji">${space.emoji}</div>
                        <div class="cell-name">${space.name}</div>
                        <div class="cell-count">${count} / 10</div>
                        <div class="cell-progress">
                            <div class="cell-progress-bar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSpaceHint() {
            const spaceSelect = document.getElementById('itemSpace');
            const hint = document.getElementById('spaceHint');
            const spaceKey = spaceSelect.value;

            if (spaceKey) {
                const count = bingoProgress[spaceKey] || 0;
                const space = bingoSpaces.find(s => s.key === spaceKey);
                if (count >= 10) {
                    hint.textContent = `${space.name}: ‚úÖ Complete! Bingo achieved!`;
                } else {
                    const remaining = 10 - count;
                    hint.textContent = `${space.name}: ${count}/10 - ${remaining} more! üéØ`;
                }
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }

        function showAchievement(title, subtitle, points) {
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementSubtitle').textContent = subtitle;
            document.getElementById('achievementPoints').textContent = `+${points} pts`;
            document.getElementById('achievementOverlay').classList.add('show');

            playVictorySound();
            spawnConfetti();
        }

        function hideAchievement() {
            document.getElementById('achievementOverlay').classList.remove('show');
        }

        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                const now = audioContext.currentTime;

                const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.12);
                    gain.gain.setValueAtTime(0.3, now + i * 0.12);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.12 + 0.2);
                    osc.start(now + i * 0.12);
                    osc.stop(now + i * 0.12 + 0.2);
                });
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        function spawnConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#48bb78', '#4299e1', '#ed64a6', '#ecc94b', '#9f7aea', '#fc8181', '#68d391', '#63b3ed'];
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 8 + 6) + 'px';
                confetti.style.height = (Math.random() * 8 + 6) + 'px';
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        async function loadBingoProgress() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    bingoProgress = userData.bingoProgress || {};
                } else {
                    bingoProgress = {};
                }
                renderBingoGrid();
                updateSpaceHint();
            } catch (error) {
                console.error('Bingo progress load failed:', error);
            }
        }

        async function updateBingoProgress(spaceKey) {
            const oldCount = bingoProgress[spaceKey] || 0;
            const oldLines = countBingoLines();
            const oldCompleted = countCompletedSpaces();

            bingoProgress[spaceKey] = oldCount + 1;
            const newCount = bingoProgress[spaceKey];

            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: bingoProgress
                    });
                }
            } catch (error) {
                console.error('Bingo progress update failed:', error);
            }

            if (newCount === 10) {
                const spaceName = getSpaceName(spaceKey);
                let bonusPoints = 100;
                totalScore += bonusPoints;

                await saveBonusPoints(bonusPoints);

                const newLines = countBingoLines();
                const linesEarned = newLines - oldLines;
                if (linesEarned > 0) {
                    const lineBonus = linesEarned * 500;
                    totalScore += lineBonus;
                    bonusPoints += lineBonus;
                    await saveBonusPoints(lineBonus);
                }

                const newCompleted = countCompletedSpaces();
                if (newCompleted === 9 && oldCompleted < 9) {
                    const allBonus = 3000;
                    totalScore += allBonus;
                    bonusPoints += allBonus;
                    await saveBonusPoints(allBonus);
                }

                document.getElementById('totalScore').textContent = totalScore;

                setTimeout(() => {
                    if (newCompleted === 9 && oldCompleted < 9) {
                        showAchievement('üéâ Bingo All Clear!', 'All 9 spaces completed!', bonusPoints);
                    } else if (linesEarned > 0) {
                        showAchievement('üé≤ Bingo!', `${spaceName} done + ${linesEarned} line bingo!`, bonusPoints);
                    } else {
                        showAchievement('‚ú® Space Complete!', `${spaceName} 10 items decluttered!`, bonusPoints);
                    }
                }, 500);
            }

            renderBingoGrid();
            updateSpaceHint();
        }

        async function saveBonusPoints(points) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore
                    });
                }
            } catch (error) {
                console.error('Bonus points save failed:', error);
            }
        }

        async function resetBingo() {
            if (!confirm('Reset bingo? All progress will be cleared.')) return;

            bingoProgress = {};
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: {}
                    });
                }
            } catch (error) {
                console.error('Bingo reset failed:', error);
            }
            renderBingoGrid();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function hideLoginScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
        }

        function updateProfileUI() {
            const provider = localStorage.getItem('authProvider');
            const photo = localStorage.getItem('userPhoto');
            const avatarEl = document.getElementById('userAvatar');
            const badgeEl = document.getElementById('providerBadge');

            if (photo) {
                avatarEl.outerHTML = `<img src="${photo}" alt="Profile" class="user-avatar" id="userAvatar" referrerpolicy="no-referrer">`;
            } else {
                avatarEl.outerHTML = `<div class="user-avatar-placeholder" id="userAvatar">${(userName || '?').charAt(0)}</div>`;
            }

            if (provider === 'google') {
                badgeEl.textContent = 'Google';
                badgeEl.style.display = 'inline-block';
            }
        }

        window.handleGoogleLogin = async function() {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                currentUserId = 'google_' + user.uid;
                userName = user.displayName || 'User';
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('userName', userName);
                localStorage.setItem('authProvider', 'google');
                localStorage.setItem('userPhoto', user.photoURL || '');
                document.getElementById('usernameInput').value = userName;
                updateProfileUI();
                hideLoginScreen();
                await initApp();
            } catch (error) {
                console.error('Google login failed:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    alert('Google login failed. Please check if Google login is enabled in Firebase Console.');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Sign in with Google`;
            }
        };

        window.handleLogout = async function() {
            if (!confirm('Are you sure you want to logout?')) return;
            const provider = localStorage.getItem('authProvider');

            try {
                if (provider === 'google') {
                    await signOut(auth);
                }
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('authProvider');
            localStorage.removeItem('userPhoto');
            currentUserId = null;
            userName = '';
            totalScore = 0;
            userStreak = 0;
            userBadges = [];
            showLoginScreen();
        };

        const categoryPoints = {
            'clothes': 10,
            'books': 15,
            'electronics': 20,
            'furniture': 30,
            'kitchen': 10,
            'shoes': 10,
            'food': 5,
            'toys': 5,
            'sports': 15,
            'digital': 5,
            'etc': 5
        };

        const badges = {
            'first_item': { icon: 'üéØ', name: 'First Step', desc: 'First item decluttered', condition: (count) => count >= 1 },
            'five_items': { icon: '‚≠ê', name: 'Passionate', desc: '5 items decluttered', condition: (count) => count >= 5 },
            'ten_items': { icon: 'üíé', name: 'Determined', desc: '10 items decluttered', condition: (count) => count >= 10 },
            'twenty_items': { icon: 'üëë', name: 'Declutter King', desc: '20 items decluttered', condition: (count) => count >= 20 },
            'streak_3': { icon: 'üî•', name: 'Consistent', desc: '3 day streak', condition: (streak) => streak >= 3, isStreak: true },
            'streak_7': { icon: 'üí™', name: 'Habit', desc: '7 day streak', condition: (streak) => streak >= 7, isStreak: true },
            'streak_30': { icon: 'üèÖ', name: 'Master', desc: '30 day streak', condition: (streak) => streak >= 30, isStreak: true }
        };

        document.getElementById('usernameInput').addEventListener('change', function(e) {
            userName = e.target.value.trim() || userName;
            localStorage.setItem('userName', userName);
            if (currentUserId) {
                updateUserProfile();
            }
        });

        async function updateUserProfile() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: 0,
                        itemCount: 0,
                        streak: 0,
                        lastDeclutterDate: null,
                        badges: [],
                        bingoProgress: {},
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Profile update failed:', error);
            }
        }

        async function generateAIEncouragement(itemName, category, points, totalScore, streak) {
            try {
                const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
                const itemsSnapshot = await getDocs(itemsQuery);
                
                const categoryCount = {};
                itemsSnapshot.forEach(doc => {
                    const data = doc.data();
                    categoryCount[data.category] = (categoryCount[data.category] || 0) + 1;
                });

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 150,
                        messages: [{
                            role: 'user',
                            content: `User decluttered "${itemName}" (${getCategoryName(category)}) in a minimalism challenge.

Current status:
- Points earned: ${points}
- Total points: ${totalScore}
- Streak: ${streak} days
- Category stats: ${JSON.stringify(categoryCount)}

Write a short, warm encouragement message in ONE sentence. Include 1-2 emojis.
Style: Friendly and encouraging tone, specific praise, occasional suggestions.
Example styles:
- "Furniture takes real commitment - amazing work! üëè"
- "You're really good at the ${getCategoryName(category)} category! Minimalist vibes üëç"
- "Streak day ${streak} achieved! Keep going! üî•"
Don't copy examples - be creative.`
                        }]
                    })
                });

                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.content[0].text.trim();
            } catch (error) {
                console.error('AI message generation failed:', error);
                const defaultMessages = [
                    "Great job! You're making progress step by step ‚ú®",
                    "Awesome! The decluttering habit is forming üí™",
                    "Amazing! Your space and mind are getting lighter üéà",
                    "Well done! You're becoming a minimalist master üåü",
                    "Excellent! You're enjoying the decluttering process üéØ"
                ];
                return defaultMessages[Math.floor(Math.random() * defaultMessages.length)];
            }
        }

        function getCategoryName(category) {
            const names = {
                'clothes': 'Clothing',
                'books': 'Books/Magazines',
                'electronics': 'Electronics',
                'furniture': 'Furniture',
                'kitchen': 'Kitchenware',
                'shoes': 'Shoes',
                'food': 'Food',
                'toys': 'Toys',
                'sports': 'Sports Equipment',
                'digital': 'Digital Photos/Docs',
                'etc': 'Other'
            };
            return names[category] || category;
        }

        async function calculateStreak() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const lastDate = userData.lastDeclutterDate?.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (lastDate) {
                        const lastDateOnly = new Date(lastDate);
                        lastDateOnly.setHours(0, 0, 0, 0);
                        
                        const diffTime = today - lastDateOnly;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            userStreak = userData.streak || 0;
                        } else if (diffDays === 1) {
                            userStreak = (userData.streak || 0) + 1;
                        } else {
                            userStreak = 1;
                        }
                    } else {
                        userStreak = 1;
                    }
                    
                    await updateDoc(doc(db, 'users', userSnapshot.docs[0].id), {
                        streak: userStreak,
                        lastDeclutterDate: serverTimestamp()
                    });
                    
                    document.getElementById('streakBadge').textContent = `üî• ${userStreak} Day Streak`;
                    checkBadges(null, userStreak);
                }
            } catch (error) {
                console.error('Streak calculation failed:', error);
            }
        }

        async function checkBadges(itemCount = null, streak = null) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    userBadges = userData.badges || [];
                    
                    const currentCount = itemCount !== null ? itemCount : userData.itemCount || 0;
                    const currentStreak = streak !== null ? streak : userData.streak || 0;
                    
                    for (const [key, badge] of Object.entries(badges)) {
                        if (!userBadges.includes(key)) {
                            const earned = badge.isStreak 
                                ? badge.condition(currentStreak)
                                : badge.condition(currentCount);
                                
                            if (earned) {
                                userBadges.push(key);
                                await updateDoc(doc(db, 'users', userDoc.id), {
                                    badges: arrayUnion(key)
                                });
                                showBadgeModal(badge);
                            }
                        }
                    }
                    
                    renderBadges();
                }
            } catch (error) {
                console.error('Badge check failed:', error);
            }
        }

        function renderBadges() {
            const container = document.getElementById('badgesContainer');
            container.innerHTML = Object.entries(badges).map(([key, badge]) => {
                const earned = userBadges.includes(key);
                return `
                    <div class="badge ${earned ? '' : 'locked'}" title="${badge.desc}">
                        ${badge.icon} ${badge.name}
                    </div>
                `;
            }).join('');
        }

        function showBadgeModal(badge) {
            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalTitle').textContent = `${badge.name} Badge Earned!`;
            document.getElementById('badgeModalDesc').textContent = badge.desc;
            document.getElementById('badgeModal').classList.add('show');
            document.getElementById('badgeOverlay').classList.add('show');
        }

        window.closeBadgeModal = function() {
            document.getElementById('badgeModal').classList.remove('show');
            document.getElementById('badgeOverlay').classList.remove('show');
        };

        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.type = 'square';
                osc1.frequency.setValueAtTime(523.25, now);
                gain1.gain.setValueAtTime(0.3, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(659.25, now + 0.15);
                gain2.gain.setValueAtTime(0.3, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
                
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.type = 'square';
                osc3.frequency.setValueAtTime(783.99, now + 0.3);
                gain3.gain.setValueAtTime(0.3, now + 0.3);
                gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                osc3.start(now + 0.3);
                osc3.stop(now + 0.45);
                
                const osc4 = audioContext.createOscillator();
                const gain4 = audioContext.createGain();
                osc4.connect(gain4);
                gain4.connect(audioContext.destination);
                osc4.type = 'square';
                osc4.frequency.setValueAtTime(1046.50, now + 0.45);
                gain4.gain.setValueAtTime(0.35, now + 0.45);
                gain4.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc4.start(now + 0.45);
                osc4.stop(now + 0.9);
                
                const osc5 = audioContext.createOscillator();
                const gain5 = audioContext.createGain();
                osc5.connect(gain5);
                gain5.connect(audioContext.destination);
                osc5.type = 'sine';
                osc5.frequency.setValueAtTime(1318.51, now + 0.45);
                gain5.gain.setValueAtTime(0.2, now + 0.45);
                gain5.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc5.start(now + 0.45);
                osc5.stop(now + 0.9);
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        function compressImage(file, maxSizeKB = 500) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 800;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.7;
                        let compressed = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressed = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                currentImage = await compressImage(file, 500);
                
                const preview = document.getElementById('previewImage');
                const uploadArea = document.getElementById('uploadArea');
                const uploadPrompt = document.getElementById('uploadPrompt');
                
                preview.src = currentImage;
                preview.classList.add('show');
                uploadPrompt.style.display = 'none';
                uploadArea.classList.add('has-image');
            }
        });

        document.getElementById('itemCategory').addEventListener('change', function(e) {
            const pointsInfo = document.getElementById('pointsInfo');
            const expectedPoints = document.getElementById('expectedPoints');
            
            if (e.target.value) {
                expectedPoints.textContent = categoryPoints[e.target.value];
                pointsInfo.style.display = 'block';
            } else {
                pointsInfo.style.display = 'none';
            }
        });

        window.addItem = async function() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const space = document.getElementById('itemSpace').value;
            const note = document.getElementById('itemNote').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!name) {
                alert('Please enter item name!');
                return;
            }

            if (!category) {
                alert('Please select a category!');
                return;
            }

            if (!space) {
                alert('Please select a space!');
                return;
            }

            if (!currentImage) {
                alert('Please upload a photo!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            try {
                const points = categoryPoints[category];

                await addDoc(collection(db, 'items'), {
                    userId: currentUserId,
                    userName: userName,
                    name: name,
                    category: category,
                    space: space,
                    note: note,
                    image: currentImage,
                    points: points,
                    likes: [],
                    likeCount: 0,
                    comments: [],
                    createdAt: serverTimestamp()
                });

                totalScore += points;
                await updateUserScore();
                await calculateStreak();
                await updateBingoProgress(space);

                playSuccessSound();

                const aiMessage = await generateAIEncouragement(name, category, points, totalScore, userStreak);

                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemSpace').value = '';
                document.getElementById('itemNote').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('previewImage').classList.remove('show');
                document.getElementById('uploadPrompt').style.display = 'block';
                document.getElementById('uploadArea').classList.remove('has-image');
                document.getElementById('pointsInfo').style.display = 'none';
                document.getElementById('spaceHint').style.display = 'none';
                currentImage = null;

                alert(`üéâ +${points} pts earned!\n\n${aiMessage}\n\nTotal: ${totalScore} pts!`);

                switchTab('history');
            } catch (error) {
                console.error('Item add failed:', error);
                alert('Upload failed! Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Complete!';
            }
        };

        async function updateUserScore() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newItemCount = (userData.itemCount || 0) + 1;
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore,
                        itemCount: newItemCount,
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(newItemCount);
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: totalScore,
                        itemCount: 1,
                        streak: 0,
                        badges: [],
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(1);
                }
                
                document.getElementById('totalScore').textContent = totalScore;
            } catch (error) {
                console.error('Score update failed:', error);
            }
        }

        window.toggleLike = async function(itemId, itemDocId) {
            try {
                const itemRef = doc(db, 'items', itemDocId);
                const itemDoc = await getDocs(query(collection(db, 'items'), where('__name__', '==', itemDocId)));
                
                if (!itemDoc.empty) {
                    const itemData = itemDoc.docs[0].data();
                    const likes = itemData.likes || [];
                    
                    if (likes.includes(currentUserId)) {
                        await updateDoc(itemRef, {
                            likes: arrayRemove(currentUserId),
                            likeCount: increment(-1)
                        });
                    } else {
                        await updateDoc(itemRef, {
                            likes: arrayUnion(currentUserId),
                            likeCount: increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error('Like failed:', error);
            }
        };

        window.toggleComments = function(itemId) {
            const commentsSection = document.getElementById(`comments-${itemId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('show');
            }
        };

        window.addComment = async function(itemId, itemDocId) {
            const input = document.getElementById(`comment-input-${itemId}`);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            try {
                const itemRef = doc(db, 'items', itemDocId);
                await updateDoc(itemRef, {
                    comments: arrayUnion({
                        userId: currentUserId,
                        userName: userName,
                        text: commentText,
                        createdAt: new Date().toISOString()
                    })
                });
                
                input.value = '';
            } catch (error) {
                console.error('Comment add failed:', error);
            }
        };

        window.deleteItem = async function(itemDocId, itemUserId, itemPoints) {
            if (itemUserId !== currentUserId) {
                alert('You can only delete your own items!');
                return;
            }

            if (!confirm('Are you sure you want to delete?')) {
                return;
            }

            try {
                const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await deleteDoc(doc(db, 'items', itemDocId));

                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newScore = Math.max(0, (userData.score || 0) - itemPoints);
                    const newItemCount = Math.max(0, (userData.itemCount || 0) - 1);
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: newScore,
                        itemCount: newItemCount
                    });

                    totalScore = newScore;
                    document.getElementById('totalScore').textContent = totalScore;
                }

                alert('Deleted!');
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Delete failed. Please try again.');
            }
        };

        async function loadMyItems() {
            const listElement = document.getElementById('itemList');
            
            try {
                const itemsQuery = query(collection(db, 'items'), limit(50));

                onSnapshot(itemsQuery, (snapshot) => {
                    const items = [];
                    let myScore = 0;
                    
                    snapshot.forEach((doc) => {
                        const item = doc.data();
                        items.push({
                            ...item,
                            id: doc.id,
                            docId: doc.id
                        });
                        if (item.userId === currentUserId) {
                            myScore += item.points || 0;
                        }
                    });

                    items.sort((a, b) => {
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });

                    totalScore = myScore;
                    document.getElementById('totalScore').textContent = totalScore;

                    if (items.length === 0) {
                        listElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üì¶</div>
                                <div>No items yet</div>
                                <div style="font-size: 14px; margin-top: 10px;">Declutter your first item!</div>
                            </div>
                        `;
                        return;
                    }

                    listElement.innerHTML = items.map(item => {
                        const date = item.createdAt?.toDate() || new Date();
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        const isMyItem = item.userId === currentUserId;
                        const isLiked = (item.likes || []).includes(currentUserId);
                        const likeCount = item.likeCount || 0;
                        const comments = item.comments || [];
                        const hasNote = item.note && item.note.trim();
                        
                        return `
                            <div class="item" style="${isMyItem ? 'background: #f8f9ff;' : ''}">
                                <div class="item-header">
                                    <img src="${item.image}" alt="${item.name}" class="item-image">
                                    <div class="item-info">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-date">${item.userName || 'Anonymous'} ‚Ä¢ ${dateStr}</div>
                                        ${hasNote ? `<div class="item-note">üí≠ "${item.note}"</div>` : ''}
                                    </div>
                                    <div class="item-points">+${item.points}</div>
                                </div>
                                <div class="item-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${item.id}', '${item.docId}')">
                                        ‚ù§Ô∏è ${likeCount}
                                    </button>
                                    <button class="comment-btn" onclick="toggleComments('${item.id}')">
                                        üí¨ ${comments.length}
                                    </button>
                                    ${isMyItem ? `<button class="delete-btn" onclick="deleteItem('${item.docId}', '${item.userId}', ${item.points})">üóëÔ∏è Delete</button>` : ''}
                                </div>
                                <div class="comments-section" id="comments-${item.id}">
                                    ${comments.map(c => `
                                        <div class="comment">
                                            <div class="comment-author">${c.userName}</div>
                                            <div class="comment-text">${c.text}</div>
                                        </div>
                                    `).join('')}
                                    <div class="comment-input">
                                        <input type="text" id="comment-input-${item.id}" placeholder="Add comment...">
                                        <button onclick="addComment('${item.id}', '${item.docId}')">Post</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('Items load failed:', error);
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div>Data load failed</div>
                    </div>
                `;
            }
        }

        async function loadLeaderboard() {
            const leaderboardElement = document.getElementById('leaderboardList');
            
            try {
                const usersQuery = query(collection(db, 'users'), orderBy('score', 'desc'), limit(20));

                onSnapshot(usersQuery, (snapshot) => {
                    const users = [];
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        users.push(user);
                    });

                    if (users.length === 0) {
                        leaderboardElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üèÜ</div>
                                <div>No participants yet</div>
                            </div>
                        `;
                        return;
                    }

                    leaderboardElement.innerHTML = users.map((user, index) => {
                        const isCurrentUser = user.userId === currentUserId;
                        const rank = index + 1;
                        const rankClass = rank <= 3 ? 'top3' : '';
                        const userStreak = user.streak || 0;
                        
                        return `
                            <div class="leaderboard-item" style="${isCurrentUser ? 'background: #f8f9ff;' : ''}">
                                <div class="rank ${rankClass}">${rank}</div>
                                <div class="leaderboard-info">
                                    <div class="leaderboard-name">${user.name || 'Anonymous'}${isCurrentUser ? ' üë§' : ''}</div>
                                    <div class="leaderboard-items">${user.itemCount || 0} items ‚Ä¢ üî• ${userStreak} days</div>
                                </div>
                                <div class="leaderboard-score">${user.score || 0}</div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('Leaderboard load failed:', error);
            }
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'add') {
                document.getElementById('addTabBtn').classList.add('active');
                document.getElementById('addTab').classList.add('active');
                updateSpaceHint();
            } else if (tab === 'bingo') {
                document.getElementById('bingoTabBtn').classList.add('active');
                document.getElementById('bingoTab').classList.add('active');
                loadBingoProgress();
            } else if (tab === 'history') {
                document.getElementById('historyTabBtn').classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                loadMyItems();
            } else if (tab === 'calendar') {
                document.getElementById('calendarTabBtn').classList.add('active');
                document.getElementById('calendarTab').classList.add('active');
                renderCalendar();
            } else if (tab === 'leaderboard') {
                document.getElementById('leaderboardTabBtn').classList.add('active');
                document.getElementById('leaderboardTab').classList.add('active');
                loadLeaderboard();
            } else if (tab === 'share') {
                document.getElementById('shareTabBtn').classList.add('active');
                document.getElementById('shareTab').classList.add('active');
            }
        };

        document.getElementById('addTabBtn').addEventListener('click', () => switchTab('add'));
        document.getElementById('bingoTabBtn').addEventListener('click', () => switchTab('bingo'));
        document.getElementById('historyTabBtn').addEventListener('click', () => switchTab('history'));
        document.getElementById('calendarTabBtn').addEventListener('click', () => switchTab('calendar'));
        document.getElementById('leaderboardTabBtn').addEventListener('click', () => switchTab('leaderboard'));
        document.getElementById('shareTabBtn').addEventListener('click', () => switchTab('share'));

        document.getElementById('itemSpace').addEventListener('change', updateSpaceHint);
        document.getElementById('achievementOverlay').addEventListener('click', hideAchievement);
        document.getElementById('bingoResetBtn').addEventListener('click', resetBingo);

        let currentCalendarYear = 2026;
        let currentCalendarMonth = 1;
        let userItemDates = {};

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendarTitle');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            title.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            
            userItemDates = {};
            let monthItemCount = 0;
            let monthPoints = 0;
            
            itemsSnapshot.forEach(doc => {
                const item = doc.data();
                if (item.createdAt) {
                    const date = item.createdAt.toDate();
                    const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                    
                    if (!userItemDates[dateKey]) {
                        userItemDates[dateKey] = {
                            count: 0,
                            points: 0
                        };
                    }
                    userItemDates[dateKey].count += 1;
                    userItemDates[dateKey].points += item.points || 0;
                    
                    if (date.getFullYear() === currentCalendarYear && date.getMonth() === currentCalendarMonth) {
                        monthItemCount += 1;
                        monthPoints += item.points || 0;
                    }
                }
            });
            
            document.getElementById('monthItemCount').textContent = monthItemCount;
            document.getElementById('monthPoints').textContent = monthPoints;
            
            calendar.innerHTML = '';
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = 'text-align: center; font-weight: 600; padding: 4px 2px; color: #666; font-size: 10px;';
                if (index === 0) dayHeader.style.color = '#ff4444';
                if (index === 6) dayHeader.style.color = '#4444ff';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentCalendarYear}-${currentCalendarMonth}-${day}`;
                const hasItem = userItemDates[dateKey];
                const isToday = new Date().getDate() === day && 
                               new Date().getMonth() === currentCalendarMonth && 
                               new Date().getFullYear() === currentCalendarYear;
                
                const dayCell = document.createElement('div');
                dayCell.style.cssText = `
                    aspect-ratio: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    border-radius: 6px;
                    position: relative;
                    cursor: pointer;
                    transition: all 0.3s;
                    ${hasItem ? 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);' : 'background: #f0f0f0;'}
                    ${isToday ? 'border: 2px solid #667eea;' : ''}
                    font-size: 10px;
                `;
                
                const dayNumber = document.createElement('div');
                dayNumber.style.cssText = `
                    font-size: 11px;
                    font-weight: 600;
                    ${hasItem ? 'color: white;' : 'color: #999;'}
                `;
                dayNumber.textContent = day;
                
                if (hasItem) {
                    const flame = document.createElement('div');
                    flame.style.cssText = 'font-size: 14px; margin-top: 1px; line-height: 1;';
                    flame.textContent = 'üî•';
                    dayCell.appendChild(dayNumber);
                    dayCell.appendChild(flame);
                    
                    if (hasItem.count > 1) {
                        const count = document.createElement('div');
                        count.style.cssText = 'font-size: 8px; color: white; font-weight: 600; line-height: 1;';
                        count.textContent = `${hasItem.count}`;
                        dayCell.appendChild(count);
                    }
                } else {
                    dayCell.appendChild(dayNumber);
                }
                
                calendar.appendChild(dayCell);
            }
        }

        window.changeMonth = function(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        };

        window.generateStoryTemplate = async function(template) {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            const userData = userSnapshot.empty ? {} : userSnapshot.docs[0].data();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            const userItems = [];
            itemsSnapshot.forEach(doc => userItems.push(doc.data()));
            
            if (template === 'minimal') {
                drawMinimalTemplate(ctx, userData, userItems);
            } else if (template === 'stats') {
                drawStatsTemplate(ctx, userData, userItems);
            } else if (template === 'streak') {
                drawStreakTemplate(ctx, userData);
            } else if (template === 'grid') {
                await drawGridTemplate(ctx, userData, userItems);
            }
            
            canvas.style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        };

        function drawMinimalTemplate(ctx, userData, items) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üéØ Declutter Challenge', 540, 300);
            
            ctx.font = 'bold 180px sans-serif';
            ctx.fillText(userData.score || 0, 540, 800);
            
            ctx.font = '60px sans-serif';
            ctx.fillText('POINTS', 540, 900);
            
            ctx.font = 'bold 50px sans-serif';
            ctx.fillText(`${items.length} items decluttered`, 540, 1100);
            
            ctx.font = '50px sans-serif';
            ctx.fillText(`üî• ${userData.streak || 0} day streak`, 540, 1200);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);
            
            ctx.font = '40px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText('Practicing Minimal Life', 540, 1700);
        }

        function drawStatsTemplate(ctx, userData, items) {
            ctx.fillStyle = '#f8f9ff';
            ctx.fillRect(0, 0, 1080, 1920);
            
            const headerGradient = ctx.createLinearGradient(0, 0, 0, 400);
            headerGradient.addColorStop(0, '#667eea');
            headerGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = headerGradient;
            ctx.fillRect(0, 0, 1080, 400);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üìä My Declutter Stats', 540, 250);
            
            const categoryCount = {};
            items.forEach(item => {
                categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
            });
            
            const categories = [
                { key: 'furniture', name: 'Furniture', emoji: 'üõãÔ∏è' },
                { key: 'electronics', name: 'Electronics', emoji: 'üì±' },
                { key: 'books', name: 'Books', emoji: 'üìö' },
                { key: 'clothes', name: 'Clothing', emoji: 'üëï' },
                { key: 'kitchen', name: 'Kitchenware', emoji: 'üç≥' },
                { key: 'shoes', name: 'Shoes', emoji: 'üëü' },
                { key: 'food', name: 'Food', emoji: 'üçî' },
                { key: 'toys', name: 'Toys', emoji: 'üß∏' },
                { key: 'sports', name: 'Sports Equipment', emoji: 'üèãÔ∏è' },
                { key: 'digital', name: 'Digital Photos/Docs', emoji: 'üìÑ' },
                { key: 'etc', name: 'Other', emoji: 'üì¶' }
            ];
            
            let y = 550;
            ctx.textAlign = 'left';
            categories.forEach(cat => {
                const count = categoryCount[cat.key] || 0;
                
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 20;
                ctx.fillRect(80, y - 80, 920, 120);
                ctx.shadowBlur = 0;
                
                ctx.font = '60px sans-serif';
                ctx.fillText(cat.emoji, 120, y);
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 50px sans-serif';
                ctx.fillText(cat.name, 220, y);
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 60px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${count}`, 950, y);
                ctx.textAlign = 'left';
                
                y += 180;
            });
            
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 55px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`Total ${items.length} items ‚Ä¢ ${userData.score || 0} pts`, 540, 1750);
        }

        function drawStreakTemplate(ctx, userData) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
            gradient.addColorStop(0, '#f093fb');
            gradient.addColorStop(1, '#f5576c');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            ctx.font = '300px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üî•', 540, 650);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 200px sans-serif';
            ctx.fillText(userData.streak || 0, 540, 1000);
            
            ctx.font = 'bold 80px sans-serif';
            ctx.fillText('Day Streak', 540, 1120);
            
            ctx.font = '50px sans-serif';
            const streak = userData.streak || 0;
            let message = 'Practicing daily!';
            if (streak >= 30) message = 'One month achieved!';
            else if (streak >= 7) message = 'One week achieved!';
            else if (streak >= 3) message = 'Building good habits!';
            
            ctx.fillText(message, 540, 1400);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1650);
        }

        async function drawGridTemplate(ctx, userData, items) {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 1080, 1920);
            
            const headerGradient = ctx.createLinearGradient(0, 0, 0, 350);
            headerGradient.addColorStop(0, '#43e97b');
            headerGradient.addColorStop(1, '#38f9d7');
            ctx.fillStyle = headerGradient;
            ctx.fillRect(0, 0, 1080, 350);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`üì∏ ${items.length} items decluttered!`, 540, 220);
            
            const recentItems = items.slice(0, 6);
            const gridSize = 320;
            const gap = 30;
            const startX = 60;
            const startY = 400;
            
            for (let i = 0; i < 6; i++) {
                const row = Math.floor(i / 3);
                const col = i % 3;
                const x = startX + col * (gridSize + gap);
                const y = startY + row * (gridSize + gap);
                
                if (i < recentItems.length && recentItems[i].image) {
                    try {
                        const img = new Image();
                        img.src = recentItems[i].image;
                        await new Promise(resolve => {
                            img.onload = () => {
                                ctx.save();
                                ctx.beginPath();
                                ctx.roundRect(x, y, gridSize, gridSize, 20);
                                ctx.clip();
                                ctx.drawImage(img, x, y, gridSize, gridSize);
                                ctx.restore();
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) {
                        ctx.fillStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.roundRect(x, y, gridSize, gridSize, 20);
                        ctx.fill();
                    }
                } else {
                    ctx.fillStyle = '#f0f0f0';
                    ctx.beginPath();
                    ctx.roundRect(x, y, gridSize, gridSize, 20);
                    ctx.fill();
                }
            }
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`üèÜ ${userData.score || 0} pts`, 270, 1650);
            ctx.fillText(`üî• ${userData.streak || 0} days`, 810, 1650);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1800);
        }

        window.downloadStoryImage = function() {
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = `declutter-story-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        async function initApp() {
            if (!currentUserId) return;
            document.getElementById('usernameInput').value = userName;
            updateProfileUI();
            await updateUserProfile();
            await loadMyItems();

            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            if (!userSnapshot.empty) {
                const userData = userSnapshot.docs[0].data();
                userStreak = userData.streak || 0;
                userBadges = userData.badges || [];
                bingoProgress = userData.bingoProgress || {};
                document.getElementById('streakBadge').textContent = `üî• ${userStreak} Day Streak`;
                renderBadges();
                renderBingoGrid();
            }
        }

        (function checkAuthState() {
            const savedUserId = localStorage.getItem('userId');
            const savedProvider = localStorage.getItem('authProvider');

            if (savedUserId && savedProvider) {
                currentUserId = savedUserId;
                userName = localStorage.getItem('userName') || '';
                hideLoginScreen();
                initApp();
            } else {
                showLoginScreen();
            }
        })();
    </script>
</body>
</html>