<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FAFAFA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Declutter Daily">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Declutter Daily - Build your minimalist habit one item at a time. Track progress, earn badges, and join the community.">
    <title>Declutter Daily - One Item at a Time</title>
    <style>
        /* CRITICAL - Mobile First Foundation */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            background: #FAFAFA;
            min-height: 100vh;
        }

        /* Container - Mobile First */
        .container {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Profile Header - Compact */
        .profile-header {
            background: white;
            padding: 15px 20px 20px;
            border-bottom: 1px solid #F0F0F0;
            position: relative;
            flex-shrink: 0;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: transparent;
            border: none;
            color: #6B6B6B;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
        }

        .online-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #1C1C1E;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .profile-content {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 30px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1C1C1E 0%, #4A4A4A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-provider {
            font-size: 11px;
            color: #6B6B6B;
            background: #F0F0F0;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .stat-label {
            font-size: 10px;
            color: #6B6B6B;
            margin-top: 2px;
        }

        .badges-display {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .header-badge-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #1C1C1E 0%, #3A3A3A 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
        }

        .view-all-badges {
            background: #FAFAFA;
            color: #6B6B6B;
            border: 1px solid #E5E5E5;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Main Content - Scrollable */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }

        /* Hide old UI elements */
        .header, .tabs, .old-badge-container {
            display: none !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Add Item Card */
        .add-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #F0F0F0;
            width: 100%;
            max-width: 100%;
        }

        .add-title {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 20px;
        }

        .card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #E5E5E5;
            box-shadow: none;
        }

        /* Upload Area */
        .upload-area {
            background: #FAFAFA;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
            width: 100%;
        }

        .upload-area.has-image {
            padding: 0;
        }

        .upload-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 13px;
            color: #6B6B6B;
        }

        input[type="file"] {
            display: none;
        }

        /* Form Inputs - Mobile Optimized */
        input[type="text"], select, textarea {
            width: 100%;
            max-width: 100%;
            padding: 12px 15px;
            border: 1px solid #E5E5E5;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 12px;
            background: white;
            color: #1C1C1E;
            -webkit-appearance: none;
            box-sizing: border-box;
            font-family: inherit;
        }

        input::placeholder, textarea::placeholder {
            color: #B0B0B0;
        }

        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1C1C1E;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B6B6B' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        textarea {
            resize: none;
            min-height: 80px;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn:active {
            opacity: 0.75;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Bottom Navigation - ALWAYS Fixed */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #F0F0F0;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-icon {
            font-size: 22px;
            line-height: 1;
        }

        .nav-label {
            font-size: 10px;
            color: #6B6B6B;
            font-weight: 500;
        }

        .nav-item.active .nav-label {
            color: #1C1C1E;
            font-weight: 600;
        }

        .item-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 5px;
        }

        .item-date {
            font-size: 12px;
            color: #6B6B6B;
        }

        .item-note {
            font-size: 13px;
            color: #6B6B6B;
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: #FAFAFA;
            border-radius: 8px;
            border-left: 2px solid #1C1C1E;
        }

        .item-points {
            font-weight: 700;
            color: #1C1C1E;
            font-size: 18px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .like-btn {
            background: #EAEAEA;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #1C1C1E;
            transition: all 0.2s;
        }

        .like-btn:hover {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .like-btn.liked {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .comment-btn {
            background: #EAEAEA;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #1C1C1E;
            transition: all 0.2s;
        }

        .comment-btn:hover {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .delete-btn {
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #6B6B6B;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #FAFAFA;
            border-color: #DC3545;
            color: #DC3545;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment {
            padding: 10px;
            background: #FAFAFA;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            color: #1C1C1E;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #6B6B6B;
            font-size: 14px;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #E5E5E5;
            border-radius: 10px;
            font-size: 14px;
            color: #1C1C1E;
        }

        .comment-input button {
            padding: 10px 20px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1C1C1E;
            color: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }

        .rank.top3 {
            background: #1C1C1E;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #1C1C1E;
        }

        .leaderboard-items {
            font-size: 12px;
            color: #6B6B6B;
        }

        .leaderboard-score {
            font-weight: 700;
            color: #1C1C1E;
            font-size: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6B6B6B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .category-select {
            width: 100%;
            max-width: 100%;
            padding: 12px 15px;
            border: 1px solid #E5E5E5;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 12px;
            font-family: inherit;
            background: white;
            color: #1C1C1E;
            -webkit-appearance: none;
            box-sizing: border-box;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B6B6B' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .points-info {
            background: #FAFAFA;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #1C1C1E;
            font-weight: 600;
            border: 1px solid #E5E5E5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6B6B6B;
        }

        .loading-spinner {
            border: 3px solid #E5E5E5;
            border-top: 3px solid #1C1C1E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version {
            text-align: center;
            color: #B0B0B0;
            font-size: 12px;
            margin-top: 20px;
        }

        .badge-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #FFFFFF;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E5E5;
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .badge-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .badge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .badge-modal-overlay.show {
            display: block;
        }

        .badge-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .badge-title {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 10px;
        }

        .badge-desc {
            color: #6B6B6B;
            margin-bottom: 20px;
        }

        .badges-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2999;
            padding: 20px;
        }

        .badges-modal-overlay.show {
            display: flex;
        }

        .badges-modal {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 3000;
        }

        .badges-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F0F0F0;
        }

        .badges-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
        }

        .badges-modal-header h3 {
            font-size: 20px;
            color: #1C1C1E;
            font-weight: 600;
            margin: 0;
        }

        .badges-progress {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 600;
        }

        .badges-modal-header span {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 600;
        }

        .badges-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .badge-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #FAFAFA;
            border-radius: 12px;
            border: 2px solid #F0F0F0;
        }

        .badge-list-item.earned {
            background: linear-gradient(135deg, #1C1C1E 0%, #3A3A3A 100%);
            border-color: #1C1C1E;
        }

        .badge-list-item.locked {
            opacity: 0.5;
        }

        .badge-list-icon {
            font-size: 28px;
            line-height: 1;
            flex-shrink: 0;
        }

        .badge-list-info {
            flex: 1;
        }

        .badge-list-name {
            font-size: 15px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 3px;
        }

        .badge-list-item.earned .badge-list-name {
            color: white;
        }

        .badge-list-desc {
            font-size: 12px;
            color: #6B6B6B;
        }

        .badge-list-item.earned .badge-list-desc {
            color: rgba(255,255,255,0.8);
        }

        .badge-list-status {
            font-size: 18px;
            flex-shrink: 0;
        }

        .close-modal-btn {
            width: 100%;
            padding: 12px;
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            margin-top: 15px;
            cursor: pointer;
        }

        /* Legacy badge-item kept for badge modal compatibility */
        .badge-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #F5F5F5;
            border-radius: 12px;
            border: 1px solid #E5E5E5;
        }

        .badge-item.earned {
            background: #1C1C1E;
            border-color: #1C1C1E;
        }

        .badge-item.locked {
            opacity: 0.5;
            background: #F5F5F5;
        }

        .badge-item-icon {
            font-size: 32px;
            line-height: 1;
        }

        .badge-item-info {
            flex: 1;
        }

        .badge-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 3px;
        }

        .badge-item.earned .badge-item-name {
            color: #FFFFFF;
        }

        .badge-item-desc {
            font-size: 13px;
            color: #6B6B6B;
        }

        .badge-item.earned .badge-item-desc {
            color: rgba(255,255,255,0.8);
        }

        .badge-item-status {
            font-size: 20px;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FAFAFA;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #E5E5E5;
            box-shadow: none;
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #6B6B6B;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            margin-bottom: 12px;
        }

        .social-btn:hover {
            opacity: 0.85;
        }

        .social-btn:active {
            opacity: 0.75;
        }

        .social-btn-google {
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
        }

        .social-btn-google svg {
            width: 20px;
            height: 20px;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #EAEAEA;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            color: #6B6B6B;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            color: #1C1C1E;
        }

        .user-profile {
            display: none;
        }

        .user-avatar {
            display: none;
        }

        .user-avatar-placeholder {
            display: none;
        }

        .user-provider-badge {
            display: none;
        }


        /* Space Bingo Styles */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #F5F5F5;
            border: 1px solid #E5E5E5;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            position: relative;
        }

        .bingo-cell.completed {
            background: #1C1C1E;
            border-color: #1C1C1E;
            color: #FFFFFF;
        }

        .bingo-cell .cell-emoji {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .bingo-cell .cell-name {
            font-size: 11px;
            font-weight: 600;
            color: #6B6B6B;
            text-align: center;
        }

        .bingo-cell.completed .cell-name {
            color: #FFFFFF;
        }

        .bingo-cell .cell-count {
            font-size: 10px;
            color: #B0B0B0;
            margin-top: 2px;
        }

        .bingo-cell.completed .cell-count {
            color: rgba(255, 255, 255, 0.8);
        }

        .bingo-cell .cell-progress {
            width: 80%;
            height: 4px;
            background: #E5E5E5;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .bingo-cell.completed .cell-progress {
            background: rgba(255, 255, 255, 0.3);
        }

        .bingo-cell .cell-progress-bar {
            height: 100%;
            background: #1C1C1E;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .bingo-cell.completed .cell-progress-bar {
            background: #FFFFFF;
        }

        .bingo-lines-info {
            background: #FAFAFA;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #E5E5E5;
        }

        .bingo-lines-info .line-count {
            font-size: 24px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .bingo-lines-info .line-label {
            font-size: 13px;
            color: #B0B0B0;
            margin-top: 4px;
        }

        .bingo-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bingo-stat {
            background: #1C1C1E;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
        }

        .bingo-stat .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .bingo-stat .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .bingo-reset-btn {
            width: 100%;
            padding: 14px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: none;
            transition: opacity 0.2s;
        }

        .bingo-reset-btn:hover {
            opacity: 0.85;
        }

        .space-hint {
            font-size: 13px;
            color: #1C1C1E;
            font-weight: 600;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #FAFAFA;
            border-radius: 8px;
            border: 1px solid #E5E5E5;
            display: none;
        }

        /* Achievement Animation */
        .achievement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .achievement-overlay.show {
            display: flex;
        }

        .achievement-badge {
            font-size: 120px;
            animation: spinBadge 2s ease-in-out infinite;
        }

        @keyframes spinBadge {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .achievement-title {
            color: #FFFFFF;
            font-size: 28px;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        .achievement-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            margin-top: 10px;
            text-align: center;
        }

        .achievement-points {
            color: #FFFFFF;
            font-size: 36px;
            font-weight: 700;
            margin-top: 15px;
        }

        .achievement-dismiss {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 30px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 3001;
            pointer-events: none;
            animation: confettiFall 3s ease-in-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .nickname-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .nickname-modal.show {
            display: flex;
        }

        .nickname-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .nickname-card h2 {
            font-size: 28px;
            color: #1C1C1E;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .nickname-card p {
            color: #6B6B6B;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .nickname-card input {
            width: 100%;
            padding: 15px;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            box-sizing: border-box;
            color: #1C1C1E;
        }

        .nickname-card input:focus {
            outline: none;
            border-color: #1C1C1E;
        }

        .nickname-btn {
            width: 100%;
            padding: 15px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .nickname-btn:active {
            opacity: 0.75;
        }

        .privacy-note {
            font-size: 12px;
            color: #6B6B6B !important;
            margin-top: 15px;
            margin-bottom: 0 !important;
        }

        /* Calendar Container */
        .calendar-container {
            padding: 0;
        }

        /* Calendar Header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 5px;
        }

        .calendar-month {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin: 0;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #1C1C1E;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn:hover {
            background: #FAFAFA;
            border-color: #1C1C1E;
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .share-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Calendar Stats */
        .calendar-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: #FAFAFA;
            border-radius: 12px;
            padding: 15px;
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: #6B6B6B;
            margin-bottom: 5px;
        }

        .stat-item .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: #1C1C1E;
        }

        /* Day Labels */
        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .day-label {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #6B6B6B;
            padding: 8px 0;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 25px;
        }

        /* Calendar Day Cell */
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #FFFFFF;
            border: 1px solid #F0F0F0;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            border-color: #E5E5E5;
            background: #FAFAFA;
        }

        /* Day Number */
        .day-number {
            font-size: 14px;
            font-weight: 500;
            color: #1C1C1E;
            margin-bottom: 2px;
        }

        /* Day Icon */
        .day-icon {
            font-size: 16px;
            line-height: 1;
        }

        /* Day States */
        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.other-month:hover {
            background: #FFFFFF;
            border-color: #F0F0F0;
        }

        .calendar-day.today {
            border: 2px solid #1C1C1E;
            background: #FAFAFA;
        }

        .calendar-day.active {
            background: #1C1C1E;
            border-color: #1C1C1E;
        }

        .calendar-day.active .day-number {
            color: #FFFFFF;
        }

        .calendar-day.active .day-icon {
            filter: brightness(0) invert(1);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            pointer-events: none;
        }

        /* Month Summary */
        .month-summary {
            background: #FAFAFA;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }

        .summary-title {
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .summary-number {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 2px;
        }

        .summary-label {
            font-size: 11px;
            color: #6B6B6B;
        }

        /* CRITICAL - Mobile Responsive */
        @media (max-width: 414px) {
            .profile-header {
                padding: 12px 15px 15px;
            }

            .main-content {
                padding: 15px;
                padding-bottom: 80px;
            }

            .add-card {
                padding: 15px;
            }

            .card {
                padding: 15px;
            }
        }

        @media (max-height: 700px) {
            .profile-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .profile-stats .stat-value {
                font-size: 20px;
            }

            .upload-area {
                padding: 25px 20px;
            }
        }

        @media (max-width: 380px) {
            .calendar-month {
                font-size: 20px;
            }

            .day-number {
                font-size: 13px;
            }

            .day-icon {
                font-size: 14px;
            }

            .summary-number {
                font-size: 20px;
            }

            .profile-name {
                font-size: 16px;
            }

            .nav-icon {
                font-size: 20px;
            }

            .nav-label {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üóìÔ∏è</div>
            <div class="login-title">Declutter Daily</div>
            <div class="login-subtitle">One item at a time</div>

            <button class="social-btn social-btn-google" id="googleLoginBtn" onclick="handleGoogleLogin()">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Nickname Setup Modal -->
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-card">
            <h2>Welcome</h2>
            <p>Choose your display name</p>
            <input type="text"
                   id="nicknameSetup"
                   placeholder="Enter nickname (2-15 chars)"
                   maxlength="15">
            <button class="nickname-btn" onclick="saveNickname()">
                Start Decluttering!
            </button>
            <p class="privacy-note">
                Your real name stays private
            </p>
        </div>
    </div>

    <div class="container" id="mainApp">
        <!-- Compact Profile Header -->
        <div class="profile-header">
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
            <div class="online-badge">‚óè Online</div>

            <div class="profile-content">
                <div class="profile-avatar" id="profileAvatar">YK</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">User</div>
                    <span class="profile-provider" id="profileProvider">Google</span>
                </div>
            </div>

            <div class="profile-stats">
                <div class="stat">
                    <div class="stat-value" id="headerScore">0</div>
                    <div class="stat-label">POINTS</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="headerStreak">0</div>
                    <div class="stat-label">STREAK</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="headerItems">0</div>
                    <div class="stat-label">ITEMS</div>
                </div>
            </div>

            <div class="badges-display" id="badgesDisplay">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Hidden elements for backward compat -->
        <div id="totalScore" style="display:none;">0</div>
        <div id="streakBadge" style="display:none;">0 Day Streak</div>
        <div id="badgeCount" style="display:none;">0</div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <div id="addTab" class="tab-content active">
                <div class="add-card">
                    <h2 class="add-title">What are you letting go?</h2>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <img id="previewImage" class="preview-image" alt="Preview">
                        <div id="uploadPrompt">
                            <div class="upload-icon">üì∏</div>
                            <div class="upload-text">Add photo</div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*">

                    <input type="text" id="itemName" placeholder="Item (e.g., Old clothes)">

                    <select class="category-select" id="itemCategory" required>
                        <option value="">Select Category</option>
                        <option value="clothing">üëï Clothing (10)</option>
                        <option value="books">üìñ Books (15)</option>
                        <option value="electronics">üì± Electronics (20)</option>
                        <option value="furniture">ü™ë Furniture (30)</option>
                        <option value="kitchenware">üçΩÔ∏è Kitchenware (10)</option>
                        <option value="shoes">üëü Shoes (10)</option>
                        <option value="food">ü•´ Food (5)</option>
                        <option value="other">üì¶ Other (5)</option>
                    </select>

                    <select class="category-select" id="itemSpace">
                        <option value="">Space (Required)</option>
                        <option value="kitchen_space">üç≥ Kitchen</option>
                        <option value="bathroom">üöø Bathroom</option>
                        <option value="bedroom">üõèÔ∏è Bedroom</option>
                        <option value="living">üõãÔ∏è Living Room</option>
                        <option value="kids_room">üßí Kids Room</option>
                        <option value="closet">üëî Closet</option>
                        <option value="office">üíª Office</option>
                        <option value="garage">üîß Garage</option>
                        <option value="pantry">ü•´ Pantry</option>
                    </select>
                    <div class="space-hint" id="spaceHint"></div>

                    <div class="points-info" id="pointsInfo" style="display: none;">
                        Expected Points: <span id="expectedPoints">0</span> pts
                    </div>

                    <textarea id="itemNote" placeholder="Notes (optional)"></textarea>

                    <button class="submit-btn" id="submitBtn" onclick="addItem()">Done!</button>
                </div>
            </div>

        <div id="bingoTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #1C1C1E; font-weight: 600;">Space Bingo</h2>
                <p style="color: #6B6B6B; margin-bottom: 15px; text-align: center; font-size: 14px;">Declutter 10 items per space for bingo! Complete lines for bonus!</p>

                <div class="bingo-stats">
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoCompleted">0</div>
                        <div class="stat-label">Spaces Done</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoLines">0</div>
                        <div class="stat-label">Bingo Lines</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoPoints">0</div>
                        <div class="stat-label">Bingo Points</div>
                    </div>
                </div>

                <div class="bingo-grid" id="bingoGrid"></div>

                <div class="bingo-lines-info" id="bingoLinesInfo">
                    <div class="line-count" id="bingoLineCount">0 / 8 Lines</div>
                    <div class="line-label">3 Horizontal + 3 Vertical + 2 Diagonal</div>
                </div>

                <button class="bingo-reset-btn" id="bingoResetBtn">New Round</button>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #1C1C1E; font-weight: 600;">Community Feed</h2>
                <div class="item-list" id="itemList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="calendarTab">
            <div class="calendar-container">
                <!-- Header with Month/Year and Share -->
                <div class="calendar-header">
                    <h2 class="calendar-month" id="calendarMonth">February 2026</h2>
                    <button class="share-btn" onclick="shareProgress()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                            <polyline points="16 6 12 2 8 6"/>
                            <line x1="12" y1="2" x2="12" y2="15"/>
                        </svg>
                        Share
                    </button>
                </div>

                <!-- Streak Stats -->
                <div class="calendar-stats">
                    <div class="stat-item">
                        <div class="stat-label">Your Streak</div>
                        <div class="stat-value" id="calendarStreakValue">0 Days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="calendarMonthCount">0 Items</div>
                    </div>
                </div>

                <!-- Day Labels -->
                <div class="calendar-days-header">
                    <div class="day-label">M</div>
                    <div class="day-label">T</div>
                    <div class="day-label">W</div>
                    <div class="day-label">T</div>
                    <div class="day-label">F</div>
                    <div class="day-label">S</div>
                    <div class="day-label">S</div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Days will be dynamically generated -->
                </div>

                <!-- Month Summary -->
                <div class="month-summary">
                    <div class="summary-title">Monthly Summary</div>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="summary-number" id="monthItems">0</span>
                            <span class="summary-label">items</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-number" id="monthPoints">0</span>
                            <span class="summary-label">points</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-number" id="monthDays">0</span>
                            <span class="summary-label">active days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="leaderboardTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #1C1C1E; font-weight: 600;">Global Rankings</h2>
                <div id="leaderboardList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading rankings...
                    </div>
                </div>
            </div>
        </div>

        <div id="shareTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #1C1C1E; font-weight: 600;">Share Story</h2>
                <p style="color: #6B6B6B; margin-bottom: 20px; text-align: center;">Select a template and download to share on Instagram Stories!</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="generateStoryTemplate('minimal')" style="padding: 15px; background: #1C1C1E; color: #FFFFFF; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Minimal
                    </button>
                    <button onclick="generateStoryTemplate('stats')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Stats
                    </button>
                    <button onclick="generateStoryTemplate('streak')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Streak
                    </button>
                    <button onclick="generateStoryTemplate('grid')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Photo Grid
                    </button>
                </div>

                <canvas id="storyCanvas" style="width: 100%; max-width: 400px; margin: 0 auto; display: none; border-radius: 15px; border: 1px solid #E5E5E5;"></canvas>

                <div id="downloadSection" style="display: none; text-align: center; margin-top: 20px;">
                    <button onclick="downloadStoryImage()" style="width: 100%; padding: 18px; background: #1C1C1E; color: #FFFFFF; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;">
                        Download Image
                    </button>
                    <p style="color: #B0B0B0; font-size: 13px; margin-top: 10px;">Download and upload to Instagram Stories!</p>
                </div>
            </div>
        </div>

        </div><!-- end main-content -->

        <!-- Bottom Navigation - Fixed -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('add')" data-tab="add">
                <div class="nav-icon">üëã</div>
                <div class="nav-label">Let Go</div>
            </button>

            <button class="nav-item" onclick="switchTab('bingo')" data-tab="bingo">
                <div class="nav-icon">üé≤</div>
                <div class="nav-label">Bingo</div>
            </button>

            <button class="nav-item" onclick="switchTab('feed')" data-tab="feed">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">Feed</div>
            </button>

            <button class="nav-item" onclick="switchTab('calendar')" data-tab="calendar">
                <div class="nav-icon">üóìÔ∏è</div>
                <div class="nav-label">Calendar</div>
            </button>

            <button class="nav-item" onclick="switchTab('leaderboard')" data-tab="leaderboard">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-label">Ranks</div>
            </button>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal-overlay" id="badgeOverlay" onclick="closeBadgeModal()"></div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-icon" id="badgeModalIcon">üèÜ</div>
        <div class="badge-title" id="badgeModalTitle">New Badge Earned!</div>
        <div class="badge-desc" id="badgeModalDesc">First item decluttered!</div>
        <button class="btn" onclick="closeBadgeModal()">OK</button>
    </div>

    <!-- Badges Detail Modal -->
    <div class="badges-modal-overlay" id="badgesOverlay" onclick="closeBadgesModal()">
        <div class="badges-modal" onclick="event.stopPropagation()">
            <div class="badges-modal-header">
                <h3 class="badges-modal-title">Your Badges</h3>
                <span class="badges-progress" id="badgesProgress">0/7</span>
            </div>
            <div class="badges-list" id="badgesList">
                <!-- Dynamically filled -->
            </div>
            <button class="close-modal-btn" onclick="closeBadgesModal()">Close</button>
        </div>
    </div>

    <!-- Achievement Overlay -->
    <div class="achievement-overlay" id="achievementOverlay">
        <div class="achievement-badge" id="achievementBadge">üèÜ</div>
        <div class="achievement-title" id="achievementTitle">Space Complete!</div>
        <div class="achievement-subtitle" id="achievementSubtitle">Kitchen 10 items decluttered!</div>
        <div class="achievement-points" id="achievementPoints">+100 pts</div>
        <div class="achievement-dismiss">Tap to dismiss</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCgRc0r845aR7tTS7GNUmm8TMdLtSzeljY",
            authDomain: "declutter-challenge-94366.firebaseapp.com",
            projectId: "declutter-challenge-94366",
            storageBucket: "declutter-challenge-94366.firebasestorage.app",
            messagingSenderId: "781105372309",
            appId: "1:781105372309:web:4ce495d1dc8eac2b0d8f9c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        window.db = db;
        window.firestore = { collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment };

        let currentUserId = localStorage.getItem('userId') || null;
        let userName = localStorage.getItem('userName') || '';
        let totalScore = 0;
        let currentImage = null;
        let userStreak = 0;
        let userBadges = [];
        let bingoProgress = {};

        const bingoSpaces = [
            { key: 'kitchen_space', name: 'Kitchen', emoji: 'üç≥' },
            { key: 'bathroom', name: 'Bathroom', emoji: 'üöø' },
            { key: 'bedroom', name: 'Bedroom', emoji: 'üõèÔ∏è' },
            { key: 'living', name: 'Living Room', emoji: 'üõãÔ∏è' },
            { key: 'kids_room', name: 'Kids Room', emoji: 'üßí' },
            { key: 'closet', name: 'Closet', emoji: 'üëî' },
            { key: 'office', name: 'Office', emoji: 'üíª' },
            { key: 'garage', name: 'Garage', emoji: 'üîß' },
            { key: 'pantry', name: 'Pantry', emoji: 'ü•´' }
        ];

        const bingoLines = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        function getSpaceName(spaceKey) {
            const space = bingoSpaces.find(s => s.key === spaceKey);
            return space ? space.name : spaceKey;
        }

        function countBingoLines() {
            let count = 0;
            for (const line of bingoLines) {
                const allComplete = line.every(i => (bingoProgress[bingoSpaces[i].key] || 0) >= 10);
                if (allComplete) count++;
            }
            return count;
        }

        function countCompletedSpaces() {
            return bingoSpaces.filter(s => (bingoProgress[s.key] || 0) >= 10).length;
        }

        function renderBingoGrid() {
            const grid = document.getElementById('bingoGrid');
            if (!grid) return;

            const completedCount = countCompletedSpaces();
            const lineCount = countBingoLines();
            const bingoPointsEarned = completedCount * 100 + lineCount * 500 + (completedCount === 9 ? 3000 : 0);

            document.getElementById('bingoCompleted').textContent = completedCount;
            document.getElementById('bingoLines').textContent = lineCount;
            document.getElementById('bingoPoints').textContent = bingoPointsEarned;
            document.getElementById('bingoLineCount').textContent = `${lineCount} / 8 Lines`;

            const resetBtn = document.getElementById('bingoResetBtn');
            resetBtn.style.display = completedCount === 9 ? 'block' : 'none';

            grid.innerHTML = bingoSpaces.map(space => {
                const count = bingoProgress[space.key] || 0;
                const isComplete = count >= 10;
                const percent = Math.min(100, (count / 10) * 100);

                return `
                    <div class="bingo-cell ${isComplete ? 'completed' : ''}">
                        <div class="cell-emoji">${space.emoji}</div>
                        <div class="cell-name">${space.name}</div>
                        <div class="cell-count">${count} / 10</div>
                        <div class="cell-progress">
                            <div class="cell-progress-bar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSpaceHint() {
            const spaceSelect = document.getElementById('itemSpace');
            const hint = document.getElementById('spaceHint');
            const spaceKey = spaceSelect.value;

            if (spaceKey) {
                const count = bingoProgress[spaceKey] || 0;
                const space = bingoSpaces.find(s => s.key === spaceKey);
                if (count >= 10) {
                    hint.textContent = `${space.name}: Complete! Bingo achieved!`;
                } else {
                    const remaining = 10 - count;
                    hint.textContent = `${space.name}: ${count}/10 - ${remaining} more`;
                }
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }

        function showAchievement(title, subtitle, points) {
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementSubtitle').textContent = subtitle;
            document.getElementById('achievementPoints').textContent = `+${points} pts`;
            document.getElementById('achievementOverlay').classList.add('show');

            playVictorySound();
            spawnConfetti();
        }

        function hideAchievement() {
            document.getElementById('achievementOverlay').classList.remove('show');
        }

        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                const now = audioContext.currentTime;

                const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.12);
                    gain.gain.setValueAtTime(0.3, now + i * 0.12);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.12 + 0.2);
                    osc.start(now + i * 0.12);
                    osc.stop(now + i * 0.12 + 0.2);
                });
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        function spawnConfetti() {
            const colors = ['#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B'];
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 8 + 6) + 'px';
                confetti.style.height = (Math.random() * 8 + 6) + 'px';
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        async function loadBingoProgress() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    bingoProgress = userData.bingoProgress || {};
                } else {
                    bingoProgress = {};
                }
                renderBingoGrid();
                updateSpaceHint();
            } catch (error) {
                console.error('Bingo progress load failed:', error);
            }
        }

        async function updateBingoProgress(spaceKey) {
            const oldCount = bingoProgress[spaceKey] || 0;
            const oldLines = countBingoLines();
            const oldCompleted = countCompletedSpaces();

            bingoProgress[spaceKey] = oldCount + 1;
            const newCount = bingoProgress[spaceKey];

            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: bingoProgress
                    });
                }
            } catch (error) {
                console.error('Bingo progress update failed:', error);
            }

            if (newCount === 10) {
                const spaceName = getSpaceName(spaceKey);
                let bonusPoints = 100;
                totalScore += bonusPoints;

                await saveBonusPoints(bonusPoints);

                const newLines = countBingoLines();
                const linesEarned = newLines - oldLines;
                if (linesEarned > 0) {
                    const lineBonus = linesEarned * 500;
                    totalScore += lineBonus;
                    bonusPoints += lineBonus;
                    await saveBonusPoints(lineBonus);
                }

                const newCompleted = countCompletedSpaces();
                if (newCompleted === 9 && oldCompleted < 9) {
                    const allBonus = 3000;
                    totalScore += allBonus;
                    bonusPoints += allBonus;
                    await saveBonusPoints(allBonus);
                }

                document.getElementById('totalScore').textContent = totalScore;
                updateHeaderStats();

                setTimeout(() => {
                    if (newCompleted === 9 && oldCompleted < 9) {
                        showAchievement('Bingo All Clear!', 'All 9 spaces completed!', bonusPoints);
                    } else if (linesEarned > 0) {
                        showAchievement('Bingo!', `${spaceName} done + ${linesEarned} line bingo!`, bonusPoints);
                    } else {
                        showAchievement('Space Complete!', `${spaceName} 10 items decluttered!`, bonusPoints);
                    }
                }, 500);
            }

            renderBingoGrid();
            updateSpaceHint();
        }

        async function saveBonusPoints(points) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore
                    });
                }
            } catch (error) {
                console.error('Bonus points save failed:', error);
            }
        }

        async function resetBingo() {
            if (!confirm('Reset bingo? All progress will be cleared.')) return;

            bingoProgress = {};
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: {}
                    });
                }
            } catch (error) {
                console.error('Bingo reset failed:', error);
            }
            renderBingoGrid();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function hideLoginScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
        }

        function updateProfileUI() {
            const provider = localStorage.getItem('authProvider');

            // Update new profile header
            const profileName = document.getElementById('profileName');
            const profileProvider = document.getElementById('profileProvider');
            const profileAvatar = document.getElementById('profileAvatar');

            if (profileName) profileName.textContent = userName || 'User';
            if (profileProvider) profileProvider.textContent = provider === 'google' ? 'Google' : '';

            // Create avatar initials
            if (profileAvatar) {
                const initials = (userName || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                profileAvatar.textContent = initials;
            }
        }

        window.handleGoogleLogin = async function() {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                currentUserId = 'google_' + user.uid;

                // Store auth data
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('authProvider', 'google');
                localStorage.setItem('userPhoto', user.photoURL || '');

                // Check if nickname exists
                const savedNickname = localStorage.getItem('userNickname_' + currentUserId);

                if (savedNickname) {
                    // Existing user - use saved nickname
                    userName = savedNickname;
                    localStorage.setItem('userName', userName);
                    updateProfileUI();
                    hideLoginScreen();
                    await initApp();
                } else {
                    // New user - must set nickname
                    hideLoginScreen();
                    showNicknameModal();
                }
            } catch (error) {
                console.error('Google login failed:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    alert('Google login failed. Please check if Google login is enabled in Firebase Console.');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Sign in with Google`;
            }
        };

        function showNicknameModal() {
            document.getElementById('nicknameModal').classList.add('show');
            document.getElementById('nicknameSetup').focus();
        }

        function hideNicknameModal() {
            document.getElementById('nicknameModal').classList.remove('show');
        }

        window.saveNickname = async function() {
            const nickname = document.getElementById('nicknameSetup').value.trim();

            // Validation
            if (!nickname) {
                alert('Please enter a nickname!');
                return;
            }

            if (nickname.length < 2) {
                alert('Nickname must be at least 2 characters!');
                return;
            }

            if (nickname.length > 15) {
                alert('Nickname must be 15 characters or less!');
                return;
            }

            // Save nickname
            userName = nickname;
            localStorage.setItem('userNickname_' + currentUserId, nickname);
            localStorage.setItem('userName', nickname);

            // Update profile and start app
            updateProfileUI();
            hideNicknameModal();
            await updateUserProfile();
            await initApp();
        };

        window.handleLogout = async function() {
            if (!confirm('Are you sure you want to logout?')) return;
            const provider = localStorage.getItem('authProvider');

            try {
                if (provider === 'google') {
                    await signOut(auth);
                }
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('authProvider');
            localStorage.removeItem('userPhoto');
            currentUserId = null;
            userName = '';
            totalScore = 0;
            userStreak = 0;
            userBadges = [];
            showLoginScreen();
        };

        const categoryPoints = {
            'clothes': 10,
            'books': 15,
            'electronics': 20,
            'furniture': 30,
            'kitchen': 10,
            'shoes': 10,
            'food': 5,
            'toys': 5,
            'sports': 15,
            'digital': 5,
            'etc': 5
        };

        const badges = {
            'first_item': { icon: 'üéØ', name: 'First Step', desc: 'First item decluttered', condition: (count) => count >= 1 },
            'five_items': { icon: '‚≠ê', name: 'Passionate', desc: '5 items decluttered', condition: (count) => count >= 5 },
            'ten_items': { icon: 'üíé', name: 'Determined', desc: '10 items decluttered', condition: (count) => count >= 10 },
            'twenty_items': { icon: 'üëë', name: 'Declutter King', desc: '20 items decluttered', condition: (count) => count >= 20 },
            'streak_3': { icon: 'üî•', name: 'Consistent', desc: '3 day streak', condition: (streak) => streak >= 3, isStreak: true },
            'streak_7': { icon: 'üí™', name: 'Habit', desc: '7 day streak', condition: (streak) => streak >= 7, isStreak: true },
            'streak_30': { icon: 'üèÖ', name: 'Master', desc: '30 day streak', condition: (streak) => streak >= 30, isStreak: true }
        };

        // Username is now display-only in profile header (no editable input)

        async function updateUserProfile() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: 0,
                        itemCount: 0,
                        streak: 0,
                        lastDeclutterDate: null,
                        badges: [],
                        bingoProgress: {},
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Profile update failed:', error);
            }
        }

        async function generateAIEncouragement(itemName, category, points, totalScore, streak) {
            try {
                const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
                const itemsSnapshot = await getDocs(itemsQuery);
                
                const categoryCount = {};
                itemsSnapshot.forEach(doc => {
                    const data = doc.data();
                    categoryCount[data.category] = (categoryCount[data.category] || 0) + 1;
                });

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 150,
                        messages: [{
                            role: 'user',
                            content: `User decluttered "${itemName}" (${getCategoryName(category)}) in a minimalism challenge.

Current status:
- Points earned: ${points}
- Total points: ${totalScore}
- Streak: ${streak} days
- Category stats: ${JSON.stringify(categoryCount)}

Write a short, warm encouragement message in ONE sentence. Include 1-2 emojis.
Style: Friendly and encouraging tone, specific praise, occasional suggestions.
Example styles:
- "Furniture takes real commitment - amazing work! üëè"
- "You're really good at the ${getCategoryName(category)} category! Minimalist vibes üëç"
- "Streak day ${streak} achieved! Keep going! üî•"
Don't copy examples - be creative.`
                        }]
                    })
                });

                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.content[0].text.trim();
            } catch (error) {
                console.error('AI message generation failed:', error);
                const defaultMessages = [
                    "Great job! You're making progress step by step ‚ú®",
                    "Awesome! The decluttering habit is forming üí™",
                    "Amazing! Your space and mind are getting lighter üéà",
                    "Well done! You're becoming a minimalist master üåü",
                    "Excellent! You're enjoying the decluttering process üéØ"
                ];
                return defaultMessages[Math.floor(Math.random() * defaultMessages.length)];
            }
        }

        function getCategoryName(category) {
            const categories = {
                clothing: 'üëï Clothing',
                books: 'üìñ Books',
                electronics: 'üì± Electronics',
                furniture: 'ü™ë Furniture',
                kitchenware: 'üçΩÔ∏è Kitchenware',
                shoes: 'üëü Shoes',
                food: 'ü•´ Food',
                other: 'üì¶ Other'
            };
            return categories[category] || 'üì¶ Other';
        }

        async function calculateStreak() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const lastDate = userData.lastDeclutterDate?.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (lastDate) {
                        const lastDateOnly = new Date(lastDate);
                        lastDateOnly.setHours(0, 0, 0, 0);
                        
                        const diffTime = today - lastDateOnly;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            userStreak = userData.streak || 0;
                        } else if (diffDays === 1) {
                            userStreak = (userData.streak || 0) + 1;
                        } else {
                            userStreak = 1;
                        }
                    } else {
                        userStreak = 1;
                    }
                    
                    await updateDoc(doc(db, 'users', userSnapshot.docs[0].id), {
                        streak: userStreak,
                        lastDeclutterDate: serverTimestamp()
                    });
                    
                    const streakBadge = document.getElementById('streakBadge');
                    if (streakBadge) streakBadge.textContent = `${userStreak} Day Streak`;
                    updateHeaderStats();
                    checkBadges(null, userStreak);
                }
            } catch (error) {
                console.error('Streak calculation failed:', error);
            }
        }

        async function checkBadges(itemCount = null, streak = null) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    userBadges = userData.badges || [];
                    
                    const currentCount = itemCount !== null ? itemCount : userData.itemCount || 0;
                    const currentStreak = streak !== null ? streak : userData.streak || 0;
                    
                    for (const [key, badge] of Object.entries(badges)) {
                        if (!userBadges.includes(key)) {
                            const earned = badge.isStreak 
                                ? badge.condition(currentStreak)
                                : badge.condition(currentCount);
                                
                            if (earned) {
                                userBadges.push(key);
                                await updateDoc(doc(db, 'users', userDoc.id), {
                                    badges: arrayUnion(key)
                                });
                                showBadgeModal(badge);
                            }
                        }
                    }
                    
                    renderBadges();
                }
            } catch (error) {
                console.error('Badge check failed:', error);
            }
        }

        function renderBadges() {
            const earnedCount = userBadges.length;
            const totalCount = Object.keys(badges).length;

            // Update hidden compat elements
            const badgeCountEl = document.getElementById('badgeCount');
            if (badgeCountEl) badgeCountEl.textContent = earnedCount;

            // Update modal progress
            document.getElementById('badgesProgress').textContent = `${earnedCount}/${totalCount}`;

            // Render header badges (show first 3 earned)
            renderHeaderBadges();

            // Render modal badge list
            renderBadgesModal();
        }

        function renderHeaderBadges() {
            const badgesDisplay = document.getElementById('badgesDisplay');
            if (!badgesDisplay) return;
            const earnedBadges = userBadges.slice(0, 3);

            badgesDisplay.innerHTML = earnedBadges.map(badgeKey => {
                const badge = badges[badgeKey];
                if (!badge) return '';
                return `
                    <div class="header-badge-item">
                        <span class="badge-icon">${badge.icon}</span>
                        <span>${badge.name}</span>
                    </div>
                `;
            }).join('') + `
                <button class="view-all-badges" onclick="showBadgesModal()">View All ‚Üí</button>
            `;
        }

        function renderBadgesModal() {
            const badgesList = document.getElementById('badgesList');
            if (!badgesList) return;
            const earnedCount = userBadges.length;
            const totalCount = Object.keys(badges).length;

            document.getElementById('badgesProgress').textContent = `${earnedCount}/${totalCount}`;

            badgesList.innerHTML = Object.entries(badges).map(([key, badge]) => {
                const earned = userBadges.includes(key);
                return `
                    <div class="badge-list-item ${earned ? 'earned' : 'locked'}">
                        <div class="badge-list-icon">${badge.icon}</div>
                        <div class="badge-list-info">
                            <div class="badge-list-name">${badge.name}</div>
                            <div class="badge-list-desc">${badge.desc}</div>
                        </div>
                        <div class="badge-list-status">${earned ? '‚úÖ' : 'üîí'}</div>
                    </div>
                `;
            }).join('');
        }

        function showBadgesModal() {
            renderBadgesModal();
            document.getElementById('badgesOverlay').classList.add('show');
        }

        function closeBadgesModal() {
            document.getElementById('badgesOverlay').classList.remove('show');
        }

        // Keep backward compat alias
        function hideBadgesModal() {
            closeBadgesModal();
        }

        function updateHeaderStats() {
            const headerScore = document.getElementById('headerScore');
            const headerStreak = document.getElementById('headerStreak');
            const headerItems = document.getElementById('headerItems');
            if (headerScore) headerScore.textContent = totalScore;
            if (headerStreak) headerStreak.textContent = userStreak;
        }

        function showBadgeModal(badge) {
            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalTitle').textContent = `${badge.name} Badge Earned!`;
            document.getElementById('badgeModalDesc').textContent = badge.desc;
            document.getElementById('badgeModal').classList.add('show');
            document.getElementById('badgeOverlay').classList.add('show');
        }

        window.closeBadgeModal = function() {
            document.getElementById('badgeModal').classList.remove('show');
            document.getElementById('badgeOverlay').classList.remove('show');
        };

        window.showBadgesModal = showBadgesModal;
        window.closeBadgesModal = closeBadgesModal;

        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.type = 'square';
                osc1.frequency.setValueAtTime(523.25, now);
                gain1.gain.setValueAtTime(0.3, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(659.25, now + 0.15);
                gain2.gain.setValueAtTime(0.3, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
                
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.type = 'square';
                osc3.frequency.setValueAtTime(783.99, now + 0.3);
                gain3.gain.setValueAtTime(0.3, now + 0.3);
                gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                osc3.start(now + 0.3);
                osc3.stop(now + 0.45);
                
                const osc4 = audioContext.createOscillator();
                const gain4 = audioContext.createGain();
                osc4.connect(gain4);
                gain4.connect(audioContext.destination);
                osc4.type = 'square';
                osc4.frequency.setValueAtTime(1046.50, now + 0.45);
                gain4.gain.setValueAtTime(0.35, now + 0.45);
                gain4.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc4.start(now + 0.45);
                osc4.stop(now + 0.9);
                
                const osc5 = audioContext.createOscillator();
                const gain5 = audioContext.createGain();
                osc5.connect(gain5);
                gain5.connect(audioContext.destination);
                osc5.type = 'sine';
                osc5.frequency.setValueAtTime(1318.51, now + 0.45);
                gain5.gain.setValueAtTime(0.2, now + 0.45);
                gain5.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc5.start(now + 0.45);
                osc5.stop(now + 0.9);
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        // Trash sound effect - Windows recycle bin style (0.7s total)
        function playTrashSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Resume audio context if suspended (required for mobile)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;

                // PHASE 1: WHOOSH - Item falling into trash (0-0.3s)
                const whoosh = audioContext.createOscillator();
                const whooshGain = audioContext.createGain();

                whoosh.connect(whooshGain);
                whooshGain.connect(audioContext.destination);

                // Falling pitch sweep
                whoosh.frequency.setValueAtTime(1200, now);
                whoosh.frequency.exponentialRampToValueAtTime(150, now + 0.3);
                whoosh.type = 'sine';

                // Volume envelope - fade in and out
                whooshGain.gain.setValueAtTime(0, now);
                whooshGain.gain.linearRampToValueAtTime(0.35, now + 0.05);
                whooshGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                whoosh.start(now);
                whoosh.stop(now + 0.3);

                // PHASE 2: CRUMPLE - Paper/item crushing (0.25s-0.5s)
                const noise = audioContext.createBufferSource();
                const noiseDuration = 0.25;
                const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * noiseDuration, audioContext.sampleRate);
                const noiseData = noiseBuffer.getChannelData(0);

                // Generate white noise with slight modulation
                for (let i = 0; i < noiseBuffer.length; i++) {
                    noiseData[i] = (Math.random() * 2 - 1) * (1 - i / noiseBuffer.length * 0.5);
                }

                noise.buffer = noiseBuffer;

                const noiseGain = audioContext.createGain();
                const noiseFilter = audioContext.createBiquadFilter();

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(audioContext.destination);

                // Filter sweep - crushing sound
                noiseFilter.type = 'bandpass';
                noiseFilter.frequency.setValueAtTime(2000, now + 0.25);
                noiseFilter.frequency.exponentialRampToValueAtTime(300, now + 0.5);
                noiseFilter.Q.value = 2;

                // Volume envelope
                noiseGain.gain.setValueAtTime(0.25, now + 0.25);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

                noise.start(now + 0.25);
                noise.stop(now + 0.5);

                // PHASE 3: IMPACT - Hitting bottom of bin (0.45s-0.65s)
                const impact1 = audioContext.createOscillator();
                const impact1Gain = audioContext.createGain();

                impact1.connect(impact1Gain);
                impact1Gain.connect(audioContext.destination);

                // Low thud
                impact1.frequency.setValueAtTime(120, now + 0.45);
                impact1.frequency.exponentialRampToValueAtTime(60, now + 0.65);
                impact1.type = 'sine';

                impact1Gain.gain.setValueAtTime(0.5, now + 0.45);
                impact1Gain.gain.exponentialRampToValueAtTime(0.01, now + 0.65);

                impact1.start(now + 0.45);
                impact1.stop(now + 0.65);

                // PHASE 4: SECONDARY BOUNCE - Small bounce/settle (0.55s-0.7s)
                const impact2 = audioContext.createOscillator();
                const impact2Gain = audioContext.createGain();

                impact2.connect(impact2Gain);
                impact2Gain.connect(audioContext.destination);

                // Lighter secondary impact
                impact2.frequency.setValueAtTime(180, now + 0.55);
                impact2.frequency.exponentialRampToValueAtTime(80, now + 0.7);
                impact2.type = 'sine';

                impact2Gain.gain.setValueAtTime(0.3, now + 0.55);
                impact2Gain.gain.exponentialRampToValueAtTime(0.01, now + 0.7);

                impact2.start(now + 0.55);
                impact2.stop(now + 0.7);
            } catch (error) {
                console.error('Trash sound playback failed:', error);
            }
        }

        function compressImage(file, maxSizeKB = 500) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 800;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.7;
                        let compressed = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressed = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                currentImage = await compressImage(file, 500);
                
                const preview = document.getElementById('previewImage');
                const uploadArea = document.getElementById('uploadArea');
                const uploadPrompt = document.getElementById('uploadPrompt');
                
                preview.src = currentImage;
                preview.classList.add('show');
                uploadPrompt.style.display = 'none';
                uploadArea.classList.add('has-image');
            }
        });

        document.getElementById('itemCategory').addEventListener('change', function(e) {
            const pointsInfo = document.getElementById('pointsInfo');
            const expectedPoints = document.getElementById('expectedPoints');
            
            if (e.target.value) {
                expectedPoints.textContent = categoryPoints[e.target.value];
                pointsInfo.style.display = 'block';
            } else {
                pointsInfo.style.display = 'none';
            }
        });

        window.addItem = async function() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const space = document.getElementById('itemSpace').value;
            const note = document.getElementById('itemNote').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!name) {
                alert('Please enter item name!');
                return;
            }

            if (!category) {
                alert('Please select a category!');
                return;
            }

            if (!space) {
                alert('Please select a space!');
                return;
            }

            if (!currentImage) {
                alert('Please upload a photo!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            try {
                const points = categoryPoints[category];

                await addDoc(collection(db, 'items'), {
                    userId: currentUserId,
                    userName: userName,
                    name: name,
                    category: category,
                    space: space,
                    note: note,
                    image: currentImage,
                    points: points,
                    likes: [],
                    likeCount: 0,
                    comments: [],
                    createdAt: serverTimestamp()
                });

                totalScore += points;
                await updateUserScore();
                await calculateStreak();
                await updateBingoProgress(space);

                playTrashSound();
                playSuccessSound();

                const aiMessage = await generateAIEncouragement(name, category, points, totalScore, userStreak);

                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemSpace').value = '';
                document.getElementById('itemNote').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('previewImage').classList.remove('show');
                document.getElementById('uploadPrompt').style.display = 'block';
                document.getElementById('uploadArea').classList.remove('has-image');
                document.getElementById('pointsInfo').style.display = 'none';
                document.getElementById('spaceHint').style.display = 'none';
                currentImage = null;

                alert(`+${points} pts earned!\n\n${aiMessage}\n\nTotal: ${totalScore} pts`);

                switchTab('history');
            } catch (error) {
                console.error('Item add failed:', error);
                alert('Upload failed! Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Done!';
            }
        };

        async function updateUserScore() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newItemCount = (userData.itemCount || 0) + 1;
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore,
                        itemCount: newItemCount,
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(newItemCount);
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: totalScore,
                        itemCount: 1,
                        streak: 0,
                        badges: [],
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(1);
                }
                
                document.getElementById('totalScore').textContent = totalScore;
                    updateHeaderStats();
            } catch (error) {
                console.error('Score update failed:', error);
            }
        }

        window.toggleLike = async function(itemId, itemDocId) {
            try {
                const itemRef = doc(db, 'items', itemDocId);
                const itemDoc = await getDocs(query(collection(db, 'items'), where('__name__', '==', itemDocId)));
                
                if (!itemDoc.empty) {
                    const itemData = itemDoc.docs[0].data();
                    const likes = itemData.likes || [];
                    
                    if (likes.includes(currentUserId)) {
                        await updateDoc(itemRef, {
                            likes: arrayRemove(currentUserId),
                            likeCount: increment(-1)
                        });
                    } else {
                        await updateDoc(itemRef, {
                            likes: arrayUnion(currentUserId),
                            likeCount: increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error('Like failed:', error);
            }
        };

        window.toggleComments = function(itemId) {
            const commentsSection = document.getElementById(`comments-${itemId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('show');
            }
        };

        window.addComment = async function(itemId, itemDocId) {
            const input = document.getElementById(`comment-input-${itemId}`);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            try {
                const itemRef = doc(db, 'items', itemDocId);
                await updateDoc(itemRef, {
                    comments: arrayUnion({
                        userId: currentUserId,
                        userName: userName,
                        text: commentText,
                        createdAt: new Date().toISOString()
                    })
                });
                
                input.value = '';
            } catch (error) {
                console.error('Comment add failed:', error);
            }
        };

        window.deleteItem = async function(itemDocId, itemUserId, itemPoints) {
            if (itemUserId !== currentUserId) {
                alert('You can only delete your own items!');
                return;
            }

            if (!confirm('Are you sure you want to delete?')) {
                return;
            }

            try {
                const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await deleteDoc(doc(db, 'items', itemDocId));

                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newScore = Math.max(0, (userData.score || 0) - itemPoints);
                    const newItemCount = Math.max(0, (userData.itemCount || 0) - 1);
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: newScore,
                        itemCount: newItemCount
                    });

                    totalScore = newScore;
                    document.getElementById('totalScore').textContent = totalScore;
                    updateHeaderStats();
                }

                alert('Deleted!');
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Delete failed. Please try again.');
            }
        };

        async function loadMyItems() {
            const listElement = document.getElementById('itemList');
            
            try {
                const itemsQuery = query(collection(db, 'items'), limit(50));

                onSnapshot(itemsQuery, (snapshot) => {
                    const items = [];
                    let myScore = 0;
                    let myItemCount = 0;

                    snapshot.forEach((doc) => {
                        const item = doc.data();
                        items.push({
                            ...item,
                            id: doc.id,
                            docId: doc.id
                        });
                        if (item.userId === currentUserId) {
                            myScore += item.points || 0;
                            myItemCount++;
                        }
                    });

                    // Update header items count
                    const hdrItems = document.getElementById('headerItems');
                    if (hdrItems) hdrItems.textContent = myItemCount;

                    items.sort((a, b) => {
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });

                    totalScore = myScore;
                    document.getElementById('totalScore').textContent = totalScore;
                    updateHeaderStats();

                    if (items.length === 0) {
                        listElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üì¶</div>
                                <div>No items yet</div>
                                <div style="font-size: 14px; margin-top: 10px;">Declutter your first item!</div>
                            </div>
                        `;
                        return;
                    }

                    listElement.innerHTML = items.map(item => {
                        const date = item.createdAt?.toDate() || new Date();
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        const isMyItem = item.userId === currentUserId;
                        const isLiked = (item.likes || []).includes(currentUserId);
                        const likeCount = item.likeCount || 0;
                        const comments = item.comments || [];
                        const hasNote = item.note && item.note.trim();
                        
                        return `
                            <div class="item" style="${isMyItem ? 'background: #FAFAFA;' : ''}">
                                <div class="item-header">
                                    <img src="${item.image}" alt="${item.name}" class="item-image">
                                    <div class="item-info">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-date">${item.userName || 'Anonymous'} ‚Ä¢ ${dateStr}</div>
                                        ${hasNote ? `<div class="item-note">"${item.note}"</div>` : ''}
                                    </div>
                                    <div class="item-points">+${item.points}</div>
                                </div>
                                <div class="item-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${item.id}', '${item.docId}')">
                                        ‚ù§Ô∏è ${likeCount}
                                    </button>
                                    <button class="comment-btn" onclick="toggleComments('${item.id}')">
                                        üí¨ ${comments.length}
                                    </button>
                                    ${isMyItem ? `<button class="delete-btn" onclick="deleteItem('${item.docId}', '${item.userId}', ${item.points})">üóëÔ∏è Delete</button>` : ''}
                                </div>
                                <div class="comments-section" id="comments-${item.id}">
                                    ${comments.map(c => `
                                        <div class="comment">
                                            <div class="comment-author">${c.userName}</div>
                                            <div class="comment-text">${c.text}</div>
                                        </div>
                                    `).join('')}
                                    <div class="comment-input">
                                        <input type="text" id="comment-input-${item.id}" placeholder="Add comment...">
                                        <button onclick="addComment('${item.id}', '${item.docId}')">Post</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('Items load failed:', error);
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div>Data load failed</div>
                    </div>
                `;
            }
        }

        async function loadLeaderboard() {
            const leaderboardElement = document.getElementById('leaderboardList');
            
            try {
                const usersQuery = query(collection(db, 'users'), orderBy('score', 'desc'), limit(20));

                onSnapshot(usersQuery, (snapshot) => {
                    const users = [];
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        users.push(user);
                    });

                    if (users.length === 0) {
                        leaderboardElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üèÜ</div>
                                <div>No participants yet</div>
                            </div>
                        `;
                        return;
                    }

                    leaderboardElement.innerHTML = users.map((user, index) => {
                        const isCurrentUser = user.userId === currentUserId;
                        const rank = index + 1;
                        const rankClass = rank <= 3 ? 'top3' : '';
                        const userStreak = user.streak || 0;
                        
                        return `
                            <div class="leaderboard-item" style="${isCurrentUser ? 'background: #FAFAFA;' : ''}">
                                <div class="rank ${rankClass}">${rank}</div>
                                <div class="leaderboard-info">
                                    <div class="leaderboard-name">${user.name || 'Anonymous'}${isCurrentUser ? ' üë§' : ''}</div>
                                    <div class="leaderboard-items">${user.itemCount || 0} items ‚Ä¢ ${userStreak} day streak</div>
                                </div>
                                <div class="leaderboard-score">${user.score || 0}</div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('Leaderboard load failed:', error);
            }
        }

        window.switchTab = function(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(t => {
                t.classList.remove('active');
                t.style.display = 'none';
            });

            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Map tab names to tab element IDs
            const tabMap = {
                'add': 'addTab',
                'bingo': 'bingoTab',
                'feed': 'historyTab',
                'history': 'historyTab',
                'calendar': 'calendarTab',
                'leaderboard': 'leaderboardTab',
                'share': 'shareTab'
            };

            // Show selected tab
            const tabId = tabMap[tab] || (tab + 'Tab');
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }

            // Activate nav item (map 'history' to 'feed' for nav)
            const navTab = (tab === 'history') ? 'feed' : tab;
            const navItem = document.querySelector(`[data-tab="${navTab}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Update specific tab content if needed
            if (tab === 'add') updateSpaceHint();
            if (tab === 'bingo') loadBingoProgress();
            if (tab === 'feed' || tab === 'history') loadMyItems();
            if (tab === 'calendar') renderCalendar();
            if (tab === 'leaderboard') loadLeaderboard();
        };

        document.getElementById('itemSpace').addEventListener('change', updateSpaceHint);
        document.getElementById('achievementOverlay').addEventListener('click', hideAchievement);
        document.getElementById('bingoResetBtn').addEventListener('click', resetBingo);

        let currentCalendarYear = 2026;
        let currentCalendarMonth = 1;
        let userItemDates = {};

        async function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthEl = document.getElementById('calendarMonth');

            const year = currentCalendarYear;
            const month = currentCalendarMonth;

            // Set month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthEl.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            // Get day of week for first day (0 = Sunday, convert to Monday = 0)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6; // Sunday becomes 6

            // Fetch items from Firebase
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);

            userItemDates = {};

            itemsSnapshot.forEach(doc => {
                const item = doc.data();
                if (item.createdAt) {
                    const date = item.createdAt.toDate();
                    const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;

                    if (!userItemDates[dateKey]) {
                        userItemDates[dateKey] = {
                            count: 0,
                            points: 0
                        };
                    }
                    userItemDates[dateKey].count += 1;
                    userItemDates[dateKey].points += item.points || 0;
                }
            });

            grid.innerHTML = '';

            // Add empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }

            // Track monthly stats
            const now = new Date();
            const today = now.getDate();
            const isCurrentMonth = now.getMonth() === month && now.getFullYear() === year;
            let monthItemCount = 0;
            let monthPointCount = 0;
            let activeDaysCount = 0;

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';

                // Check if this day has activity
                const dateKey = `${year}-${month}-${day}`;
                const dayData = userItemDates[dateKey] || { count: 0, points: 0 };

                if (dayData.count > 0) {
                    dayCell.classList.add('active');
                    monthItemCount += dayData.count;
                    monthPointCount += dayData.points;
                    activeDaysCount++;
                }

                if (isCurrentMonth && day === today) {
                    dayCell.classList.add('today');
                }

                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Icon - trash can for active days
                if (dayData.count > 0) {
                    const icon = document.createElement('div');
                    icon.className = 'day-icon';
                    icon.textContent = 'üóëÔ∏è';
                    dayCell.appendChild(icon);
                }

                grid.appendChild(dayCell);
            }

            // Update stats
            document.getElementById('calendarStreakValue').textContent =
                userStreak > 0 ? `${userStreak} Day${userStreak !== 1 ? 's' : ''}` : '0 Days';
            document.getElementById('calendarMonthCount').textContent =
                `${monthItemCount} Item${monthItemCount !== 1 ? 's' : ''}`;

            // Update month summary
            document.getElementById('monthItems').textContent = monthItemCount;
            document.getElementById('monthPoints').textContent = monthPointCount;
            document.getElementById('monthDays').textContent = activeDaysCount;
        }

        window.changeMonth = function(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        };

        window.shareProgress = function() {
            const monthItemsEl = document.getElementById('monthItems');
            const monthPointsEl = document.getElementById('monthPoints');
            const monthItems = monthItemsEl ? monthItemsEl.textContent : '0';
            const monthPointsVal = monthPointsEl ? monthPointsEl.textContent : '0';
            const streak = userStreak;

            const text = `This month on Declutter Daily:\nüóëÔ∏è ${monthItems} items\n‚≠ê ${monthPointsVal} points\nüî• ${streak} day streak`;

            if (navigator.share) {
                navigator.share({
                    title: 'My Declutter Progress',
                    text: text,
                    url: window.location.href
                }).catch(() => {
                    navigator.clipboard.writeText(text);
                    alert('Progress copied to clipboard!');
                });
            } else {
                navigator.clipboard.writeText(text);
                alert('Progress copied to clipboard!');
            }
        };

        window.generateStoryTemplate = async function(template) {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            const userData = userSnapshot.empty ? {} : userSnapshot.docs[0].data();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            const userItems = [];
            itemsSnapshot.forEach(doc => userItems.push(doc.data()));
            
            if (template === 'minimal') {
                drawMinimalTemplate(ctx, userData, userItems);
            } else if (template === 'stats') {
                drawStatsTemplate(ctx, userData, userItems);
            } else if (template === 'streak') {
                drawStreakTemplate(ctx, userData);
            } else if (template === 'grid') {
                await drawGridTemplate(ctx, userData, userItems);
            }
            
            canvas.style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        };

        function drawMinimalTemplate(ctx, userData, items) {
            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 80px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Declutter Daily', 540, 300);

            ctx.font = 'bold 180px sans-serif';
            ctx.fillText(userData.score || 0, 540, 800);

            ctx.font = '60px sans-serif';
            ctx.fillText('POINTS', 540, 900);

            ctx.font = 'bold 50px sans-serif';
            ctx.fillText(`${items.length} items decluttered`, 540, 1100);

            ctx.font = '50px sans-serif';
            ctx.fillText(`${userData.streak || 0} day streak`, 540, 1200);

            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);

            ctx.font = '40px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText('Practicing Minimal Life', 540, 1700);
        }

        function drawStatsTemplate(ctx, userData, items) {
            ctx.fillStyle = '#FAFAFA';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 400);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('My Declutter Stats', 540, 250);
            
            const categoryCount = {};
            items.forEach(item => {
                categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
            });
            
            const categories = [
                { key: 'furniture', name: 'Furniture', emoji: 'üõãÔ∏è' },
                { key: 'electronics', name: 'Electronics', emoji: 'üì±' },
                { key: 'books', name: 'Books', emoji: 'üìö' },
                { key: 'clothes', name: 'Clothing', emoji: 'üëï' },
                { key: 'kitchen', name: 'Kitchenware', emoji: 'üç≥' },
                { key: 'shoes', name: 'Shoes', emoji: 'üëü' },
                { key: 'food', name: 'Food', emoji: 'üçî' },
                { key: 'toys', name: 'Toys', emoji: 'üß∏' },
                { key: 'sports', name: 'Sports Equipment', emoji: 'üèãÔ∏è' },
                { key: 'digital', name: 'Digital Photos/Docs', emoji: 'üìÑ' },
                { key: 'etc', name: 'Other', emoji: 'üì¶' }
            ];
            
            let y = 550;
            ctx.textAlign = 'left';
            categories.forEach(cat => {
                const count = categoryCount[cat.key] || 0;
                
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(0,0,0,0.05)';
                ctx.shadowBlur = 10;
                ctx.fillRect(80, y - 80, 920, 120);
                ctx.shadowBlur = 0;

                ctx.font = '60px sans-serif';
                ctx.fillText(cat.emoji, 120, y);

                ctx.fillStyle = '#1C1C1E';
                ctx.font = 'bold 50px sans-serif';
                ctx.fillText(cat.name, 220, y);

                ctx.fillStyle = '#1C1C1E';
                ctx.font = 'bold 60px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${count}`, 950, y);
                ctx.textAlign = 'left';
                
                y += 180;
            });
            
            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 55px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`Total ${items.length} items ‚Ä¢ ${userData.score || 0} pts`, 540, 1750);
        }

        function drawStreakTemplate(ctx, userData) {
            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 200px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(userData.streak || 0, 540, 800);

            ctx.font = 'bold 80px sans-serif';
            ctx.fillText('Day Streak', 540, 940);

            ctx.font = '50px sans-serif';
            const streak = userData.streak || 0;
            let message = 'Practicing daily!';
            if (streak >= 30) message = 'One month achieved!';
            else if (streak >= 7) message = 'One week achieved!';
            else if (streak >= 3) message = 'Building good habits!';

            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText(message, 540, 1200);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);
        }

        async function drawGridTemplate(ctx, userData, items) {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 350);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${items.length} items decluttered!`, 540, 220);
            
            const recentItems = items.slice(0, 6);
            const gridSize = 320;
            const gap = 30;
            const startX = 60;
            const startY = 400;
            
            for (let i = 0; i < 6; i++) {
                const row = Math.floor(i / 3);
                const col = i % 3;
                const x = startX + col * (gridSize + gap);
                const y = startY + row * (gridSize + gap);
                
                if (i < recentItems.length && recentItems[i].image) {
                    try {
                        const img = new Image();
                        img.src = recentItems[i].image;
                        await new Promise(resolve => {
                            img.onload = () => {
                                ctx.save();
                                ctx.beginPath();
                                ctx.roundRect(x, y, gridSize, gridSize, 20);
                                ctx.clip();
                                ctx.drawImage(img, x, y, gridSize, gridSize);
                                ctx.restore();
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) {
                        ctx.fillStyle = '#E5E5E5';
                        ctx.beginPath();
                        ctx.roundRect(x, y, gridSize, gridSize, 20);
                        ctx.fill();
                    }
                } else {
                    ctx.fillStyle = '#F5F5F5';
                    ctx.beginPath();
                    ctx.roundRect(x, y, gridSize, gridSize, 20);
                    ctx.fill();
                }
            }
            
            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${userData.score || 0} pts`, 270, 1650);
            ctx.fillText(`${userData.streak || 0} days`, 810, 1650);

            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1800);
        }

        window.downloadStoryImage = function() {
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = `declutter-story-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        async function initApp() {
            if (!currentUserId) return;
            updateProfileUI();
            await updateUserProfile();
            await loadMyItems();

            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            if (!userSnapshot.empty) {
                const userData = userSnapshot.docs[0].data();
                userStreak = userData.streak || 0;
                userBadges = userData.badges || [];
                bingoProgress = userData.bingoProgress || {};

                const streakBadge = document.getElementById('streakBadge');
                if (streakBadge) streakBadge.textContent = `${userStreak} Day Streak`;

                // Update header items count
                const headerItems = document.getElementById('headerItems');
                if (headerItems) headerItems.textContent = userData.itemCount || 0;

                updateHeaderStats();
                renderBadges();
                renderBingoGrid();
            }
        }

        (function checkAuthState() {
            const savedUserId = localStorage.getItem('userId');
            const savedProvider = localStorage.getItem('authProvider');

            if (savedUserId && savedProvider) {
                currentUserId = savedUserId;
                userName = localStorage.getItem('userName') || '';
                hideLoginScreen();
                initApp();
            } else {
                showLoginScreen();
            }
        })();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>

</html>


