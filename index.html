<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="비우기">
    <meta name="theme-color" content="#a8c4a0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Declutter Daily - Build your minimalist habit one item at a time. Track progress, earn badges, and join the community.">

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Declutter Daily - One Item at a Time</title>
    <style>
        /* CRITICAL - Mobile First Foundation */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            width: 100%;
            max-width: 100vw;
            overflow: hidden;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            background: #FAFAFA;
            width: 100%;
            max-width: 100vw;
            overflow: auto;
            height: 100%;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: none;
        }

        /* Container - Mobile First */
        .container {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Profile Header - Compact */
        .profile-header {
            background: white;
            padding: 6px 15px;
            border-bottom: 1px solid #F0F0F0;
            position: relative;
            flex-shrink: 0;
        }

        .profile-header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: env(safe-area-inset-top, 6px);
        }

        .settings-btn {
            background: none;
            border: none;
            color: #6B6B6B;
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: auto;
        }

        .settings-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 200;
        }

        .settings-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 24px 20px 40px;
            z-index: 201;
            transition: transform 0.3s ease;
        }

        .settings-sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-sheet-header h3 {
            font-size: 17px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .settings-close-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #6B6B6B;
            cursor: pointer;
            padding: 4px 8px;
        }

        .settings-section-label {
            font-size: 11px;
            font-weight: 700;
            color: #6B6B6B;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .settings-name-input {
            width: 100%;
            background: #F5F5F5;
            border: 1.5px solid #E0E0E0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .settings-name-input:focus {
            border-color: #1C1C1E;
        }

        .settings-save-btn {
            display: none;
            margin-top: 10px;
            background: #1C1C1E;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        .settings-save-btn:active {
            opacity: 0.8;
        }

        .settings-divider {
            border: none;
            border-top: 1px solid #F0F0F0;
            margin: 16px 0;
        }

        .settings-logout-btn {
            background: none;
            border: none;
            color: #E53E3E;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 0;
            font-family: inherit;
        }


        .profile-avatar-wrapper {
            position: relative;
            width: 30px;
            height: 30px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .profile-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1C1C1E 0%, #4A4A4A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .profile-avatar-camera {
            display: none;
        }

        .profile-avatar-camera svg {
            width: 12px;
            height: 12px;
            fill: #555;
        }

        /* Profile Photo Bottom Sheet */
        .photo-sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 300;
        }

        .photo-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-radius: 22px 22px 0 0;
            padding: 16px 20px 40px;
            z-index: 301;
            transition: transform 0.3s ease;
        }

        .photo-sheet-grab {
            width: 36px;
            height: 4px;
            background: #D1D1D6;
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .photo-sheet-title {
            font-size: 16px;
            font-weight: 800;
            color: #1C1C1E;
            text-align: center;
            margin-bottom: 20px;
        }

        .photo-sheet-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background-size: cover;
            background-position: center;
            display: none;
        }

        .photo-sheet-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .photo-sheet-btn.primary {
            background: #1C1C1E;
            color: white;
        }

        .photo-sheet-btn.primary:active {
            opacity: 0.8;
        }

        .photo-sheet-btn.danger {
            background: white;
            color: #E53E3E;
            border: 1px solid #F0F0F0;
        }

        .photo-sheet-btn.danger:active {
            background: #FFF5F5;
        }

        .photo-sheet-btn.cancel {
            background: #F5F5F5;
            color: #6B6B6B;
        }

        .photo-sheet-btn.cancel:active {
            background: #EBEBEB;
        }

        .photo-sheet-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Feed/Comment User Avatars */
        .feed-user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1C1C1E 0%, #4A4A4A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .comment-user-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1C1C1E 0%, #4A4A4A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .comment-with-avatar {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .comment-with-avatar .comment-body {
            flex: 1;
            min-width: 0;
        }

        .ranking-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1C1C1E 0%, #4A4A4A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .item-header-with-avatar {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .profile-header-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .profile-provider {
            display: none;
        }

        .profile-header-stat {
            font-size: 13px;
            font-weight: 600;
            color: #6B6B6B;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .profile-header-stat .stat-val {
            color: #1C1C1E;
            font-weight: 700;
        }

        .profile-stats {
            display: none;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .stat-label {
            font-size: 10px;
            color: #6B6B6B;
            margin-top: 2px;
        }

        /* Badge Drawer - slides down from header on avatar tap */
        .badges-drawer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 0;
        }

        .badges-drawer.open {
            max-height: 60px;
            padding: 6px 0 2px;
        }

        /* Badge Display - Emoji icons only */
        .badges-display {
            display: flex !important;
            gap: 6px !important;
            flex-wrap: wrap !important;
            align-items: center !important;
            margin: 0 !important;
        }

        .badges-display .badge-item {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: none !important;
            padding: 0 !important;
            cursor: pointer !important;
        }

        .badges-display .badge-icon {
            font-size: 20px !important;
            line-height: 1 !important;
            width: auto !important;
            height: auto !important;
        }

        .badges-display .view-all-badges {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: none !important;
            color: #6B6B6B !important;
            border: none !important;
            padding: 0 !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
        }

        /* Main Content - Scrollable */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 64px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }

        /* Hide old UI elements */
        .header, .tabs, .old-badge-container {
            display: none !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Add Item Card */
        .add-card {
            background: white;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid #F0F0F0;
            width: 100%;
            max-width: 100%;
        }

        .add-title {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 6px;
        }

        .card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #E5E5E5;
            box-shadow: none;
        }

        /* Upload Area */
        .upload-area {
            background: #FAFAFA;
            border: 2px dashed #E5E5E5;
            border-radius: 14px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            position: relative;
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            overflow: hidden;
        }

        .upload-area.has-image {
            padding: 0;
            border-style: solid;
        }

        .upload-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        .upload-icon-svg {
            display: inline-block;
            margin-bottom: 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        /* Photo Row Container */
        .photo-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .photo-row .upload-area {
            flex: 1;
        }

        .photo-row.ba-active .upload-area {
            flex: none;
            width: 80px;
            height: 80px;
        }

        .photo-row.ba-active .ba-photo-slot {
            display: flex !important;
        }

        .upload-area:hover .upload-icon-svg {
            opacity: 1;
        }

        .upload-icon-svg svg {
            display: block;
        }

        .upload-text {
            font-size: 13px;
            color: #6B6B6B;
        }

        input[type="file"] {
            display: none;
        }

        /* Form Inputs - Mobile Optimized */
        input[type="text"], select, textarea {
            width: 100%;
            max-width: 100%;
            padding: 12px 14px;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 8px;
            background: white;
            color: #1C1C1E;
            -webkit-appearance: none;
            box-sizing: border-box;
            font-family: inherit;
        }

        input::placeholder, textarea::placeholder {
            color: #B0B0B0;
        }

        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1C1C1E;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B6B6B' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        textarea {
            resize: none;
            min-height: 44px;
            font-size: 13px;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 16px;
        }

        .submit-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn:active {
            opacity: 0.75;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Bottom Navigation - ALWAYS Fixed */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #F0F0F0;
            padding: 6px 0;
            padding-bottom: max(6px, env(safe-area-inset-bottom));
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 4px 0;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-icon {
            font-size: 20px;
            line-height: 1;
        }

        .nav-label {
            font-size: 10px;
            color: #6B6B6B;
            font-weight: 500;
        }

        .nav-item.active .nav-label {
            color: #1C1C1E;
            font-weight: 600;
        }

        .item-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 5px;
        }

        .item-date {
            font-size: 12px;
            color: #6B6B6B;
        }

        .item-note {
            font-size: 13px;
            color: #6B6B6B;
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: #FAFAFA;
            border-radius: 8px;
            border-left: 2px solid #1C1C1E;
        }

        .item-points {
            font-weight: 700;
            color: #1C1C1E;
            font-size: 18px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .like-btn {
            background: #EAEAEA;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #1C1C1E;
            transition: all 0.2s;
        }

        .like-btn:hover {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .like-btn.liked {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .comment-btn {
            background: #EAEAEA;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #1C1C1E;
            transition: all 0.2s;
        }

        .comment-btn:hover {
            background: #1C1C1E;
            color: #FFFFFF;
        }

        .delete-btn {
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #6B6B6B;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #FAFAFA;
            border-color: #DC3545;
            color: #DC3545;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment {
            padding: 10px;
            background: #FAFAFA;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            color: #1C1C1E;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #6B6B6B;
            font-size: 14px;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #E5E5E5;
            border-radius: 10px;
            font-size: 14px;
            color: #1C1C1E;
        }

        .comment-input button {
            padding: 10px 20px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Tidy AI Coach Comment Styles */
        .comment.tidy-comment {
            background: #F0FAF0;
            border: 1px solid rgba(76, 175, 80, 0.15);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .tidy-comment-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }

        .tidy-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .tidy-name {
            font-size: 11px;
            font-weight: 700;
            color: #4CAF50;
        }

        .tidy-badge {
            font-size: 8px;
            font-weight: 700;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
            letter-spacing: 0.3px;
        }

        .tidy-comment-time {
            font-size: 10px;
            color: #ccc;
            margin-left: auto;
        }

        .tidy-comment-text {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
            margin-left: 32px;
        }

        .ranking-card {
            background: #fff;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        }

        .ranking-card-title {
            font-size: 16px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 14px;
        }

        .ranking-row {
            margin-bottom: 8px;
        }

        .ranking-row:last-child {
            margin-bottom: 0;
        }

        .ranking-row-top {
            display: flex;
            align-items: center;
        }

        .ranking-rank {
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-right: 6px;
        }

        .ranking-rank-medal {
            font-size: 14px;
            line-height: 1;
        }

        .ranking-rank-num {
            font-size: 11px;
            font-weight: 700;
            color: #ccc;
        }

        .ranking-name {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-name.top3 {
            font-size: 12px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .ranking-name.regular {
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }

        .ranking-you-badge {
            display: inline-block;
            font-size: 8px;
            color: #fff;
            background: #1a1a1a;
            border-radius: 4px;
            padding: 1px 4px;
            margin-left: 4px;
            vertical-align: middle;
            line-height: 1.4;
        }

        .ranking-streak {
            margin-left: 3px;
            font-size: 11px;
        }

        .ranking-points {
            flex-shrink: 0;
            margin-left: 8px;
        }

        .ranking-points.top3 {
            font-size: 13px;
            font-weight: 800;
            color: #1a1a1a;
        }

        .ranking-points.regular {
            font-size: 11px;
            font-weight: 800;
            color: #999;
        }

        .ranking-bar-wrapper {
            margin-left: 26px;
            margin-top: 3px;
            border-radius: 3px;
            background: #f5f5f5;
        }

        .ranking-bar-wrapper.top3 {
            height: 6px;
        }

        .ranking-bar-wrapper.regular {
            height: 4px;
        }

        .ranking-bar {
            height: 100%;
            border-radius: 3px;
            min-width: 0;
        }

        .ranking-bar.rank-1 {
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }

        .ranking-bar.rank-2 {
            background: linear-gradient(90deg, #C0C0C0, #b0b0b0);
        }

        .ranking-bar.rank-3 {
            background: linear-gradient(90deg, #CD7F32, #b8763a);
        }

        .ranking-bar.current-user {
            background: #4CAF50;
        }

        .ranking-bar.others {
            background: #e0e0e0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6B6B6B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .category-select {
            width: 100%;
            max-width: 100%;
            padding: 12px 10px;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 0;
            font-family: inherit;
            background: white;
            color: #1C1C1E;
            -webkit-appearance: none;
            box-sizing: border-box;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B6B6B' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        /* Category + Space Side-by-Side Row */
        .category-space-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .category-space-row .category-select {
            flex: 1;
            min-width: 0;
        }

        .points-info {
            background: #FAFAFA;
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 0;
            margin-top: 8px;
            text-align: center;
            color: #1C1C1E;
            font-weight: 600;
            font-size: 12px;
            border: 1px solid #E5E5E5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6B6B6B;
        }

        .loading-spinner {
            border: 3px solid #E5E5E5;
            border-top: 3px solid #1C1C1E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version {
            text-align: center;
            color: #B0B0B0;
            font-size: 12px;
            margin-top: 20px;
        }

        .badge-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #FFFFFF;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E5E5;
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .badge-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .badge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .badge-modal-overlay.show {
            display: block;
        }

        .badge-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .badge-title {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 10px;
        }

        .badge-desc {
            color: #6B6B6B;
            margin-bottom: 20px;
        }

        .badges-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2999;
            padding: 20px;
        }

        .badges-modal-overlay.show {
            display: flex;
        }

        .badges-modal {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 3000;
        }

        .badges-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F0F0F0;
        }

        .badges-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
        }

        .badges-modal-header h3 {
            font-size: 20px;
            color: #1C1C1E;
            font-weight: 600;
            margin: 0;
        }

        .badges-progress {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 600;
        }

        .badges-modal-header span {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 600;
        }

        .badges-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .badge-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #FAFAFA;
            border-radius: 12px;
            border: 2px solid #F0F0F0;
        }

        .badge-list-item.earned {
            background: linear-gradient(135deg, #1C1C1E 0%, #3A3A3A 100%);
            border-color: #1C1C1E;
        }

        .badge-list-item.locked {
            opacity: 0.5;
        }

        .badge-list-icon {
            font-size: 28px;
            line-height: 1;
            flex-shrink: 0;
        }

        .badge-list-info {
            flex: 1;
        }

        .badge-list-name {
            font-size: 15px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 3px;
        }

        .badge-list-item.earned .badge-list-name {
            color: white;
        }

        .badge-list-desc {
            font-size: 12px;
            color: #6B6B6B;
        }

        .badge-list-item.earned .badge-list-desc {
            color: rgba(255,255,255,0.8);
        }

        .badge-list-status {
            font-size: 18px;
            flex-shrink: 0;
        }

        .close-modal-btn {
            width: 100%;
            padding: 12px;
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            margin-top: 15px;
            cursor: pointer;
        }


        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FAFAFA;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #E5E5E5;
            box-shadow: none;
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #6B6B6B;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            margin-bottom: 12px;
        }

        .social-btn:hover {
            opacity: 0.85;
        }

        .social-btn:active {
            opacity: 0.75;
        }

        .social-btn-google {
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
        }

        .social-btn-google svg {
            width: 20px;
            height: 20px;
        }

        .user-profile {
            display: none;
        }

        .user-avatar {
            display: none;
        }

        .user-avatar-placeholder {
            display: none;
        }

        .user-provider-badge {
            display: none;
        }


        /* AI Coach Tidy Styles */
        .coach-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .coach-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .coach-usage-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #F0FAF0;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #2D8B2D;
        }

        .coach-usage-pill.low {
            background: #FFF0F0;
            color: #D32F2F;
        }

        .coach-usage-pill .usage-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #2D8B2D;
        }

        .coach-usage-pill.low .usage-dot {
            background: #D32F2F;
        }

        .coach-upload-area {
            border: 2px dashed #D0D0D0;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
            background: #FAFAFA;
            position: relative;
            overflow: hidden;
            min-height: 45vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .coach-upload-area:active {
            background: #F0F0F0;
            border-color: #B0B0B0;
        }

        .coach-upload-area.has-photo {
            padding: 0;
            border-style: solid;
            border-color: #E0E0E0;
        }

        .coach-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .coach-upload-text {
            font-size: 17px;
            font-weight: 600;
            color: #6B6B6B;
        }

        .coach-upload-subtext {
            font-size: 13px;
            color: #B0B0B0;
            margin-top: 6px;
        }

        .coach-preview-img {
            width: 100%;
            min-height: 45vh;
            object-fit: cover;
            border-radius: 14px;
            display: block;
        }

        .coach-tap-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 8px;
            text-align: center;
        }

        .coach-analyze-btn {
            width: 100%;
            padding: 14px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
            margin-bottom: 8px;
        }

        .coach-analyze-btn:active {
            opacity: 0.8;
        }

        .coach-analyze-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .coach-upgrade-link {
            text-align: center;
            font-size: 11px;
            color: #bbb;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .coach-examples-link {
            text-align: center;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            padding: 8px;
        }

        .coach-examples-content {
            display: none;
            margin-top: 8px;
            font-size: 12px;
            color: #6B6B6B;
            line-height: 1.6;
        }

        .coach-analyzing {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .coach-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #E0E0E0;
            border-top-color: #1C1C1E;
            border-radius: 50%;
            animation: coachSpin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes coachSpin {
            to { transform: rotate(360deg); }
        }

        .coach-analyzing-text {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        .coach-analyzing-sub {
            font-size: 13px;
            color: #999;
        }

        .coach-result {
            display: none;
        }

        .coach-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .coach-back-btn {
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
            cursor: pointer;
            padding: 4px 0;
            font-family: inherit;
        }

        .coach-photos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .coach-photo-card {
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background: #F0F0F0;
        }

        .coach-photo-card img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
        }

        .coach-photo-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .coach-analysis-card {
            background: #F8F8F8;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .coach-avatar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .coach-avatar {
            font-size: 24px;
        }

        .coach-badge {
            background: #1C1C1E;
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .coach-encouragement {
            font-size: 14px;
            font-weight: 500;
            color: #1C1C1E;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .coach-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .coach-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ECECEC;
        }

        .coach-step:last-child {
            border-bottom: none;
        }

        .coach-step-num {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #1C1C1E;
            color: white;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .coach-step-text {
            font-size: 13px;
            color: #333;
            flex: 1;
            line-height: 1.4;
        }

        .coach-step-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            margin-top: 2px;
        }

        .coach-total-time {
            text-align: right;
            font-size: 13px;
            font-weight: 700;
            color: #1C1C1E;
            margin-top: 8px;
        }

        .coach-tip-card {
            background: #FFFBEB;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .coach-tip-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .coach-tip-text {
            font-size: 13px;
            color: #7A6C00;
            line-height: 1.5;
        }

        .coach-start-btn {
            width: 100%;
            padding: 14px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        .coach-start-btn:active {
            opacity: 0.8;
        }

        .coach-limit-reached {
            display: none;
            text-align: center;
            padding: 30px 20px;
        }

        .coach-limit-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .coach-limit-title {
            font-size: 16px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .coach-limit-bar {
            width: 100%;
            height: 6px;
            background: #D32F2F;
            border-radius: 3px;
            margin-bottom: 6px;
        }

        .coach-limit-text {
            font-size: 12px;
            color: #999;
            margin-bottom: 20px;
        }

        .coach-upgrade-btn {
            width: 100%;
            padding: 14px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .coach-paywall-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 300;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .coach-paywall-overlay.show {
            display: flex;
            flex-direction: column;
        }

        .coach-paywall-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 301;
        }

        .coach-paywall-header {
            padding: 60px 24px 30px;
            text-align: center;
            color: white;
        }

        .coach-paywall-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .coach-paywall-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .coach-paywall-card {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 28px 24px 40px;
            flex: 1;
        }

        .coach-paywall-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px;
        }

        .coach-paywall-features li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .coach-paywall-features li .feature-icon {
            font-size: 20px;
        }

        .coach-billing-toggle {
            display: flex;
            background: #F0F0F0;
            border-radius: 12px;
            padding: 3px;
            margin-bottom: 20px;
        }

        .coach-billing-btn {
            flex: 1;
            padding: 10px 4px;
            border: none;
            border-radius: 10px;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            text-align: center;
        }

        .coach-billing-btn.active {
            background: white;
            color: #1C1C1E;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .coach-billing-save {
            background: #2D8B2D;
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .coach-billing-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .coach-billing-price {
            font-size: 28px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .coach-billing-period {
            font-size: 14px;
            color: #999;
            margin-left: 2px;
        }

        .coach-billing-detail {
            font-size: 12px;
            color: #B0B0B0;
            margin-top: 2px;
        }

        .coach-paywall-cta {
            width: 100%;
            padding: 16px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-bottom: 16px;
        }

        .coach-paywall-cta:active {
            opacity: 0.85;
        }

        .coach-paywall-footer {
            text-align: center;
            font-size: 12px;
            color: #B0B0B0;
        }

        .coach-paywall-footer a {
            color: #999;
            text-decoration: underline;
            cursor: pointer;
        }

        .coach-paywall-footer .footer-note {
            margin-top: 6px;
        }

        .space-hint {
            font-size: 12px;
            color: #1C1C1E;
            font-weight: 600;
            margin-top: 4px;
            margin-bottom: 0;
            padding: 6px 10px;
            background: #FAFAFA;
            border-radius: 8px;
            border: 1px solid #E5E5E5;
            display: none;
        }

        /* Achievement Animation */
        .achievement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .achievement-overlay.show {
            display: flex;
        }

        .achievement-badge {
            font-size: 120px;
            animation: spinBadge 2s ease-in-out infinite;
        }

        @keyframes spinBadge {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .achievement-title {
            color: #FFFFFF;
            font-size: 28px;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        .achievement-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            margin-top: 10px;
            text-align: center;
        }

        .achievement-points {
            color: #FFFFFF;
            font-size: 36px;
            font-weight: 700;
            margin-top: 15px;
        }

        .achievement-dismiss {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 30px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 3001;
            pointer-events: none;
            animation: confettiFall 3s ease-in-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .nickname-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .nickname-modal.show {
            display: flex;
        }

        .nickname-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .nickname-card h2 {
            font-size: 28px;
            color: #1C1C1E;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .nickname-card p {
            color: #6B6B6B;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .nickname-card input {
            width: 100%;
            padding: 15px;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            box-sizing: border-box;
            color: #1C1C1E;
        }

        .nickname-card input:focus {
            outline: none;
            border-color: #1C1C1E;
        }

        .nickname-btn {
            width: 100%;
            padding: 15px;
            background: #1C1C1E;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .nickname-btn:active {
            opacity: 0.75;
        }

        .privacy-note {
            font-size: 12px;
            color: #6B6B6B !important;
            margin-top: 15px;
            margin-bottom: 0 !important;
        }

        /* Calendar Container */
        .calendar-container {
            padding: 0;
        }

        /* Calendar Header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px;
        }

        .calendar-month {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
            margin: 0;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: 1px solid #E5E5E5;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            color: #1C1C1E;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn:hover {
            background: #FAFAFA;
            border-color: #1C1C1E;
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .share-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Calendar Stats */
        .calendar-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            background: #FAFAFA;
            border-radius: 10px;
            padding: 10px 12px;
        }

        .stat-item .stat-label {
            font-size: 11px;
            color: #6B6B6B;
            margin-bottom: 2px;
        }

        .stat-item .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
        }

        /* Day Labels */
        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
            padding: 0 5px;
        }

        .day-label {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #6B6B6B;
            padding: 4px 0;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 10px;
        }

        /* Calendar Day Cell */
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: #FFFFFF;
            border: 1px solid #F0F0F0;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            border-color: #E5E5E5;
            background: #FAFAFA;
        }

        /* Day Number */
        .day-number {
            font-size: 12px;
            font-weight: 500;
            color: #1C1C1E;
            margin-bottom: 1px;
        }

        /* Day Icon */
        .day-icon {
            font-size: 14px;
            line-height: 1;
        }

        /* Day States */
        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.other-month:hover {
            background: #FFFFFF;
            border-color: #F0F0F0;
        }

        .calendar-day.today {
            border: 2px solid #1C1C1E;
            background: #FAFAFA;
        }

        .calendar-day.active {
            background: #1C1C1E;
            border-color: #1C1C1E;
        }

        .calendar-day.active .day-number {
            color: #FFFFFF;
        }

        .calendar-day.active .day-icon {
            filter: brightness(0) invert(1);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            pointer-events: none;
        }

        /* Month Summary */
        .month-summary {
            background: #FAFAFA;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        .summary-title {
            font-size: 13px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .summary-number {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 1px;
        }

        .summary-label {
            font-size: 10px;
            color: #6B6B6B;
        }

        /* CRITICAL - Mobile Responsive */
        @media (max-width: 414px) {
            .profile-header {
                padding: 6px 12px;
            }

            .main-content {
                padding: 15px;
                padding-bottom: 64px;
            }

            .add-card {
                padding: 15px;
            }

            .card {
                padding: 14px;
            }
        }

        @media (max-height: 700px) {
            .profile-avatar-wrapper {
                width: 28px;
                height: 28px;
            }
            .profile-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }

        @media (max-width: 380px) {
            .calendar-month {
                font-size: 18px;
            }

            .day-number {
                font-size: 11px;
            }

            .day-icon {
                font-size: 12px;
            }

            .summary-number {
                font-size: 18px;
            }

            .profile-name {
                font-size: 13px;
                max-width: 80px;
            }

            .nav-icon {
                font-size: 18px;
            }

            .nav-label {
                font-size: 9px;
            }
        }

        /* ===== Before & After Feature Styles ===== */

        /* B&A Chip Toggle */
        .ba-chip-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ba-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 12px;
            border-radius: 16px;
            border: 1.5px solid #ddd;
            background: white;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: inherit;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .ba-chip.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .ba-bonus-hint {
            font-size: 11px;
            font-weight: 600;
            color: #4CAF50;
            animation: gentlePulse 3s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.55; }
        }

        /* B&A Photo Slots */
        .ba-photo-slots {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            animation: fadeInUp 0.35s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(12px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ba-photo-slot {
            flex: 1;
            height: 80px;
            border: 2px dashed #d4c4a8;
            border-radius: 14px;
            background: #fdf9f3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .ba-photo-slot.cleared-slot {
            border-color: #a8d4ab;
            background: #f3fdf4;
        }

        .ba-photo-slot .slot-icon {
            font-size: 22px;
            color: #c4a882;
            margin-bottom: 2px;
        }

        .ba-photo-slot.cleared-slot .slot-icon {
            color: #7cb87e;
        }

        .ba-photo-slot .slot-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #c4a882;
        }

        .ba-photo-slot.cleared-slot .slot-label {
            color: #7cb87e;
        }

        .ba-photo-slot .slot-preview {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .ba-photo-slot .slot-label-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: white;
            background: rgba(0,0,0,0.5);
            display: none;
        }

        .ba-photo-slot.has-photo .slot-icon,
        .ba-photo-slot.has-photo .slot-label {
            display: none;
        }

        .ba-photo-slot.has-photo .slot-label-overlay {
            display: none;
        }

        /* B&A Progress Feedback */
        .ba-progress-text {
            font-size: 11px;
            color: #999;
        }

        .ba-progress-text.complete {
            color: #4CAF50;
            font-weight: 700;
            animation: celebrateText 0.4s ease;
        }

        @keyframes celebrateText {
            0% { transform: scale(0.5) rotate(-5deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* B&A Bonus in Points Info */
        .bonus-points-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #bbb;
            background: #f0f0f0;
            transition: all 0.3s ease;
        }

        .bonus-points-badge.active {
            color: white;
            background: #4CAF50;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0.7); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ===== Feed Tab B&A Styles ===== */

        /* Feed 3-Tab Segment Control */
        .feed-segment {
            display: flex;
            background: #e8e8e8;
            border-radius: 12px;
            padding: 3px;
            margin-bottom: 12px;
        }

        .feed-segment-btn {
            flex: 1;
            padding: 8px 4px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: #999;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
        }

        .feed-segment-btn.seg-ba {
            flex: 1.4;
        }

        .feed-segment-btn.active {
            background: white;
            color: #1C1C1E;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Feed tab content areas */
        .feed-tab-content {
            display: none;
        }

        .feed-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* You Tab — Stats Bar */
        .you-stats-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 14px;
            padding: 12px 14px;
            margin-bottom: 12px;
            border: 1px solid #E5E5E5;
        }

        .you-stats-left {
            display: flex;
            gap: 20px;
        }

        .you-stat {
            display: flex;
            flex-direction: column;
        }

        .you-stat-value {
            font-size: 18px;
            font-weight: 800;
            color: #1C1C1E;
            line-height: 1.2;
        }

        .you-stat-value.points {
            color: #4CAF50;
        }

        .you-stat-label {
            font-size: 9px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .you-share-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .you-share-btn:active {
            opacity: 0.8;
        }

        /* You Tab — Share Mode Buttons */
        .you-share-mode-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .you-share-mode-bar .cancel-btn {
            background: white;
            color: #1C1C1E;
            border: 1.5px solid #E5E5E5;
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .you-share-mode-bar .share-count-btn {
            background: #1C1C1E;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .you-share-mode-bar .share-count-btn.disabled {
            background: #ccc;
            color: #999;
            pointer-events: none;
        }

        .you-share-helper {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        /* You Tab — Grid */
        .you-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            border-radius: 16px;
            overflow: hidden;
        }

        .you-grid-cell {
            aspect-ratio: 1 / 1;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background: #f0f0f0;
        }

        .you-grid-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .you-grid-cell .grid-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 6px;
            background: linear-gradient(transparent, rgba(0,0,0,0.6));
        }

        .you-grid-cell .grid-item-name {
            font-size: 9px;
            color: white;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .you-grid-cell .grid-points-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 8px;
        }

        /* Selection mode */
        .you-grid-cell.selectable {
            transition: opacity 0.15s;
        }

        .you-grid-cell.selectable:not(.selected) {
            opacity: 0.5;
        }

        .you-grid-cell.selected {
            opacity: 1;
        }

        .you-grid-cell .grid-check {
            display: none;
            position: absolute;
            top: 6px;
            left: 6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #1C1C1E;
            color: white;
            font-size: 12px;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .you-grid-cell.selectable .grid-check {
            display: flex;
            background: rgba(255,255,255,0.4);
            border: 2px solid white;
        }

        .you-grid-cell.selected .grid-check {
            display: flex;
            background: #1C1C1E;
            border: 2px solid #1C1C1E;
        }

        /* Share Bottom Sheet */
        .share-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            animation: fadeIn 0.2s ease;
        }

        .share-overlay.active {
            display: block;
        }

        .share-sheet {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 24px 20px 40px;
            z-index: 301;
            animation: slideUp 0.3s ease;
        }

        .share-sheet-handle {
            width: 36px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .share-preview-grid {
            display: grid;
            gap: 4px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .share-preview-grid img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            display: block;
        }

        .share-summary {
            text-align: center;
            margin-bottom: 20px;
        }

        .share-summary-title {
            font-size: 16px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        .share-summary-points {
            font-size: 14px;
            color: #4CAF50;
            font-weight: 600;
        }

        .share-ig-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #833AB4, #E1306C, #F77737);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .share-ig-btn:active {
            opacity: 0.9;
        }

        .share-more-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #1C1C1E;
            border: 1.5px solid #E5E5E5;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .share-save-btn {
            width: 100%;
            padding: 14px;
            background: #F5F5F5;
            color: #1C1C1E;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); }
            to { transform: translateX(-50%) translateY(0); }
        }

        /* You tab empty state */
        .you-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .you-empty .empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* B&A Compact Card — collapsed looks like normal card */
        .item.ba-item {
            position: relative;
            border-bottom: 1px solid #f0f0f0;
            border-left: 3px solid #4CAF50;
            padding: 12px 15px;
        }

        .ba-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            background: #4CAF50;
            margin-left: 6px;
        }

        /* B&A thumbnail wrapper — same size as normal item-image */
        .ba-thumb-wrap {
            position: relative;
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            margin-right: 15px;
            cursor: pointer;
        }

        .ba-thumb-wrap .item-image {
            margin-right: 0;
        }

        /* Small B&A badge on bottom-right of thumbnail */
        .ba-thumb-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            display: flex;
            align-items: center;
            gap: 3px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            line-height: 1;
        }

        .ba-thumb-badge .ba-photo-badge-icon .half-warm {
            width: 5px;
            height: 8px;
        }

        .ba-thumb-badge .ba-photo-badge-icon .half-green {
            width: 5px;
            height: 8px;
        }

        /* B&A photo badge overlay (bottom-right of item photo) */
        .ba-photo-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .ba-photo-badge-icon {
            display: inline-flex;
            gap: 1px;
        }

        .ba-photo-badge-icon .half-warm {
            display: inline-block;
            width: 6px;
            height: 10px;
            background: #e8d5b8;
            border-radius: 2px 0 0 2px;
        }

        .ba-photo-badge-icon .half-green {
            display: inline-block;
            width: 6px;
            height: 10px;
            background: #4CAF50;
            border-radius: 0 2px 2px 0;
        }

        .ba-points-display {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ba-points-display .base-pts {
            font-weight: 700;
            color: #1C1C1E;
            font-size: 18px;
        }

        .ba-points-display .bonus-pts {
            font-size: 12px;
            font-weight: 700;
            color: #4CAF50;
            background: #e8f5e9;
            padding: 2px 8px;
            border-radius: 8px;
        }

        /* B&A Expand Section — hidden by default */
        .ba-expand-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .ba-expand-section.expanded {
            max-height: 500px;
        }

        .ba-expand-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0 4px;
        }

        .ba-expand-label {
            font-size: 13px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .ba-expand-close {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #6B6B6B;
            line-height: 1;
            padding: 0;
        }

        /* Make B&A item photo clickable */
        .ba-item-photo-container {
            cursor: pointer;
        }

        /* Interactive Slider */
        .ba-slider-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
            cursor: ew-resize;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .ba-slider-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ba-slider-after {
            clip-path: inset(0 0 0 var(--slider-pos, 80%));
        }

        .ba-slider-divider {
            position: absolute;
            top: 0;
            bottom: 0;
            left: var(--slider-pos, 80%);
            width: 3px;
            background: white;
            transform: translateX(-50%);
            z-index: 2;
            pointer-events: none;
        }

        .ba-slider-handle {
            position: absolute;
            top: 50%;
            left: var(--slider-pos, 80%);
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 3;
            pointer-events: none;
            color: #333;
        }

        .ba-slider-label {
            position: absolute;
            top: 10px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            z-index: 2;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .ba-slider-label.left {
            left: 10px;
            background: rgba(196,168,130,0.85);
            color: white;
        }

        .ba-slider-label.right {
            right: 10px;
            background: rgba(76,175,80,0.85);
            color: white;
        }

        .ba-slider-hint {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            z-index: 4;
            pointer-events: none;
            white-space: nowrap;
        }

        .ba-slider-hint .hint-emoji {
            display: inline-block;
            animation: slideHint 1.5s ease-in-out infinite;
        }

        @keyframes slideHint {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-6px); }
        }

        .ba-slider-celebration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 700;
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .ba-slider-celebration.show {
            opacity: 1;
        }



        /* ===== B&A Popup Styles ===== */
        .ba-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 5000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .ba-popup-overlay.show {
            display: flex;
        }

        .ba-popup-sheet {
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 0 20px 30px;
            animation: slideUp 0.4s ease;
            overflow-y: auto;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0.8; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ba-popup-handle {
            width: 36px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 12px auto 16px;
        }

        .ba-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .ba-popup-supertitle {
            font-size: 13px;
            font-weight: 700;
            color: #FF6B35;
            margin-bottom: 2px;
        }

        .ba-popup-title {
            font-size: 20px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .ba-popup-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #999;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .ba-popup-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .ba-popup-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e8d5b8, #4CAF50);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .ba-popup-user-name {
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
        }

        .ba-popup-user-meta {
            font-size: 12px;
            color: #999;
        }

        .ba-popup-reactions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .ba-popup-reaction-btn {
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ba-popup-reaction-btn:hover {
            background: #eee;
        }

        .ba-popup-likes {
            margin-left: auto;
            font-size: 14px;
            color: #999;
        }

        .ba-popup-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 16px 0;
        }

        .ba-popup-dot {
            width: 8px;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .ba-popup-dot.active {
            width: 20px;
            background: #1C1C1E;
        }

        .ba-popup-buttons {
            display: flex;
            gap: 10px;
        }

        .ba-popup-skip {
            padding: 14px 20px;
            border-radius: 12px;
            border: 1.5px solid #E5E5E5;
            background: white;
            color: #6B6B6B;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .ba-popup-next {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            background: #1C1C1E;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .ba-popup-cta {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #43A047, #66BB6A);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .ba-popup-cta::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        .ba-popup-card {
            animation: cardSwipe 0.35s ease;
        }

        @keyframes cardSwipe {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Dream Home Vision - Onboarding Card */
        .dream-vision-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 22px;
            padding: 24px 20px;
            margin-bottom: 16px;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dream-vision-card .dream-heading {
            font-size: 17px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .dream-vision-card .dream-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 16px;
        }

        .dream-vision-card .dream-input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }

        .dream-vision-card .dream-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .dream-vision-card .dream-input:focus {
            border-color: rgba(255,255,255,0.3);
        }

        .dream-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 16px;
        }

        .dream-chip {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            padding: 6px 14px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dream-chip:active {
            background: rgba(255,255,255,0.15);
        }

        .dream-set-btn {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: none;
            background: #fff;
            color: #1a1a1a;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .dream-set-btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Dream Home Vision - One-liner (after set) */
        .dream-vision-line {
            font-size: 13px;
            font-style: italic;
            color: #999;
            padding: 0 20px 8px;
            cursor: pointer;
            line-height: 1.4;
        }

        .dream-vision-line-edit {
            width: 100%;
            font-size: 13px;
            font-style: italic;
            color: #999;
            background: none;
            border: none;
            border-bottom: 1px solid #ccc;
            outline: none;
            padding: 0;
            margin-left: 4px;
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🗓️</div>
            <div class="login-title">Declutter Daily</div>
            <div class="login-subtitle">One item at a time</div>

            <button class="social-btn social-btn-google" id="googleLoginBtn">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Nickname Setup Modal -->
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-card">
            <h2>Welcome</h2>
            <p>Choose your display name</p>
            <input type="text"
                   id="nicknameSetup"
                   placeholder="Enter nickname (2-15 chars)"
                   maxlength="15">
            <button class="nickname-btn" id="nicknameBtn">
                Start Decluttering!
            </button>
            <p class="privacy-note">
                Your real name stays private
            </p>
        </div>
    </div>

    <div class="container" id="mainApp">
        <!-- Compact Profile Header -->
        <div class="profile-header">
            <div class="profile-header-row">
                <div class="profile-avatar-wrapper" onclick="toggleBadgeDrawer()" aria-label="Show badges">
                    <div class="profile-avatar" id="profileAvatar">YK</div>
                    <div class="profile-avatar-camera">
                        <svg viewBox="0 0 24 24"><path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                    </div>
                </div>
                <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhotoSelect(event)">
                <div class="profile-header-info">
                    <span class="profile-name" id="profileName">User</span>
                    <span class="profile-provider" id="profileProvider">Google</span>
                    <span class="profile-header-stat">🔥 <span class="stat-val" id="headerStreak">0</span></span>
                    <span class="profile-header-stat">⭐ <span class="stat-val" id="headerScore">0</span><small>pts</small></span>
                </div>
                <button class="settings-btn" onclick="openSettings()" aria-label="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6a3.6 3.6 0 1 1 0-7.2 3.6 3.6 0 0 1 0 7.2z"/>
                    </svg>
                </button>
            </div>
            <div class="badges-drawer" id="badgesDrawer">
                <div class="badges-display" id="badgesDisplay">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <!-- Hidden stats for backward compat -->
            <div class="profile-stats" style="display:none;">
                <div class="stat">
                    <div class="stat-value" id="headerItems">0</div>
                    <div class="stat-label">ITEMS</div>
                </div>
            </div>
        </div>

        <!-- Hidden elements for backward compat -->
        <div id="totalScore" style="display:none;">0</div>
        <div id="streakBadge" style="display:none;">0 Day Streak</div>
        <div id="badgeCount" style="display:none;">0</div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <div id="addTab" class="tab-content active">
                <!-- Dream Home Vision: Onboarding Card (shown when no vision set) -->
                <div class="dream-vision-card" id="dreamVisionCard" style="display:none;">
                    <div class="dream-heading">🏡 What does your dream home look like?</div>
                    <div class="dream-subtitle">One sentence to keep you motivated</div>
                    <input type="text" class="dream-input" id="dreamVisionInput" placeholder="A home where everything has its place..." oninput="onDreamVisionInput()">
                    <div class="dream-chips">
                        <div class="dream-chip" onclick="selectDreamChip(this)">A home where everything has its place</div>
                        <div class="dream-chip" onclick="selectDreamChip(this)">Calm, minimal space with only things I love</div>
                        <div class="dream-chip" onclick="selectDreamChip(this)">A clutter-free home my kids can play freely in</div>
                        <div class="dream-chip" onclick="selectDreamChip(this)">Clean surfaces, open shelves, breathing room</div>
                    </div>
                    <button class="dream-set-btn" id="dreamSetBtn" onclick="setDreamVision()">Set My Vision</button>
                </div>

                <!-- Dream Home Vision: One-liner (shown when vision is set) -->
                <div class="dream-vision-line" id="dreamVisionLine" style="display:none;" onclick="editDreamVision()">
                </div>

                <div class="add-card">
                    <h2 class="add-title">What are you letting go?</h2>

                    <!-- Photo Row: single photo or 3-column with B&A -->
                    <div class="photo-row" id="photoRow">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <img id="previewImage" class="preview-image" alt="Preview">
                            <div id="uploadPlaceholder">
                                <div class="upload-icon-svg">
                                    <svg width="32" height="32" viewBox="0 0 50 50" fill="none">
                                        <circle cx="25" cy="25" r="23" stroke="#6B6B6B" stroke-width="2.5"/>
                                        <line x1="12" y1="25" x2="38" y2="25" stroke="#6B6B6B" stroke-width="3" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <div class="upload-text">Item Photo</div>
                            </div>
                        </div>
                        <div class="ba-photo-slot" id="beforeSlot" onclick="document.getElementById('beforeFileInput').click()" style="display:none;">
                            <div class="slot-icon">+</div>
                            <div class="slot-label">CLUTTERED</div>
                            <img class="slot-preview" id="beforePreview" alt="">
                            <div class="slot-label-overlay">CLUTTERED</div>
                        </div>
                        <div class="ba-photo-slot cleared-slot" id="afterSlot" onclick="document.getElementById('afterFileInput').click()" style="display:none;">
                            <div class="slot-icon">+</div>
                            <div class="slot-label">CLEARED</div>
                            <img class="slot-preview" id="afterPreview" alt="">
                            <div class="slot-label-overlay">CLEARED</div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*">
                    <input type="file" id="beforeFileInput" accept="image/*" style="display:none">
                    <input type="file" id="afterFileInput" accept="image/*" style="display:none">

                    <!-- B&A Chip + inline status text -->
                    <div class="ba-chip-container" id="baChipContainer" style="display:none;opacity:0;">
                        <button class="ba-chip" id="baChip" onclick="toggleBeforeAfter()">
                            <span id="baChipIcon">&#8853;</span> Before &amp; After
                        </button>
                        <span class="ba-bonus-hint" id="baBonusHint">+30 bonus pts &#10024;</span>
                        <span class="ba-progress-text" id="baProgressText" style="display:none;">Both for +30 bonus</span>
                    </div>

                    <input type="text" id="itemName" placeholder="Item (e.g., Old clothes)" oninput="updateSubmitButton()">

                    <!-- Category + Space side by side -->
                    <div class="category-space-row">
                        <select class="category-select" id="itemCategory" required>
                            <option value="">Category</option>
                            <option value="clothing">👕 Clothing (10)</option>
                            <option value="books">📖 Books (15)</option>
                            <option value="electronics">📱 Electronics (20)</option>
                            <option value="furniture">🪑 Furniture (30)</option>
                            <option value="kitchenware">🍽️ Kitchenware (10)</option>
                            <option value="shoes">👟 Shoes (10)</option>
                            <option value="food">🥫 Food (5)</option>
                            <option value="toys">🧸 Toys (5)</option>
                            <option value="digital">📄 Digital Docs (5)</option>
                            <option value="other">📦 Other (5)</option>
                        </select>
                        <select class="category-select" id="itemSpace">
                            <option value="">Space</option>
                            <option value="kitchen_space">🍳 Kitchen</option>
                            <option value="bathroom">🚿 Bathroom</option>
                            <option value="bedroom">🛏️ Bedroom</option>
                            <option value="living">🛋️ Living Room</option>
                            <option value="kids_room">🧒 Kids Room</option>
                            <option value="closet">👔 Closet</option>
                            <option value="office">💻 Office</option>
                            <option value="garage">🔧 Garage</option>
                            <option value="pantry">🥫 Pantry</option>
                        </select>
                    </div>
                    <div class="space-hint" id="spaceHint"></div>

                    <div class="points-info" id="pointsInfo" style="display: none;">
                        Expected: <span id="expectedPoints">0</span> pts<span class="bonus-points-badge" id="bonusBadge" style="display:none">+30 bonus</span>
                    </div>

                    <textarea id="itemNote" placeholder="Notes (optional)" rows="2" style="margin-top:10px;font-size:13px;"></textarea>

                    <button class="submit-btn" id="submitBtn" onclick="addItem()" disabled>Done!</button>
                </div>
            </div>

        <div id="coachTab" class="tab-content">
            <div class="card">
                <!-- Home screen -->
                <div id="coachHome">
                    <div class="coach-header">
                        <h2 style="display:flex; align-items:center; gap:8px;"><img src="./images/tidy-coach.png" alt="Tidy" style="width:28px; height:28px; border-radius:50%; object-fit:cover;" /><span>AI Coach Tidy</span></h2>
                        <div class="coach-usage-pill" id="coachUsagePill">
                            <span class="usage-dot"></span>
                            <span id="coachUsageText">Unlimited</span>
                        </div>
                    </div>

                    <div class="coach-upload-area" id="coachUploadArea" onclick="document.getElementById('coachFileInput').click()">
                        <div id="coachUploadPrompt">
                            <div class="coach-upload-icon">&#128247;</div>
                            <div class="coach-upload-text">Upload a messy space</div>
                            <div class="coach-upload-subtext">Take a photo or choose from gallery</div>
                        </div>
                        <img id="coachPreviewImg" class="coach-preview-img" style="display:none;">
                        <div class="coach-tap-overlay" id="coachTapOverlay" style="display:none;">Tap to change</div>
                    </div>
                    <input type="file" id="coachFileInput" accept="image/*" style="display:none;" onchange="handleCoachPhoto(event)">

                    <button class="coach-analyze-btn" id="coachAnalyzeBtn" disabled onclick="analyzeSpace()">Analyze &amp; Transform</button>

                    <div class="coach-upgrade-link" id="coachUpgradeLink" onclick="openPaywall()">&#10024; Upgrade for unlimited analyses</div>

                    <div class="coach-examples-link" id="coachExamplesToggle" onclick="toggleCoachExamples()">Example transformations</div>
                    <div class="coach-examples-content" id="coachExamplesContent">
                        Upload a photo of any cluttered space — kitchen counter, desk, closet, garage — and get a personalized step-by-step decluttering plan with an AI-generated visualization of your space, tidied up.
                    </div>

                    <!-- Limit reached state -->
                    <div class="coach-limit-reached" id="coachLimitReached">
                        <div class="coach-limit-icon">&#128274;</div>
                        <div class="coach-limit-title">You've used all free analyses</div>
                        <div class="coach-limit-bar"></div>
                        <div class="coach-limit-text">Limit reached &middot; Resets next month</div>
                        <button class="coach-upgrade-btn" onclick="openPaywall()"><img src="./images/tidy-coach.png" alt="" style="width:20px; height:20px; border-radius:50%; object-fit:cover; vertical-align:middle; margin-right:4px;" />Upgrade to Pro</button>
                    </div>
                </div>

                <!-- Analyzing screen -->
                <div class="coach-analyzing" id="coachAnalyzing">
                    <div class="coach-spinner"></div>
                    <div class="coach-analyzing-text">Analyzing your space...</div>
                    <div class="coach-analyzing-sub">This takes a few seconds</div>
                </div>

                <!-- Result screen -->
                <div class="coach-result" id="coachResult">
                    <div class="coach-result-header">
                        <button class="coach-back-btn" onclick="resetCoach()">&larr; New analysis</button>
                        <div class="coach-usage-pill" id="coachUsagePillResult">
                            <span class="usage-dot"></span>
                            <span id="coachUsageTextResult">Unlimited</span>
                        </div>
                    </div>

                    <div class="coach-photos">
                        <div class="coach-photo-card">
                            <img id="coachBeforeImg" src="" alt="Before">
                            <div class="coach-photo-label">Before</div>
                        </div>
                        <div class="coach-photo-card">
                            <img id="coachAfterImg" src="" alt="After (AI)">
                            <div class="coach-photo-label">After (AI)</div>
                        </div>
                    </div>

                    <div class="coach-analysis-card">
                        <div class="coach-avatar-row">
                            <span class="coach-avatar">&#127968;</span>
                            <span class="coach-badge">AI COACH</span>
                        </div>
                        <div class="coach-encouragement" id="coachEncouragement"></div>
                        <ol class="coach-steps" id="coachSteps"></ol>
                        <div class="coach-total-time" id="coachTotalTime"></div>
                    </div>

                    <div class="coach-tip-card">
                        <span class="coach-tip-icon">&#128161;</span>
                        <div class="coach-tip-text" id="coachTipText"></div>
                    </div>

                    <button class="coach-start-btn" onclick="resetCoach()">Start Decluttering</button>
                </div>
            </div>
        </div>

        <!-- Coach Paywall Overlay -->
        <div class="coach-paywall-overlay" id="coachPaywall">
            <button class="coach-paywall-close" onclick="closePaywall()">&times;</button>
            <div class="coach-paywall-header">
                <img src="./images/tidy-coach.png" alt="Tidy" style="width:64px; height:64px; border-radius:50%; object-fit:cover; margin-bottom:12px;" />
                <div class="coach-paywall-title">Your Space Transformed</div>
                <div class="coach-paywall-subtitle">Upload a messy space. Watch it become calm.</div>
            </div>
            <div class="coach-paywall-card">
                <ul class="coach-paywall-features">
                    <li><span class="feature-icon">&#128248;</span> AI-generated after photo</li>
                    <li><span class="feature-icon">&#128506;</span> Personalized declutter roadmap</li>
                    <li><span class="feature-icon">&#10024;</span> Unlimited space resets</li>
                    <li><span class="feature-icon">&#127807;</span> Simple maintenance coaching</li>
                </ul>

                <div class="coach-billing-toggle" id="coachBillingToggle">
                    <button class="coach-billing-btn active" data-cycle="yearly" onclick="switchBilling('yearly')">Yearly <span class="coach-billing-save">Save 37%</span></button>
                    <button class="coach-billing-btn" data-cycle="monthly" onclick="switchBilling('monthly')">Monthly</button>
                </div>

                <div class="coach-billing-info">
                    <div><span class="coach-billing-price" id="coachBillingPrice">$29.99</span><span class="coach-billing-period" id="coachBillingPeriod">/year</span></div>
                    <div class="coach-billing-detail" id="coachBillingDetail">$2.50/mo</div>
                </div>

                <button class="coach-paywall-cta" id="coachPaywallCta" onclick="startSubscription()">Start My Transformation &mdash; $29.99/year</button>

                <div class="coach-paywall-footer">
                    <a onclick="restorePurchase()">Restore purchase</a>
                    <div class="footer-note">Cancel anytime &middot; Secure payment via Stripe</div>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="card">
                <!-- 3-Tab Segment Control -->
                <div class="feed-segment">
                    <button class="feed-segment-btn active" id="segAll" onclick="setFeedFilter('all')">All</button>
                    <button class="feed-segment-btn" id="segYou" onclick="setFeedFilter('you')">You</button>
                    <button class="feed-segment-btn seg-ba" id="segBA" onclick="setFeedFilter('ba')">Before &amp; After</button>
                </div>

                <!-- All Tab Content -->
                <div class="feed-tab-content active" id="feedContentAll">
                    <div class="item-list" id="itemList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- You Tab Content -->
                <div class="feed-tab-content" id="feedContentYou">
                    <div class="you-stats-bar" id="youStatsBar">
                        <div class="you-stats-left">
                            <div class="you-stat">
                                <div class="you-stat-value" id="youItemCount">0</div>
                                <div class="you-stat-label">ITEMS</div>
                            </div>
                            <div class="you-stat">
                                <div class="you-stat-value points" id="youPointsCount">0</div>
                                <div class="you-stat-label">POINTS</div>
                            </div>
                        </div>
                        <div id="youShareActions">
                            <button class="you-share-btn" id="youShareBtn" onclick="toggleYouShareMode()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16 6 12 2 8 6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="youShareHelper" class="you-share-helper" style="display:none;">Select up to 9 items to share</div>
                    <div class="you-grid" id="youGrid"></div>
                </div>

                <!-- Before & After Tab Content -->
                <div class="feed-tab-content" id="feedContentBA">
                    <div class="item-list" id="baItemList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Bottom Sheet -->
        <div class="share-overlay" id="shareSheetOverlay" onclick="closeShareSheet()"></div>
        <div class="share-sheet" id="shareSheet" style="display:none;">
            <div class="share-sheet-handle"></div>
            <div class="share-preview-grid" id="sharePreviewGrid"></div>
            <div class="share-summary">
                <div class="share-summary-title" id="shareSummaryTitle"></div>
            </div>
            <button class="share-ig-btn" onclick="shareToInstagram()">Share to Instagram</button>
            <button class="share-more-btn" onclick="shareMore()">More options</button>
            <button class="share-save-btn" onclick="saveShareImage()">Save image to gallery</button>
        </div>

        <div class="tab-content" id="calendarTab">
            <div class="calendar-container">
                <!-- Header with Month/Year and Share -->
                <div class="calendar-header">
                    <h2 class="calendar-month" id="calendarMonth">February 2026</h2>
                    <button class="share-btn" onclick="shareProgress()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                            <polyline points="16 6 12 2 8 6"/>
                            <line x1="12" y1="2" x2="12" y2="15"/>
                        </svg>
                        Share
                    </button>
                </div>

                <!-- Streak Stats -->
                <div class="calendar-stats">
                    <div class="stat-item">
                        <div class="stat-label">Your Streak</div>
                        <div class="stat-value" id="calendarStreakValue">0 Days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="calendarMonthCount">0 Items</div>
                    </div>
                </div>

                <!-- Day Labels -->
                <div class="calendar-days-header">
                    <div class="day-label">M</div>
                    <div class="day-label">T</div>
                    <div class="day-label">W</div>
                    <div class="day-label">T</div>
                    <div class="day-label">F</div>
                    <div class="day-label">S</div>
                    <div class="day-label">S</div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Days will be dynamically generated -->
                </div>

                <!-- Month Summary -->
                <div class="month-summary">
                    <div class="summary-title">Monthly Summary</div>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="summary-number" id="monthItems">0</span>
                            <span class="summary-label">items</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-number" id="monthPoints">0</span>
                            <span class="summary-label">points</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-number" id="monthDays">0</span>
                            <span class="summary-label">active days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="leaderboardTab" class="tab-content">
            <div class="ranking-card">
                <div class="ranking-card-title">Global Rankings</div>
                <div id="leaderboardList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading rankings...
                    </div>
                </div>
            </div>
        </div>

        <div id="shareTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #1C1C1E; font-weight: 600;">Share Story</h2>
                <p style="color: #6B6B6B; margin-bottom: 20px; text-align: center;">Select a template and download to share on Instagram Stories!</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="generateStoryTemplate('minimal')" style="padding: 15px; background: #1C1C1E; color: #FFFFFF; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Minimal
                    </button>
                    <button onclick="generateStoryTemplate('stats')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Stats
                    </button>
                    <button onclick="generateStoryTemplate('streak')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Streak
                    </button>
                    <button onclick="generateStoryTemplate('grid')" style="padding: 15px; background: #EAEAEA; color: #1C1C1E; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Photo Grid
                    </button>
                </div>

                <canvas id="storyCanvas" style="width: 100%; max-width: 400px; margin: 0 auto; display: none; border-radius: 15px; border: 1px solid #E5E5E5;"></canvas>

                <div id="downloadSection" style="display: none; text-align: center; margin-top: 20px;">
                    <button onclick="downloadStoryImage()" style="width: 100%; padding: 18px; background: #1C1C1E; color: #FFFFFF; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;">
                        Download Image
                    </button>
                    <p style="color: #B0B0B0; font-size: 13px; margin-top: 10px;">Download and upload to Instagram Stories!</p>
                </div>
            </div>
        </div>

        </div><!-- end main-content -->

        <!-- Bottom Navigation - Fixed -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('add')" data-tab="add">
                <div class="nav-icon">👋</div>
                <div class="nav-label">Let Go</div>
            </button>

            <button class="nav-item" onclick="switchTab('coach')" data-tab="coach">
                <div class="nav-icon"><img src="./images/tidy-coach.png" alt="Coach" style="width:20px; height:20px; border-radius:50%; object-fit:cover; vertical-align:middle;" /></div>
                <div class="nav-label">Coach</div>
            </button>

            <button class="nav-item" onclick="switchTab('feed')" data-tab="feed">
                <div class="nav-icon">📋</div>
                <div class="nav-label">Feed</div>
            </button>

            <button class="nav-item" onclick="switchTab('calendar')" data-tab="calendar">
                <div class="nav-icon">🗓️</div>
                <div class="nav-label">Calendar</div>
            </button>

            <button class="nav-item" onclick="switchTab('leaderboard')" data-tab="leaderboard">
                <div class="nav-icon">🏆</div>
                <div class="nav-label">Ranks</div>
            </button>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal-overlay" id="badgeOverlay" onclick="closeBadgeModal()"></div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-icon" id="badgeModalIcon">🏆</div>
        <div class="badge-title" id="badgeModalTitle">New Badge Earned!</div>
        <div class="badge-desc" id="badgeModalDesc">First item decluttered!</div>
        <button class="btn" onclick="closeBadgeModal()">OK</button>
    </div>

    <!-- Badges Detail Modal -->
    <div class="badges-modal-overlay" id="badgesOverlay" onclick="closeBadgesModal()">
        <div class="badges-modal" onclick="event.stopPropagation()">
            <div class="badges-modal-header">
                <h3 class="badges-modal-title">Your Badges</h3>
                <span class="badges-progress" id="badgesProgress">0/7</span>
            </div>
            <div class="badges-list" id="badgesList">
                <!-- Dynamically filled -->
            </div>
            <button class="close-modal-btn" onclick="closeBadgesModal()">Close</button>
        </div>
    </div>

    <!-- Achievement Overlay -->
    <div class="achievement-overlay" id="achievementOverlay">
        <div class="achievement-badge" id="achievementBadge">🏆</div>
        <div class="achievement-title" id="achievementTitle">Space Complete!</div>
        <div class="achievement-subtitle" id="achievementSubtitle">Kitchen 10 items decluttered!</div>
        <div class="achievement-points" id="achievementPoints">+100 pts</div>
        <div class="achievement-dismiss">Tap to dismiss</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCgRc0r845aR7tTS7GNUmm8TMdLtSzeljY",
            authDomain: "declutter-challenge-94366.web.app",
            projectId: "declutter-challenge-94366",
            storageBucket: "declutter-challenge-94366.firebasestorage.app",
            messagingSenderId: "781105372309",
            appId: "1:781105372309:web:4ce495d1dc8eac2b0d8f9c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);
        const googleProvider = new GoogleAuthProvider();

        window.db = db;
        window.firestore = { collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment };

        let currentUserId = localStorage.getItem('userId') || null;
        let userName = localStorage.getItem('userName') || '';
        let totalScore = 0;
        let currentPhotoURL = '';
        let userProfilePhotoURL = localStorage.getItem('userProfilePhotoURL') || '';
        let userStreak = 0;
        let userBadges = [];
        // Coach state
        let coachPhotoBase64 = '';
        let coachPhotoFile = null;
        let coachUsageCount = 0;
        let coachUsageMonth = '';
        let coachBillingCycle = 'yearly';

        // Before & After state
        let baEnabled = false;
        let beforePhotoURL = '';
        let afterPhotoURL = '';
        let currentFeedFilter = 'all';
        let allFeedItems = [];

        const spaceNames = {
            'kitchen_space': 'Kitchen',
            'bathroom': 'Bathroom',
            'bedroom': 'Bedroom',
            'living': 'Living Room',
            'kids_room': 'Kids Room',
            'closet': 'Closet',
            'office': 'Office',
            'garage': 'Garage',
            'pantry': 'Pantry'
        };

        function getSpaceName(spaceKey) {
            return spaceNames[spaceKey] || spaceKey;
        }

        function updateSpaceHint() {
            const spaceSelect = document.getElementById('itemSpace');
            const hint = document.getElementById('spaceHint');
            if (spaceSelect.value) {
                hint.textContent = getSpaceName(spaceSelect.value);
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }

        // --- AI Coach Tidy Functions ---

        function handleCoachPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            coachPhotoFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress/resize to max 800px wide
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    let w = img.width;
                    let h = img.height;
                    if (w > maxWidth) {
                        h = Math.round(h * maxWidth / w);
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    coachPhotoBase64 = dataUrl.split(',')[1];

                    // Show preview
                    const previewImg = document.getElementById('coachPreviewImg');
                    previewImg.src = dataUrl;
                    previewImg.style.display = 'block';
                    document.getElementById('coachUploadPrompt').style.display = 'none';
                    document.getElementById('coachTapOverlay').style.display = 'block';
                    document.getElementById('coachUploadArea').classList.add('has-photo');
                    document.getElementById('coachAnalyzeBtn').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function loadCoachUsage() {
            if (!currentUserId) return;
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const usage = userData.coachUsage || {};
                    const currentMonth = new Date().toISOString().slice(0, 7);

                    if (usage.month === currentMonth) {
                        coachUsageCount = usage.count || 0;
                    } else {
                        coachUsageCount = 0;
                    }
                    coachUsageMonth = currentMonth;

                    // Check subscription
                    const sub = userData.subscription || {};
                    const isPro = sub.status === 'active';

                    updateCoachUsageUI(isPro);
                }
            } catch (error) {
                console.error('Coach usage load failed:', error);
            }
        }

        function updateCoachUsageUI(isPro) {
            const remaining = isPro ? 999 : Math.max(0, 999999 - coachUsageCount);
            const usageText = isPro ? 'Pro — Unlimited' : `${remaining} of 999999 left`;
            const isLow = !isPro && remaining <= 1;

            // Update both pills (home + result)
            ['coachUsagePill', 'coachUsagePillResult'].forEach(id => {
                const pill = document.getElementById(id);
                if (pill) {
                    pill.classList.toggle('low', isLow);
                }
            });
            ['coachUsageText', 'coachUsageTextResult'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = usageText;
            });

            // Show/hide limit reached
            const canAnalyze = isPro || remaining > 0;
            const limitEl = document.getElementById('coachLimitReached');
            const homeEl = document.getElementById('coachHome');
            const uploadArea = document.getElementById('coachUploadArea');
            const analyzeBtn = document.getElementById('coachAnalyzeBtn');
            const upgradeLink = document.getElementById('coachUpgradeLink');
            const examplesToggle = document.getElementById('coachExamplesToggle');

            if (!canAnalyze) {
                limitEl.style.display = 'block';
                uploadArea.style.display = 'none';
                analyzeBtn.style.display = 'none';
                upgradeLink.style.display = 'none';
                examplesToggle.style.display = 'none';
            } else {
                limitEl.style.display = 'none';
                uploadArea.style.display = '';
                analyzeBtn.style.display = '';
                upgradeLink.style.display = isPro ? 'none' : '';
                examplesToggle.style.display = '';
            }
        }

        async function analyzeSpace() {
            if (!coachPhotoBase64) return;

            const analyzeBtn = document.getElementById('coachAnalyzeBtn');
            analyzeBtn.disabled = true;

            // Show analyzing screen
            document.getElementById('coachHome').style.display = 'none';
            document.getElementById('coachAnalyzing').style.display = 'block';
            document.getElementById('coachResult').style.display = 'none';

            try {
                // Get user vision for context
                let userVision = '';
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    userVision = userSnapshot.docs[0].data().dreamVision || '';
                }

                // Call Cloud Function with timeout
                const controller = new AbortController();
                const fetchTimeout = setTimeout(() => controller.abort(), 90000);
                const response = await fetch('https://us-central1-declutter-challenge-94366.cloudfunctions.net/analyzeSpace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageBase64: coachPhotoBase64,
                        userId: currentUserId,
                        userVision: userVision
                    }),
                    signal: controller.signal
                });
                clearTimeout(fetchTimeout);

                if (!response.ok) {
                    const errBody = await response.text().catch(() => '');
                    console.error('analyzeSpace response:', response.status, errBody);
                    throw new Error('Analysis failed (' + response.status + ')');
                }

                const result = await response.json();

                // Increment usage
                coachUsageCount++;
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        coachUsage: {
                            month: coachUsageMonth || new Date().toISOString().slice(0, 7),
                            count: coachUsageCount
                        }
                    });
                }

                // Render result
                renderCoachResult(result);

            } catch (error) {
                console.error('Analysis error:', error);
                let msg = 'Analysis failed. Please try again.';
                if (error.name === 'AbortError') {
                    msg = 'Analysis timed out. Please try again with a smaller image.';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    msg = 'Could not connect to the analysis service. The Cloud Function may need to be deployed. Please check Firebase deployment.';
                }
                alert(msg);
                document.getElementById('coachHome').style.display = '';
                document.getElementById('coachAnalyzing').style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        function renderCoachResult(result) {
            const analysis = result.analysis;

            // Set before image
            document.getElementById('coachBeforeImg').src = 'data:image/jpeg;base64,' + coachPhotoBase64;

            // Set after image (might not exist if DALL-E failed)
            const afterImg = document.getElementById('coachAfterImg');
            const afterCard = afterImg.closest('.coach-photo-card');
            if (result.afterImageUrl) {
                afterImg.src = result.afterImageUrl;
                afterImg.style.display = 'block';
                if (afterCard) afterCard.style.display = '';
            } else {
                afterImg.style.display = 'none';
                if (afterCard) afterCard.style.display = 'none';
            }

            // Encouragement
            document.getElementById('coachEncouragement').textContent = analysis.encouragement || '';

            // Steps
            const stepsEl = document.getElementById('coachSteps');
            stepsEl.innerHTML = (analysis.steps || []).map((step, i) => `
                <li class="coach-step">
                    <span class="coach-step-num">${i + 1}</span>
                    <span class="coach-step-text">${step.text}</span>
                    <span class="coach-step-time">${step.minutes}m</span>
                </li>
            `).join('');

            // Total time
            document.getElementById('coachTotalTime').textContent =
                `Total: ~${analysis.totalMinutes || 0} minutes`;

            // Tip
            document.getElementById('coachTipText').textContent = analysis.mainTip || '';

            // Update usage UI
            const userQuery2 = query(collection(db, 'users'), where('userId', '==', currentUserId));
            getDocs(userQuery2).then(snap => {
                if (!snap.empty) {
                    const sub = snap.docs[0].data().subscription || {};
                    updateCoachUsageUI(sub.status === 'active');
                }
            });

            // Show result screen
            document.getElementById('coachAnalyzing').style.display = 'none';
            document.getElementById('coachResult').style.display = 'block';
        }

        function resetCoach() {
            coachPhotoBase64 = '';
            coachPhotoFile = null;

            document.getElementById('coachHome').style.display = '';
            document.getElementById('coachAnalyzing').style.display = 'none';
            document.getElementById('coachResult').style.display = 'none';

            // Reset upload area
            document.getElementById('coachPreviewImg').style.display = 'none';
            document.getElementById('coachUploadPrompt').style.display = '';
            document.getElementById('coachTapOverlay').style.display = 'none';
            document.getElementById('coachUploadArea').classList.remove('has-photo');
            document.getElementById('coachAnalyzeBtn').disabled = true;
            document.getElementById('coachFileInput').value = '';

            // Reset after image card visibility for next analysis
            const afterImg = document.getElementById('coachAfterImg');
            if (afterImg) {
                const afterCard = afterImg.closest('.coach-photo-card');
                if (afterCard) afterCard.style.display = '';
            }

            loadCoachUsage();
        }

        function toggleCoachExamples() {
            const content = document.getElementById('coachExamplesContent');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        // --- Paywall Functions ---

        function openPaywall() {
            document.getElementById('coachPaywall').classList.add('show');
            switchBilling('yearly');
        }

        function closePaywall() {
            document.getElementById('coachPaywall').classList.remove('show');
        }

        function switchBilling(cycle) {
            coachBillingCycle = cycle;
            document.querySelectorAll('.coach-billing-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cycle === cycle);
            });

            const priceEl = document.getElementById('coachBillingPrice');
            const periodEl = document.getElementById('coachBillingPeriod');
            const detailEl = document.getElementById('coachBillingDetail');
            const ctaEl = document.getElementById('coachPaywallCta');

            if (cycle === 'yearly') {
                priceEl.textContent = '$29.99';
                periodEl.textContent = '/year';
                detailEl.textContent = '$2.50/mo';
                ctaEl.innerHTML = 'Start My Transformation &mdash; $29.99/year';
            } else {
                priceEl.textContent = '$3.99';
                periodEl.textContent = '/month';
                detailEl.textContent = '$47.88/year';
                ctaEl.innerHTML = 'Start My Transformation &mdash; $3.99/month';
            }
        }

        async function startSubscription() {
            try {
                const response = await fetch('https://us-central1-declutter-challenge-94366.cloudfunctions.net/createCheckout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        billingCycle: coachBillingCycle,
                        userId: currentUserId
                    })
                });
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Unable to start checkout. Please try again.');
                }
            } catch (error) {
                console.error('Subscription error:', error);
                alert('Unable to start checkout. Please try again.');
            }
        }

        function restorePurchase() {
            alert('Checking your subscription status...');
            loadCoachUsage();
            closePaywall();
        }

        // Expose AI Coach functions to global scope for inline HTML event handlers
        window.handleCoachPhoto = handleCoachPhoto;
        window.analyzeSpace = analyzeSpace;
        window.resetCoach = resetCoach;
        window.toggleCoachExamples = toggleCoachExamples;
        window.openPaywall = openPaywall;
        window.closePaywall = closePaywall;
        window.switchBilling = switchBilling;
        window.startSubscription = startSubscription;
        window.restorePurchase = restorePurchase;

        function showAchievement(title, subtitle, points) {
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementSubtitle').textContent = subtitle;
            document.getElementById('achievementPoints').textContent = `+${points} pts`;
            document.getElementById('achievementOverlay').classList.add('show');

            playVictorySound();
            spawnConfetti();
        }

        function hideAchievement() {
            document.getElementById('achievementOverlay').classList.remove('show');
        }

        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                const now = audioContext.currentTime;

                const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.12);
                    gain.gain.setValueAtTime(0.3, now + i * 0.12);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.12 + 0.2);
                    osc.start(now + i * 0.12);
                    osc.stop(now + i * 0.12 + 0.2);
                });
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        function spawnConfetti() {
            const colors = ['#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B', '#1C1C1E', '#6B6B6B'];
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 8 + 6) + 'px';
                confetti.style.height = (Math.random() * 8 + 6) + 'px';
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        async function saveBonusPoints(points) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore
                    });
                }
            } catch (error) {
                console.error('Bonus points save failed:', error);
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function hideLoginScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
        }

        function updateProfileUI() {
            const provider = localStorage.getItem('authProvider');

            // Update new profile header
            const profileName = document.getElementById('profileName');
            const profileProvider = document.getElementById('profileProvider');
            const profileAvatar = document.getElementById('profileAvatar');

            if (profileName) profileName.textContent = userName || 'User';
            if (profileProvider) profileProvider.textContent = provider === 'google' ? 'Google' : '';

            // Set avatar: profile photo or default person icon
            if (profileAvatar) {
                if (userProfilePhotoURL) {
                    profileAvatar.innerHTML = '';
                    profileAvatar.style.backgroundImage = `url(${userProfilePhotoURL})`;
                    profileAvatar.style.fontSize = '28px';
                } else {
                    profileAvatar.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>';
                    profileAvatar.style.backgroundImage = 'none';
                }
            }
        }

        function handleGoogleLoginSuccess(user) {
            currentUserId = 'google_' + user.uid;

            // Store auth data
            localStorage.setItem('userId', currentUserId);
            localStorage.setItem('authProvider', 'google');
            localStorage.setItem('userPhoto', user.photoURL || '');

            // Check if nickname exists
            const savedNickname = localStorage.getItem('userNickname_' + currentUserId);

            if (savedNickname) {
                // Existing user - use saved nickname
                userName = savedNickname;
                localStorage.setItem('userName', userName);
                updateProfileUI();
                hideLoginScreen();
                initApp();
            } else {
                // New user - must set nickname
                hideLoginScreen();
                showNicknameModal();
            }
        }

        async function handleGoogleLogin() {
            const btn = document.getElementById('googleLoginBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            try {
                const result = await signInWithPopup(auth, googleProvider);
                handleGoogleLoginSuccess(result.user);
            } catch (error) {
                if (error.code === 'auth/popup-blocked') {
                    // Fallback to redirect if popup is blocked
                    console.warn('Popup blocked, falling back to redirect...');
                    btn.textContent = 'Redirecting...';
                    try {
                        await signInWithRedirect(auth, googleProvider);
                    } catch (redirectError) {
                        console.error('Google login redirect failed:', redirectError);
                        alert('Login failed. Please try again.');
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                    }
                } else if (error.code === 'auth/cancelled-popup-request' || error.code === 'auth/popup-closed-by-user') {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                } else {
                    console.error('Google login failed:', error);
                    alert('Login failed. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            }
        }

        // Bind event listener (avoids onclick attribute ReferenceError when module loads async)
        document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);

        function showNicknameModal() {
            document.getElementById('nicknameModal').classList.add('show');
            document.getElementById('nicknameSetup').focus();
        }

        function hideNicknameModal() {
            document.getElementById('nicknameModal').classList.remove('show');
        }

        async function saveNickname() {
            const nickname = document.getElementById('nicknameSetup').value.trim();

            // Validation
            if (!nickname) {
                alert('Please enter a nickname!');
                return;
            }

            if (nickname.length < 2) {
                alert('Nickname must be at least 2 characters!');
                return;
            }

            if (nickname.length > 15) {
                alert('Nickname must be 15 characters or less!');
                return;
            }

            // Save nickname
            userName = nickname;
            localStorage.setItem('userNickname_' + currentUserId, nickname);
            localStorage.setItem('userName', nickname);

            // Update profile and start app
            updateProfileUI();
            hideNicknameModal();
            await updateUserProfile();
            await initApp();
        }

        document.getElementById('nicknameBtn').addEventListener('click', saveNickname);

        window.handleLogout = async function() {
            if (!confirm('Are you sure you want to logout?')) return;
            const provider = localStorage.getItem('authProvider');

            try {
                if (provider === 'google') {
                    await signOut(auth);
                }
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('authProvider');
            localStorage.removeItem('userPhoto');
            localStorage.removeItem('userProfilePhotoURL');
            currentUserId = null;
            userName = '';
            totalScore = 0;
            userProfilePhotoURL = '';
            userStreak = 0;
            userBadges = [];
            dreamVisionText = '';
            document.getElementById('dreamVisionCard').style.display = 'none';
            document.getElementById('dreamVisionLine').style.display = 'none';
            showLoginScreen();
        };

        // Settings bottom sheet functions
        window.openSettings = function() {
            const overlay = document.getElementById('settingsOverlay');
            const sheet = document.getElementById('settingsSheet');
            const input = document.getElementById('settingsNameInput');
            const saveBtn = document.getElementById('settingsSaveBtn');

            input.value = userName || '';
            saveBtn.style.display = 'none';
            saveBtn.textContent = 'Save';

            overlay.style.display = 'block';
            sheet.style.display = 'block';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    sheet.style.transform = 'translateX(-50%) translateY(0)';
                });
            });
        };

        window.closeSettings = function() {
            const sheet = document.getElementById('settingsSheet');
            sheet.style.transform = 'translateX(-50%) translateY(100%)';
            setTimeout(() => {
                document.getElementById('settingsOverlay').style.display = 'none';
                sheet.style.display = 'none';
            }, 300);
        };

        window.onSettingsNameInput = function() {
            const input = document.getElementById('settingsNameInput');
            const saveBtn = document.getElementById('settingsSaveBtn');
            const newName = input.value.trim();
            if (newName && newName !== userName && newName.length <= 20) {
                saveBtn.style.display = 'inline-block';
            } else {
                saveBtn.style.display = 'none';
            }
        };

        window.saveDisplayName = async function() {
            const input = document.getElementById('settingsNameInput');
            const saveBtn = document.getElementById('settingsSaveBtn');
            const newName = input.value.trim();

            if (!newName || newName.length > 20) return;
            if (newName === userName) return;

            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        name: newName
                    });
                }

                userName = newName;
                localStorage.setItem('userName', newName);
                localStorage.setItem('userNickname_' + currentUserId, newName);
                updateProfileUI();

                saveBtn.textContent = 'Saved!';
                saveBtn.style.display = 'inline-block';
                setTimeout(() => closeSettings(), 1000);
            } catch (error) {
                console.error('Display name update failed:', error);
            }
        };

        window.handleSettingsLogout = async function() {
            closeSettings();
            await handleLogout();
        };

        const categoryPoints = {
            'clothing': 10,
            'books': 15,
            'electronics': 20,
            'furniture': 30,
            'kitchenware': 10,
            'shoes': 10,
            'food': 5,
            'toys': 5,
            'digital': 5,
            'other': 5
        };

        const badges = {
            'first_item': { icon: '🎯', name: 'First Step', desc: 'First item decluttered', condition: (count) => count >= 1 },
            'five_items': { icon: '⭐', name: 'Passionate', desc: '5 items decluttered', condition: (count) => count >= 5 },
            'ten_items': { icon: '💎', name: 'Determined', desc: '10 items decluttered', condition: (count) => count >= 10 },
            'twenty_items': { icon: '👑', name: 'Declutter King', desc: '20 items decluttered', condition: (count) => count >= 20 },
            'streak_3': { icon: '🔥', name: 'Consistent', desc: '3 day streak', condition: (streak) => streak >= 3, isStreak: true },
            'streak_7': { icon: '💪', name: 'Habit', desc: '7 day streak', condition: (streak) => streak >= 7, isStreak: true },
            'streak_30': { icon: '🏅', name: 'Master', desc: '30 day streak', condition: (streak) => streak >= 30, isStreak: true }
        };

        // Username is now display-only in profile header (no editable input)

        async function updateUserProfile() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: 0,
                        itemCount: 0,
                        streak: 0,
                        lastDeclutterDate: null,
                        badges: [],
                        coachUsage: { month: '', count: 0 },
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Profile update failed:', error);
            }
        }

        async function generateAIEncouragement(itemName, category, points, totalScore, streak) {
            try {
                const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
                const itemsSnapshot = await getDocs(itemsQuery);
                
                const categoryCount = {};
                itemsSnapshot.forEach(doc => {
                    const data = doc.data();
                    categoryCount[data.category] = (categoryCount[data.category] || 0) + 1;
                });

                const response = await fetch('https://us-central1-declutter-challenge-94366.cloudfunctions.net/generateEncouragement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        itemName,
                        category: getCategoryName(category),
                        points,
                        totalScore,
                        streak,
                        categoryCount
                    })
                });

                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.message;
            } catch (error) {
                console.error('AI message generation failed:', error);
                const defaultMessages = [
                    "One less thing weighing you down ✨",
                    "Gone — space reclaimed 💪",
                    "Lighter already 🎈",
                    "That took courage 🌟",
                    "Released and free 🎯"
                ];
                return defaultMessages[Math.floor(Math.random() * defaultMessages.length)];
            }
        }

        function getCategoryName(category) {
            const categories = {
                clothing: '👕 Clothing',
                books: '📖 Books',
                electronics: '📱 Electronics',
                furniture: '🪑 Furniture',
                kitchenware: '🍽️ Kitchenware',
                shoes: '👟 Shoes',
                food: '🥫 Food',
                toys: '🧸 Toys',
                digital: '📄 Digital Docs',
                other: '📦 Other'
            };
            return categories[category] || '📦 Other';
        }

        function getSpaceDisplayName(spaceKey) {
            return spaceNames[spaceKey] || spaceKey;
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            if (diffSec < 60) return 'just now';
            const diffMin = Math.floor(diffSec / 60);
            if (diffMin < 60) return `${diffMin}m`;
            const diffHr = Math.floor(diffMin / 60);
            if (diffHr < 24) return `${diffHr}h`;
            const diffDay = Math.floor(diffHr / 24);
            return `${diffDay}d`;
        }

        // --- Tidy AI Coach: Helper functions for context gathering ---
        function getMostFrequent(items, field) {
            const counts = {};
            items.forEach(item => {
                const val = item[field];
                if (val) counts[val] = (counts[val] || 0) + 1;
            });
            let maxKey = null, maxCount = 0;
            for (const [key, count] of Object.entries(counts)) {
                if (count > maxCount) { maxCount = count; maxKey = key; }
            }
            return maxKey;
        }

        function getItemsThisWeek(items) {
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return items.filter(item => {
                const created = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt);
                return created >= weekAgo;
            }).length;
        }

        function formatRecentItemsList(recentItems) {
            return recentItems.map(item => {
                const created = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt);
                const daysAgo = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
                const spaceName = getSpaceDisplayName(item.space);
                const categoryName = getCategoryName(item.category);
                return `  - "${item.name}" (${categoryName}, ${spaceName}, ${daysAgo === 0 ? 'today' : daysAgo + 'd ago'})`;
            }).join('\n');
        }

        async function generateTidyComment(itemData) {
            console.log('[Tidy] generateTidyComment called', itemData.name);
            try {
                // Fetch user items — NO orderBy to avoid composite index requirement
                const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
                const itemsSnapshot = await getDocs(itemsQuery);
                console.log('[Tidy] Firestore query returned', itemsSnapshot.size, 'items');

                const allItems = itemsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // Sort by createdAt descending in JS (avoids Firestore composite index)
                allItems.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                    return bTime - aTime;
                });
                const totalItems = allItems.length;

                // Recent items (last 7)
                const recentItems = allItems.slice(0, 7);
                const recentItemsList = formatRecentItemsList(recentItems);

                // Pattern detection
                const topSpace = getMostFrequent(recentItems, 'space');
                const topCategory = getMostFrequent(recentItems, 'category');
                const itemsThisWeek = getItemsThisWeek(allItems);
                const topSpaceName = topSpace ? getSpaceDisplayName(topSpace) : 'N/A';
                const topCategoryName = topCategory ? getCategoryName(topCategory) : 'N/A';

                // User context
                const userVision = dreamVisionText || '';
                const currentStreak = userStreak || 0;
                const totalPoints = totalScore || 0;

                const spaceName = getSpaceDisplayName(itemData.space);
                const categoryName = getCategoryName(itemData.category);
                const hasBA = itemData.hasBeforeAfter;
                const itemNote = itemData.note && itemData.note.trim() ? itemData.note.trim() : '';

                // --- Tidy AI Coach System Prompt ---
                const tidySystemPrompt = `You are Tidy, an expert decluttering coach who has deeply internalized the methodologies of the world's leading organizing experts.

YOUR KNOWLEDGE BASE:
- Marie Kondo (KonMari): 'Does it spark joy?' Category-by-category method (clothes → books → papers → komono → sentimental). Folding, vertical storage, thanking items before releasing them.
- Dana K. White ('Decluttering at the Speed of Life'): Container concept — 'where does this LIVE?' and 'does it have a home?' Practical for busy families. Flat surfaces as danger zones.
- The Minimalists (Joshua Fields Millburn): 90/90 rule (used in last 90 days? will use in next 90?). Everything in, nothing out first.
- Margareta Magnusson (Swedish Death Cleaning / Döstädning): Long-term sustainability, not burdening others with your stuff.
- Peter Walsh: Envision the life you want, then edit possessions to match that vision.

YOUR COACHING STYLE:
- Never give generic advice like 'start small' or 'one step at a time'
- Always reference the user's specific situation: their space, item, emotional state
- Reference specific techniques from the methods above when relevant
- Acknowledge emotional difficulty — letting go has real psychological weight
- Be warm and direct. Ban phrases: 'Amazing!', 'Great job!', 'You've got this!'
- When someone is stuck, diagnose WHY: fear of waste? Sentimental attachment? Decision fatigue? Then address that specific block
- Always end with ONE concrete physical next action, not a vague goal
- Respond in the same language the user writes in (Korean if they write Korean)

NOTE HANDLING:
- If the user wrote a note about the item, treat it as the most important signal
- Notes reveal emotional attachment, guilt, hesitation, or reasoning — read between the lines
- Example: 'gift from mom but never use' → address the guilt of releasing a gift specifically
- Example: 'bought expensive but wrong size' → address sunk cost fallacy directly
- Example: 'not sure' → they're on the fence, help them decide with the 90/90 rule or spark joy test
- Always reference what they wrote ('You mentioned this was a gift...') so they feel heard

CONTEXT RULES:
- If user vision is provided, tie your advice back to it
- If streak/history is provided, acknowledge their momentum specifically
- If a photo is provided, start by describing what you actually see before advising

RESPONSE RULES:
- Follow the LENGTH MODE specified in the task instruction:
  SHORT MODE: Under 8 words + 1 emoji. Like a friend's quick text — warm, specific, not generic. React to something real: their note, the item, a pattern, a milestone. Examples of the right vibe: "Gift guilt released — proud of you 💛", "5th item this week! 🔥", "Closet breathing again ✨", "That sunk cost is gone now 🙌"
  DETAILED MODE: 2-3 sentences max + 1 emoji. Full coaching response with specific references.
- NEVER suggest buying storage bins, containers, organizers, shelves, or ANY product
- NEVER recommend shopping or purchases — this is a minimalism app
- Notice PATTERNS (e.g., "kitchen streak this week!" or "3rd clothing item")
- Celebrate MILESTONES (every 5 items, streak at 3/7/14/30 days, points at 50/100/200/500)
- Reference their history naturally
- NEVER be generic — ALWAYS reference something specific about THIS person
- If user wrote a note, SHORT MODE should react to that note specifically
- If item has before & after photos (DETAILED MODE only): celebrate effort, then give ONE maintenance tip using HABITS (not products). Good tips: "one in one out", rearrange by frequency, weekly 5-min reset, folding methods, clear surfaces, group similar items
- If no before & after photos (DETAILED MODE only): just encourage and celebrate — do NOT give tips or suggestions`;

                // --- Build user context message ---
                const userContext = [
                    userVision ? 'Dream home vision: ' + userVision : '',
                    currentStreak ? 'Current streak: ' + currentStreak + ' days' : '',
                    categoryName ? 'Category: ' + categoryName : '',
                    spaceName ? 'Space: ' + spaceName : '',
                    itemNote ? 'User note about this item: ' + itemNote : ''
                ].filter(Boolean).join('\n');

                const historyBlock = `USER'S HISTORY:
- Total items decluttered: ${totalItems}
- Total points: ${totalPoints}
- Items this week: ${itemsThisWeek}
- Most cleared space lately: ${topSpaceName}
- Most cleared category lately: ${topCategoryName}
- Recent items:
${recentItemsList}`;

                const itemBlock = hasBA
                    ? `JUST NOW they decluttered WITH before & after photos:
- Item: ${itemData.name}
- Category: ${categoryName}
- Space: ${spaceName}
- Points earned: ${itemData.points} + 30 bonus for B&A`
                    : `JUST NOW they decluttered:
- Item: ${itemData.name}
- Category: ${categoryName}
- Space: ${spaceName}
- Points earned: ${itemData.points}`;

                // 80% short (<8 words), 20% detailed
                const shortMode = Math.random() < 0.8;

                let task;
                if (shortMode) {
                    task = `LENGTH MODE: SHORT. Write a punchy reaction UNDER 8 WORDS + 1 emoji.
Must reference something specific: ${itemNote ? 'their note ("' + itemNote + '"), ' : ''}the item, a pattern, or a milestone.
Do NOT be generic. React to what makes THIS declutter unique.`;
                } else if (hasBA) {
                    task = 'LENGTH MODE: DETAILED. Write a personalized comment with ONE practical maintenance tip (2-3 sentences max).';
                } else {
                    task = 'LENGTH MODE: DETAILED. Write a short, personalized comment (2-3 sentences max).';
                }

                const prompt = [userContext, historyBlock, itemBlock, task].join('\n\n');

                console.log('[Tidy] Calling Cloud Function with prompt length:', prompt.length, 'mode:', shortMode ? 'SHORT' : 'DETAILED');
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 15000);
                const response = await fetch('https://us-central1-declutter-challenge-94366.cloudfunctions.net/generateTidyCommentHTTP', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ system: tidySystemPrompt, prompt, maxTokens: shortMode ? 60 : 200 }),
                    signal: controller.signal
                });
                clearTimeout(timeout);
                console.log('[Tidy] Cloud Function response status:', response.status);
                if (!response.ok) throw new Error('Function returned ' + response.status);
                const result = await response.json();
                console.log('[Tidy] Cloud Function returned text:', result.text ? result.text.substring(0, 50) + '...' : 'null');
                return result.text;
            } catch (error) {
                console.error('[Tidy] Comment generation failed:', error.name, error.message);
                return null;
            }
        }

        async function calculateStreak() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const lastDate = userData.lastDeclutterDate?.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (lastDate) {
                        const lastDateOnly = new Date(lastDate);
                        lastDateOnly.setHours(0, 0, 0, 0);
                        
                        const diffTime = today - lastDateOnly;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            userStreak = userData.streak || 0;
                        } else if (diffDays === 1) {
                            userStreak = (userData.streak || 0) + 1;
                        } else {
                            userStreak = 1;
                        }
                    } else {
                        userStreak = 1;
                    }
                    
                    await updateDoc(doc(db, 'users', userSnapshot.docs[0].id), {
                        streak: userStreak,
                        lastDeclutterDate: serverTimestamp()
                    });
                    
                    const streakBadge = document.getElementById('streakBadge');
                    if (streakBadge) streakBadge.textContent = `${userStreak} Day Streak`;
                    updateHeaderStats();
                    checkBadges(null, userStreak);
                }
            } catch (error) {
                console.error('Streak calculation failed:', error);
            }
        }

        async function checkBadges(itemCount = null, streak = null) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    userBadges = userData.badges || [];
                    
                    const currentCount = itemCount !== null ? itemCount : userData.itemCount || 0;
                    const currentStreak = streak !== null ? streak : userData.streak || 0;
                    
                    for (const [key, badge] of Object.entries(badges)) {
                        if (!userBadges.includes(key)) {
                            const earned = badge.isStreak 
                                ? badge.condition(currentStreak)
                                : badge.condition(currentCount);
                                
                            if (earned) {
                                userBadges.push(key);
                                await updateDoc(doc(db, 'users', userDoc.id), {
                                    badges: arrayUnion(key)
                                });
                                showBadgeModal(badge);
                            }
                        }
                    }
                    
                    renderBadges();
                }
            } catch (error) {
                console.error('Badge check failed:', error);
            }
        }

        function renderBadges() {
            const earnedCount = userBadges.length;
            const totalCount = Object.keys(badges).length;

            // Update hidden compat elements
            const badgeCountEl = document.getElementById('badgeCount');
            if (badgeCountEl) badgeCountEl.textContent = earnedCount;

            // Update modal progress
            document.getElementById('badgesProgress').textContent = `${earnedCount}/${totalCount}`;

            // Render header badges (show first 3 earned)
            renderHeaderBadges();

            // Render modal badge list
            renderBadgesModal();
        }

        function renderHeaderBadges() {
            const badgesDisplay = document.getElementById('badgesDisplay');
            if (!badgesDisplay) return;

            const earnedBadges = userBadges;

            let html = '';

            earnedBadges.forEach(badgeKey => {
                const badge = badges[badgeKey];
                if (badge) {
                    html += `<div class="badge-item" title="${badge.name}" onclick="showBadgesModal()"><span class="badge-icon">${badge.icon}</span></div>`;
                }
            });

            html += `<button class="view-all-badges" title="View All Badges" onclick="showBadgesModal()">…</button>`;

            badgesDisplay.innerHTML = html;

            console.log('Badges rendered:', earnedBadges.length);
        }

        function renderBadgesModal() {
            const badgesList = document.getElementById('badgesList');
            if (!badgesList) return;
            const earnedCount = userBadges.length;
            const totalCount = Object.keys(badges).length;

            document.getElementById('badgesProgress').textContent = `${earnedCount}/${totalCount}`;

            badgesList.innerHTML = Object.entries(badges).map(([key, badge]) => {
                const earned = userBadges.includes(key);
                return `
                    <div class="badge-list-item ${earned ? 'earned' : 'locked'}">
                        <div class="badge-list-icon">${badge.icon}</div>
                        <div class="badge-list-info">
                            <div class="badge-list-name">${badge.name}</div>
                            <div class="badge-list-desc">${badge.desc}</div>
                        </div>
                        <div class="badge-list-status">${earned ? '✅' : '🔒'}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleBadgeDrawer() {
            const drawer = document.getElementById('badgesDrawer');
            if (drawer) {
                drawer.classList.toggle('open');
            }
        }

        function showBadgesModal() {
            renderBadgesModal();
            document.getElementById('badgesOverlay').classList.add('show');
        }

        function closeBadgesModal() {
            document.getElementById('badgesOverlay').classList.remove('show');
        }

        // Keep backward compat alias
        function hideBadgesModal() {
            closeBadgesModal();
        }

        function updateHeaderStats() {
            const headerScore = document.getElementById('headerScore');
            const headerStreak = document.getElementById('headerStreak');
            const headerItems = document.getElementById('headerItems');
            if (headerScore) headerScore.textContent = totalScore;
            if (headerStreak) headerStreak.textContent = userStreak;
        }

        function showBadgeModal(badge) {
            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalTitle').textContent = `${badge.name} Badge Earned!`;
            document.getElementById('badgeModalDesc').textContent = badge.desc;
            document.getElementById('badgeModal').classList.add('show');
            document.getElementById('badgeOverlay').classList.add('show');
        }

        window.closeBadgeModal = function() {
            document.getElementById('badgeModal').classList.remove('show');
            document.getElementById('badgeOverlay').classList.remove('show');
        };

        window.showBadgesModal = showBadgesModal;
        window.closeBadgesModal = closeBadgesModal;

        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.type = 'square';
                osc1.frequency.setValueAtTime(523.25, now);
                gain1.gain.setValueAtTime(0.3, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(659.25, now + 0.15);
                gain2.gain.setValueAtTime(0.3, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
                
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.type = 'square';
                osc3.frequency.setValueAtTime(783.99, now + 0.3);
                gain3.gain.setValueAtTime(0.3, now + 0.3);
                gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                osc3.start(now + 0.3);
                osc3.stop(now + 0.45);
                
                const osc4 = audioContext.createOscillator();
                const gain4 = audioContext.createGain();
                osc4.connect(gain4);
                gain4.connect(audioContext.destination);
                osc4.type = 'square';
                osc4.frequency.setValueAtTime(1046.50, now + 0.45);
                gain4.gain.setValueAtTime(0.35, now + 0.45);
                gain4.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc4.start(now + 0.45);
                osc4.stop(now + 0.9);
                
                const osc5 = audioContext.createOscillator();
                const gain5 = audioContext.createGain();
                osc5.connect(gain5);
                gain5.connect(audioContext.destination);
                osc5.type = 'sine';
                osc5.frequency.setValueAtTime(1318.51, now + 0.45);
                gain5.gain.setValueAtTime(0.2, now + 0.45);
                gain5.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc5.start(now + 0.45);
                osc5.stop(now + 0.9);
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        // Trash sound effect - Windows recycle bin style (0.7s total)
        function playTrashSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Resume audio context if suspended (required for mobile)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;

                // PHASE 1: WHOOSH - Item falling into trash (0-0.3s)
                const whoosh = audioContext.createOscillator();
                const whooshGain = audioContext.createGain();

                whoosh.connect(whooshGain);
                whooshGain.connect(audioContext.destination);

                // Falling pitch sweep
                whoosh.frequency.setValueAtTime(1200, now);
                whoosh.frequency.exponentialRampToValueAtTime(150, now + 0.3);
                whoosh.type = 'sine';

                // Volume envelope - fade in and out
                whooshGain.gain.setValueAtTime(0, now);
                whooshGain.gain.linearRampToValueAtTime(0.35, now + 0.05);
                whooshGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                whoosh.start(now);
                whoosh.stop(now + 0.3);

                // PHASE 2: CRUMPLE - Paper/item crushing (0.25s-0.5s)
                const noise = audioContext.createBufferSource();
                const noiseDuration = 0.25;
                const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * noiseDuration, audioContext.sampleRate);
                const noiseData = noiseBuffer.getChannelData(0);

                // Generate white noise with slight modulation
                for (let i = 0; i < noiseBuffer.length; i++) {
                    noiseData[i] = (Math.random() * 2 - 1) * (1 - i / noiseBuffer.length * 0.5);
                }

                noise.buffer = noiseBuffer;

                const noiseGain = audioContext.createGain();
                const noiseFilter = audioContext.createBiquadFilter();

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(audioContext.destination);

                // Filter sweep - crushing sound
                noiseFilter.type = 'bandpass';
                noiseFilter.frequency.setValueAtTime(2000, now + 0.25);
                noiseFilter.frequency.exponentialRampToValueAtTime(300, now + 0.5);
                noiseFilter.Q.value = 2;

                // Volume envelope
                noiseGain.gain.setValueAtTime(0.25, now + 0.25);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

                noise.start(now + 0.25);
                noise.stop(now + 0.5);

                // PHASE 3: IMPACT - Hitting bottom of bin (0.45s-0.65s)
                const impact1 = audioContext.createOscillator();
                const impact1Gain = audioContext.createGain();

                impact1.connect(impact1Gain);
                impact1Gain.connect(audioContext.destination);

                // Low thud
                impact1.frequency.setValueAtTime(120, now + 0.45);
                impact1.frequency.exponentialRampToValueAtTime(60, now + 0.65);
                impact1.type = 'sine';

                impact1Gain.gain.setValueAtTime(0.5, now + 0.45);
                impact1Gain.gain.exponentialRampToValueAtTime(0.01, now + 0.65);

                impact1.start(now + 0.45);
                impact1.stop(now + 0.65);

                // PHASE 4: SECONDARY BOUNCE - Small bounce/settle (0.55s-0.7s)
                const impact2 = audioContext.createOscillator();
                const impact2Gain = audioContext.createGain();

                impact2.connect(impact2Gain);
                impact2Gain.connect(audioContext.destination);

                // Lighter secondary impact
                impact2.frequency.setValueAtTime(180, now + 0.55);
                impact2.frequency.exponentialRampToValueAtTime(80, now + 0.7);
                impact2.type = 'sine';

                impact2Gain.gain.setValueAtTime(0.3, now + 0.55);
                impact2Gain.gain.exponentialRampToValueAtTime(0.01, now + 0.7);

                impact2.start(now + 0.55);
                impact2.stop(now + 0.7);
            } catch (error) {
                console.error('Trash sound playback failed:', error);
            }
        }

        function compressImage(file, maxDimension = 1600) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onerror = () => reject(new Error('Failed to read file'));

                reader.onload = (e) => {
                    const img = new Image();

                    img.onerror = () => reject(new Error('Failed to load image'));

                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = Math.round((height / width) * maxDimension);
                                width = maxDimension;
                            } else {
                                width = Math.round((width / height) * maxDimension);
                                height = maxDimension;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    resolve(new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    }));
                                } else {
                                    reject(new Error('Failed to compress image'));
                                }
                            },
                            'image/jpeg',
                            0.85
                        );
                    };

                    img.src = e.target.result;
                };

                reader.readAsDataURL(file);
            });
        }

        // ===== Before & After Functions =====

        window.toggleBeforeAfter = function() {
            baEnabled = !baEnabled;
            const chip = document.getElementById('baChip');
            const chipIcon = document.getElementById('baChipIcon');
            const bonusHint = document.getElementById('baBonusHint');
            const photoRow = document.getElementById('photoRow');
            const beforeSlot = document.getElementById('beforeSlot');
            const afterSlot = document.getElementById('afterSlot');
            const progressText = document.getElementById('baProgressText');

            if (baEnabled) {
                chip.classList.add('active');
                chipIcon.innerHTML = '&#10003;';
                bonusHint.style.display = 'none';
                photoRow.classList.add('ba-active');
                beforeSlot.style.display = 'flex';
                afterSlot.style.display = 'flex';
                progressText.style.display = '';
                updateBAProgress();
            } else {
                chip.classList.remove('active');
                chipIcon.innerHTML = '&#8853;';
                bonusHint.style.display = '';
                photoRow.classList.remove('ba-active');
                beforeSlot.style.display = 'none';
                afterSlot.style.display = 'none';
                progressText.style.display = 'none';
                // Reset B&A photos
                beforePhotoURL = '';
                afterPhotoURL = '';
                beforeSlot.classList.remove('has-photo');
                afterSlot.classList.remove('has-photo');
                document.getElementById('beforePreview').src = '';
                document.getElementById('afterPreview').src = '';
                progressText.textContent = 'Both for +30 bonus';
                progressText.classList.remove('complete');
            }
            updateBonusBadge();
        };

        function updateBAProgress() {
            const progressText = document.getElementById('baProgressText');
            const hasBefore = !!beforePhotoURL;
            const hasAfter = !!afterPhotoURL;

            if (hasBefore && hasAfter) {
                progressText.innerHTML = '&#9989; +30 bonus!';
                progressText.classList.add('complete');
                progressText.style.color = '#4CAF50';
            } else if (hasBefore) {
                progressText.innerHTML = 'Add Cleared &#128248;';
                progressText.classList.remove('complete');
                progressText.style.color = '#999';
            } else if (hasAfter) {
                progressText.innerHTML = 'Add Cluttered &#128248;';
                progressText.classList.remove('complete');
                progressText.style.color = '#999';
            } else {
                progressText.textContent = 'Both for +30 bonus';
                progressText.classList.remove('complete');
                progressText.style.color = '#999';
            }
            updateBonusBadge();
        }

        function updateBonusBadge() {
            const badge = document.getElementById('bonusBadge');
            if (!badge) return;
            if (baEnabled) {
                badge.style.display = 'inline-block';
                if (beforePhotoURL && afterPhotoURL) {
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            } else {
                badge.style.display = 'none';
                badge.classList.remove('active');
            }
        }

        async function uploadBAPhoto(file, slotType) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                return;
            }
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Image is too large! Please choose an image smaller than 10MB.');
                return;
            }
            if (!currentUserId) {
                alert('You must be logged in to upload photos!');
                return;
            }

            const slot = document.getElementById(slotType === 'before' ? 'beforeSlot' : 'afterSlot');
            const preview = document.getElementById(slotType === 'before' ? 'beforePreview' : 'afterPreview');

            try {
                let fileToUpload = file;
                if (file.size > 1024 * 1024) {
                    fileToUpload = await compressImage(file);
                }
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substring(2, 9);
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileName = `${slotType}_${timestamp}_${randomId}.${fileExtension}`;
                const storagePath = `items/${currentUserId}/${fileName}`;
                const storageRef = ref(storage, storagePath);
                const snapshot = await uploadBytes(storageRef, fileToUpload);
                const downloadURL = await getDownloadURL(snapshot.ref);

                if (slotType === 'before') {
                    beforePhotoURL = downloadURL;
                } else {
                    afterPhotoURL = downloadURL;
                }
                preview.src = downloadURL;
                slot.classList.add('has-photo');
                updateBAProgress();
            } catch (error) {
                console.error('B&A upload failed:', error);
                alert('Upload failed! Please try again.');
            }
        }

        document.getElementById('beforeFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            await uploadBAPhoto(file, 'before');
            this.value = '';
        });

        document.getElementById('afterFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            await uploadBAPhoto(file, 'after');
            this.value = '';
        });

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                return;
            }

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Image is too large! Please choose an image smaller than 10MB.');
                return;
            }

            if (!currentUserId) {
                alert('You must be logged in to upload photos!');
                return;
            }

            const preview = document.getElementById('previewImage');
            const uploadArea = document.getElementById('uploadArea');
            const uploadPrompt = document.getElementById('uploadPlaceholder');

            uploadPrompt.innerHTML = '<div class="upload-icon-svg"><svg width="50" height="50" viewBox="0 0 50 50" fill="none"><circle cx="25" cy="25" r="23" stroke="#6B6B6B" stroke-width="2.5"/><line x1="12" y1="25" x2="38" y2="25" stroke="#6B6B6B" stroke-width="3" stroke-linecap="round"/></svg></div><div class="upload-text">Uploading...</div>';

            try {
                let fileToUpload = file;
                if (file.size > 1024 * 1024) {
                    fileToUpload = await compressImage(file);
                }

                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substring(2, 9);
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileName = `${timestamp}_${randomId}.${fileExtension}`;

                const storagePath = `items/${currentUserId}/${fileName}`;
                const storageRef = ref(storage, storagePath);

                const snapshot = await uploadBytes(storageRef, fileToUpload);
                const downloadURL = await getDownloadURL(snapshot.ref);

                currentPhotoURL = downloadURL;
                updateSubmitButton();

                preview.src = downloadURL;
                preview.classList.add('show');
                uploadPrompt.style.display = 'none';
                uploadArea.classList.add('has-image');

                // Show B&A chip container with fade-in-up animation
                const baChipContainer = document.getElementById('baChipContainer');
                if (baChipContainer && baChipContainer.style.display === 'none') {
                    baChipContainer.style.display = 'flex';
                    requestAnimationFrame(() => {
                        baChipContainer.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
                        baChipContainer.style.transform = 'translateY(12px)';
                        requestAnimationFrame(() => {
                            baChipContainer.style.opacity = '1';
                            baChipContainer.style.transform = 'translateY(0)';
                        });
                    });
                }

            } catch (error) {
                console.error('Upload failed:', error);

                uploadPrompt.innerHTML = '<div class="upload-icon-svg"><svg width="32" height="32" viewBox="0 0 50 50" fill="none"><circle cx="25" cy="25" r="23" stroke="#6B6B6B" stroke-width="2.5"/><line x1="12" y1="25" x2="38" y2="25" stroke="#6B6B6B" stroke-width="3" stroke-linecap="round"/></svg></div><div class="upload-text">Item Photo</div>';
                uploadPrompt.style.display = '';

                let errorMsg = 'Upload failed! ';
                if (error.code === 'storage/unauthorized') {
                    errorMsg += 'Permission denied. Storage rules need to be updated in Firebase Console.';
                } else if (error.code === 'storage/canceled') {
                    errorMsg += 'Upload was canceled.';
                } else if (error.code === 'storage/unknown') {
                    errorMsg += 'Network error. Please check your internet connection.';
                } else if (error.code === 'storage/retry-limit-exceeded') {
                    errorMsg += 'Upload timeout. Please try again.';
                } else {
                    errorMsg += 'Please try again. Error: ' + error.message;
                }
                alert(errorMsg);
            }
        });

        document.getElementById('itemCategory').addEventListener('change', function(e) {
            const pointsInfo = document.getElementById('pointsInfo');
            const expectedPoints = document.getElementById('expectedPoints');

            if (e.target.value) {
                expectedPoints.textContent = categoryPoints[e.target.value];
                pointsInfo.style.display = 'block';
                updateBonusBadge();
            } else {
                pointsInfo.style.display = 'none';
            }
            updateSubmitButton();
        });

        document.getElementById('itemSpace').addEventListener('change', function() {
            updateSubmitButton();
        });

        function updateSubmitButton() {
            const photo = !!currentPhotoURL;
            const name = !!document.getElementById('itemName').value.trim();
            const category = !!document.getElementById('itemCategory').value;
            const space = !!document.getElementById('itemSpace').value;
            document.getElementById('submitBtn').disabled = !(photo && name && category && space);
        }
        window.updateSubmitButton = updateSubmitButton;

        window.addItem = async function() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const space = document.getElementById('itemSpace').value;
            const note = document.getElementById('itemNote').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!name) {
                alert('Please enter item name!');
                return;
            }

            if (!category) {
                alert('Please select a category!');
                return;
            }

            if (!space) {
                alert('Please select a space!');
                return;
            }

            // Item Photo is required
            if (!currentPhotoURL) {
                alert('Please upload an item photo!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            try {
                const basePoints = categoryPoints[category] || 5;
                const hasBeforeAfter = baEnabled && !!beforePhotoURL && !!afterPhotoURL;
                const bonusPoints = hasBeforeAfter ? 30 : 0;
                const points = basePoints + bonusPoints;

                const itemData = {
                    userId: currentUserId,
                    userName: userName,
                    userPhotoURL: userProfilePhotoURL || null,
                    name: name,
                    category: category,
                    space: space,
                    note: note,
                    image: currentPhotoURL,
                    points: points,
                    likes: [],
                    likeCount: 0,
                    comments: [],
                    hasBeforeAfter: hasBeforeAfter,
                    beforePhotoURL: hasBeforeAfter ? beforePhotoURL : null,
                    afterPhotoURL: hasBeforeAfter ? afterPhotoURL : null,
                    bonusPoints: bonusPoints,
                    createdAt: serverTimestamp()
                };

                const itemDocRef = await addDoc(collection(db, 'items'), itemData);

                totalScore += points;
                await updateUserScore();
                await calculateStreak();

                playTrashSound();
                playSuccessSound();

                const aiMessage = await generateAIEncouragement(name, category, points, totalScore, userStreak);

                // Tidy AI Coach comment: Firestore onCreate trigger generates it server-side,
                // but also call client-side as fallback (in case trigger doesn't fire).
                // The duplicate check in the trigger prevents double comments.
                generateTidyComment(itemData).then(async (tidyText) => {
                    if (tidyText) {
                        try {
                            // Check if trigger already added a comment
                            const freshDoc = await getDocs(query(collection(db, 'items'), where('__name__', '==', itemDocRef.id)));
                            if (!freshDoc.empty) {
                                const freshData = freshDoc.docs[0].data();
                                const hasAI = (freshData.comments || []).some(c => c.isAI);
                                if (hasAI) {
                                    console.log('[Tidy] Trigger already added comment, skipping client-side');
                                    return;
                                }
                            }
                            await updateDoc(itemDocRef, {
                                comments: arrayUnion({
                                    userName: 'Tidy',
                                    authorAvatar: '🏠',
                                    isAI: true,
                                    text: tidyText,
                                    createdAt: new Date().toISOString()
                                })
                            });
                            console.log('[Tidy] Client-side comment saved to Firestore');
                        } catch (err) {
                            console.error('[Tidy] Failed to save client-side comment:', err);
                        }
                    }
                }).catch(err => {
                    console.error('[Tidy] Client-side comment generation failed:', err);
                });

                // Reset form
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemSpace').value = '';
                document.getElementById('itemNote').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('previewImage').classList.remove('show');
                const uploadPrompt = document.getElementById('uploadPlaceholder');
                uploadPrompt.innerHTML = '<div class="upload-icon-svg"><svg width="32" height="32" viewBox="0 0 50 50" fill="none"><circle cx="25" cy="25" r="23" stroke="#6B6B6B" stroke-width="2.5"/><line x1="12" y1="25" x2="38" y2="25" stroke="#6B6B6B" stroke-width="3" stroke-linecap="round"/></svg></div><div class="upload-text">Item Photo</div>';
                uploadPrompt.style.display = 'block';
                document.getElementById('uploadArea').classList.remove('has-image');
                document.getElementById('uploadArea').style.display = '';
                document.getElementById('pointsInfo').style.display = 'none';
                document.getElementById('spaceHint').style.display = 'none';
                currentPhotoURL = '';

                // Reset B&A state
                baEnabled = false;
                beforePhotoURL = '';
                afterPhotoURL = '';
                document.getElementById('baChip').classList.remove('active');
                document.getElementById('baChipIcon').innerHTML = '&#8853;';
                document.getElementById('baBonusHint').style.display = '';
                document.getElementById('photoRow').classList.remove('ba-active');
                document.getElementById('beforeSlot').style.display = 'none';
                document.getElementById('afterSlot').style.display = 'none';
                document.getElementById('beforeSlot').classList.remove('has-photo');
                document.getElementById('afterSlot').classList.remove('has-photo');
                document.getElementById('beforePreview').src = '';
                document.getElementById('afterPreview').src = '';
                document.getElementById('baProgressText').textContent = 'Both for +30 bonus';
                document.getElementById('baProgressText').style.display = 'none';
                document.getElementById('baProgressText').classList.remove('complete');
                document.getElementById('bonusBadge').style.display = 'none';
                // Hide B&A chip container until next item photo is uploaded
                const baChipContainer = document.getElementById('baChipContainer');
                if (baChipContainer) {
                    baChipContainer.style.display = 'none';
                    baChipContainer.style.opacity = '0';
                }

                const bonusMsg = hasBeforeAfter ? ` (includes +30 B&A bonus!)` : '';
                alert(`+${points} pts earned!${bonusMsg}\n\n${aiMessage}\n\nTotal: ${totalScore} pts`);

                switchTab('history');
            } catch (error) {
                console.error('Item add failed:', error);
                alert('Upload failed! Please try again.');
            } finally {
                submitBtn.textContent = 'Done!';
                updateSubmitButton();
            }
        };

        async function updateUserScore() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newItemCount = (userData.itemCount || 0) + 1;
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore,
                        itemCount: newItemCount,
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(newItemCount);
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: totalScore,
                        itemCount: 1,
                        streak: 0,
                        badges: [],
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(1);
                }
                
                document.getElementById('totalScore').textContent = totalScore;
                    updateHeaderStats();
            } catch (error) {
                console.error('Score update failed:', error);
            }
        }

        window.toggleLike = async function(itemId, itemDocId) {
            try {
                const itemRef = doc(db, 'items', itemDocId);
                const itemDoc = await getDocs(query(collection(db, 'items'), where('__name__', '==', itemDocId)));
                
                if (!itemDoc.empty) {
                    const itemData = itemDoc.docs[0].data();
                    const likes = itemData.likes || [];
                    
                    if (likes.includes(currentUserId)) {
                        await updateDoc(itemRef, {
                            likes: arrayRemove(currentUserId),
                            likeCount: increment(-1)
                        });
                    } else {
                        await updateDoc(itemRef, {
                            likes: arrayUnion(currentUserId),
                            likeCount: increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error('Like failed:', error);
            }
        };

        window.toggleComments = function(itemId) {
            const commentsSection = document.getElementById(`comments-${itemId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('show');
            }
        };

        window.addComment = async function(itemId, itemDocId) {
            const input = document.getElementById(`comment-input-${itemId}`);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            try {
                const itemRef = doc(db, 'items', itemDocId);
                await updateDoc(itemRef, {
                    comments: arrayUnion({
                        userId: currentUserId,
                        userName: userName,
                        userPhotoURL: userProfilePhotoURL || null,
                        text: commentText,
                        createdAt: new Date().toISOString()
                    })
                });
                
                input.value = '';
            } catch (error) {
                console.error('Comment add failed:', error);
            }
        };

        window.deleteItem = async function(itemDocId, itemUserId, itemPoints) {
            if (itemUserId !== currentUserId) {
                alert('You can only delete your own items!');
                return;
            }

            if (!confirm('Are you sure you want to delete?')) {
                return;
            }

            try {
                const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

                // Find item in feed to get full data (space, createdAt)
                const feedItem = allFeedItems.find(i => i.docId === itemDocId);
                const itemSpace = feedItem ? feedItem.space : null;
                const itemCreatedAt = feedItem && feedItem.createdAt ? feedItem.createdAt.toDate() : null;

                await deleteDoc(doc(db, 'items', itemDocId));

                // --- Update user score, item count, and streak ---
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newScore = Math.max(0, (userData.score || 0) - itemPoints);
                    const newItemCount = Math.max(0, (userData.itemCount || 0) - 1);

                    // --- Recalculate streak ---
                    let newStreak = userData.streak || 0;
                    let newLastDeclutterDate = userData.lastDeclutterDate;

                    if (itemCreatedAt) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const itemDate = new Date(itemCreatedAt);
                        itemDate.setHours(0, 0, 0, 0);

                        if (itemDate.getTime() === today.getTime()) {
                            // Check if there are other items from today
                            const todayItems = allFeedItems.filter(i => {
                                if (i.docId === itemDocId) return false;
                                if (i.userId !== currentUserId) return false;
                                const d = i.createdAt ? i.createdAt.toDate() : null;
                                if (!d) return false;
                                const day = new Date(d);
                                day.setHours(0, 0, 0, 0);
                                return day.getTime() === today.getTime();
                            });

                            if (todayItems.length === 0) {
                                // No other items today — find most recent previous item
                                const previousItems = allFeedItems.filter(i => {
                                    if (i.docId === itemDocId) return false;
                                    if (i.userId !== currentUserId) return false;
                                    const d = i.createdAt ? i.createdAt.toDate() : null;
                                    if (!d) return false;
                                    const day = new Date(d);
                                    day.setHours(0, 0, 0, 0);
                                    return day.getTime() < today.getTime();
                                }).sort((a, b) => {
                                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                    return dateB - dateA;
                                });

                                if (previousItems.length > 0) {
                                    newLastDeclutterDate = previousItems[0].createdAt;
                                    newStreak = Math.max(0, newStreak - 1);
                                } else {
                                    newLastDeclutterDate = null;
                                    newStreak = 0;
                                }
                            }
                        }
                    }

                    userStreak = newStreak;

                    const updateData = {
                        score: newScore,
                        itemCount: newItemCount,
                        streak: newStreak
                    };
                    if (newLastDeclutterDate === null) {
                        updateData.lastDeclutterDate = null;
                    } else if (newLastDeclutterDate !== userData.lastDeclutterDate) {
                        updateData.lastDeclutterDate = newLastDeclutterDate;
                    }

                    await updateDoc(doc(db, 'users', userDoc.id), updateData);

                    totalScore = newScore;
                    document.getElementById('totalScore').textContent = totalScore;
                    const streakBadge = document.getElementById('streakBadge');
                    if (streakBadge) streakBadge.textContent = `${userStreak} Day Streak`;
                    updateHeaderStats();
                }

                alert('Deleted!');
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Delete failed. Please try again.');
            }
        };

        // Feed filter — 3-tab segment (All / You / Before & After)
        let youShareMode = false;
        let youSelectedItems = [];

        window.setFeedFilter = function(filter) {
            currentFeedFilter = filter;
            // Update segment buttons
            document.getElementById('segAll').classList.toggle('active', filter === 'all');
            document.getElementById('segYou').classList.toggle('active', filter === 'you');
            document.getElementById('segBA').classList.toggle('active', filter === 'ba');
            // Show/hide tab content
            document.getElementById('feedContentAll').classList.toggle('active', filter === 'all');
            document.getElementById('feedContentYou').classList.toggle('active', filter === 'you');
            document.getElementById('feedContentBA').classList.toggle('active', filter === 'ba');

            if (filter === 'all') {
                renderFeedItems();
            } else if (filter === 'you') {
                renderYouTab();
            } else if (filter === 'ba') {
                renderBAItems();
            }
        };

        function renderComment(c) {
            if (c.isAI) {
                const timeStr = c.createdAt ? getRelativeTime(new Date(c.createdAt)) : '';
                return `
                    <div class="comment tidy-comment">
                        <div class="tidy-comment-header">
                            <div class="tidy-avatar"><img src="./images/tidy-coach.png" alt="Tidy" style="width:26px; height:26px; border-radius:50%; object-fit:cover;" /></div>
                            <span class="tidy-name">Tidy</span>
                            <span class="tidy-badge">AI COACH</span>
                            <span class="tidy-comment-time">${timeStr}</span>
                        </div>
                        <div class="tidy-comment-text">${c.text}</div>
                    </div>`;
            }
            const commentAvatar = getUserAvatarHTML(c.userName, c.userPhotoURL, 26);
            return `
                <div class="comment comment-with-avatar">
                    ${commentAvatar}
                    <div class="comment-body">
                        <div class="comment-author">${c.userName}</div>
                        <div class="comment-text">${c.text}</div>
                    </div>
                </div>`;
        }

        function renderFeedItems() {
            const listElement = document.getElementById('itemList');
            const items = allFeedItems;

            if (items.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📦</div>
                        <div>No items yet</div>
                        <div style="font-size: 14px; margin-top: 10px;">Declutter your first item!</div>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = items.map(item => {
                const date = item.createdAt?.toDate() || new Date();
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isMyItem = item.userId === currentUserId;
                const isLiked = (item.likes || []).includes(currentUserId);
                const likeCount = item.likeCount || 0;
                const comments = item.comments || [];
                const hasNote = item.note && item.note.trim();
                const isBA = item.hasBeforeAfter;
                const basePoints = (item.points || 0) - (item.bonusPoints || 0);
                const feedAvatar = getUserAvatarHTML(item.userName, item.userPhotoURL, 30);

                if (isBA) {
                    // B&A Compact Card — collapsed looks like normal card, same size
                    return `
                        <div class="item ba-item" style="${isMyItem ? 'background: #FAFAFA;' : ''}">
                            <div class="item-header">
                                <div class="ba-thumb-wrap" onclick="toggleBASlider('${item.id}')">
                                    <img src="${item.image}" alt="${item.name}" class="item-image">
                                    <div class="ba-thumb-badge">
                                        <span class="ba-photo-badge-icon"><span class="half-warm"></span><span class="half-green"></span></span>
                                        B&A
                                    </div>
                                </div>
                                <div class="item-info">
                                    <div class="item-name">${item.name} <span class="ba-badge">B&A</span></div>
                                    <div class="item-date" style="display:flex;align-items:center;gap:6px;">${feedAvatar} ${item.userName || 'Anonymous'} &bull; ${dateStr}</div>
                                    ${hasNote ? `<div class="item-note">"${item.note}"</div>` : ''}
                                </div>
                                <div class="ba-points-display">
                                    <span class="base-pts">+${basePoints}</span>
                                    <span class="bonus-pts">+${item.bonusPoints || 30} bonus</span>
                                </div>
                            </div>
                            <div class="ba-expand-section" id="ba-expand-${item.id}">
                                <div class="ba-expand-header">
                                    <span class="ba-expand-label">Before &amp; After</span>
                                    <button class="ba-expand-close" onclick="toggleBASlider('${item.id}')" aria-label="Close slider">&#10005;</button>
                                </div>
                                <div class="ba-slider-container" id="slider-${item.id}" style="--slider-pos: 80%"
                                     onpointerdown="startSlider(event, '${item.id}')"
                                     onpointermove="moveSlider(event, '${item.id}')"
                                     onpointerup="endSlider(event, '${item.id}')">
                                    <img src="${item.beforePhotoURL}" alt="Cluttered" class="ba-slider-before">
                                    <img src="${item.afterPhotoURL}" alt="Cleared" class="ba-slider-after">
                                    <div class="ba-slider-divider"></div>
                                    <div class="ba-slider-handle">&#9664; &#9654;</div>
                                    <div class="ba-slider-label left" id="label-left-${item.id}">CLUTTERED</div>
                                    <div class="ba-slider-label right" id="label-right-${item.id}">CLEARED</div>
                                    <div class="ba-slider-hint" id="hint-${item.id}"><span class="hint-emoji">&#128072;</span> Slide to reveal</div>
                                    <div class="ba-slider-celebration" id="celebration-${item.id}">&#10024;</div>
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${item.id}', '${item.docId}')">
                                    &#10084;&#65039; ${likeCount}
                                </button>
                                <button class="comment-btn" onclick="toggleComments('${item.id}')">
                                    &#128172; ${comments.length}
                                </button>
                                ${isMyItem ? `<button class="delete-btn" onclick="deleteItem('${item.docId}', '${item.userId}', ${item.points})">&#128465;&#65039; Delete</button>` : ''}
                            </div>
                            <div class="comments-section" id="comments-${item.id}">
                                ${comments.map(c => renderComment(c)).join('')}
                                <div class="comment-input">
                                    <input type="text" id="comment-input-${item.id}" placeholder="Add comment...">
                                    <button onclick="addComment('${item.id}', '${item.docId}')">Post</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Normal Card
                    return `
                        <div class="item" style="${isMyItem ? 'background: #FAFAFA;' : ''}">
                            <div class="item-header">
                                <img src="${item.image}" alt="${item.name}" class="item-image">
                                <div class="item-info">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-date" style="display:flex;align-items:center;gap:6px;">${feedAvatar} ${item.userName || 'Anonymous'} &bull; ${dateStr}</div>
                                    ${hasNote ? `<div class="item-note">"${item.note}"</div>` : ''}
                                </div>
                                <div class="item-points">+${item.points}</div>
                            </div>

                            <div class="item-actions">
                                <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${item.id}', '${item.docId}')">
                                    &#10084;&#65039; ${likeCount}
                                </button>
                                <button class="comment-btn" onclick="toggleComments('${item.id}')">
                                    &#128172; ${comments.length}
                                </button>
                                ${isMyItem ? `<button class="delete-btn" onclick="deleteItem('${item.docId}', '${item.userId}', ${item.points})">&#128465;&#65039; Delete</button>` : ''}
                            </div>
                            <div class="comments-section" id="comments-${item.id}">
                                ${comments.map(c => renderComment(c)).join('')}
                                <div class="comment-input">
                                    <input type="text" id="comment-input-${item.id}" placeholder="Add comment...">
                                    <button onclick="addComment('${item.id}', '${item.docId}')">Post</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // ===== "You" Tab — Grid View =====
        function renderYouTab() {
            const myItems = allFeedItems.filter(i => i.userId === currentUserId);
            const totalItems = myItems.length;
            const totalPoints = myItems.reduce((sum, i) => sum + (i.points || 0), 0);

            document.getElementById('youItemCount').textContent = totalItems;
            document.getElementById('youPointsCount').textContent = totalPoints;

            const grid = document.getElementById('youGrid');

            if (totalItems === 0) {
                grid.innerHTML = `
                    <div class="you-empty" style="grid-column: 1 / -1;">
                        <div class="empty-icon">📦</div>
                        <div>No items yet</div>
                        <div style="font-size: 14px; margin-top: 10px;">Declutter your first item!</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = myItems.map(item => {
                const isSelected = youSelectedItems.includes(item.docId);
                const selectableClass = youShareMode ? 'selectable' : '';
                const selectedClass = youShareMode && isSelected ? 'selected' : '';
                return `
                    <div class="you-grid-cell ${selectableClass} ${selectedClass}"
                         onclick="${youShareMode ? `toggleYouSelect('${item.docId}')` : ''}"
                         data-id="${item.docId}">
                        <img src="${item.image}" alt="${item.name}" loading="lazy">
                        <div class="grid-overlay">
                            <div class="grid-item-name">${item.name}</div>
                        </div>
                        <div class="grid-check">${isSelected ? '&#10003;' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Toggle share mode on You tab
        window.toggleYouShareMode = function() {
            youShareMode = !youShareMode;
            youSelectedItems = [];
            updateYouShareUI();
            renderYouTab();
        };

        function updateYouShareUI() {
            const actions = document.getElementById('youShareActions');
            const helper = document.getElementById('youShareHelper');

            if (youShareMode) {
                actions.innerHTML = `
                    <div class="you-share-mode-bar">
                        <button class="cancel-btn" onclick="toggleYouShareMode()">Cancel</button>
                        <button class="share-count-btn ${youSelectedItems.length === 0 ? 'disabled' : ''}"
                                id="youShareCountBtn"
                                onclick="openShareSheet()">Share (${youSelectedItems.length})</button>
                    </div>
                `;
                helper.style.display = 'block';
            } else {
                actions.innerHTML = `
                    <button class="you-share-btn" id="youShareBtn" onclick="toggleYouShareMode()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                            <polyline points="16 6 12 2 8 6"/>
                            <line x1="12" y1="2" x2="12" y2="15"/>
                        </svg>
                        Share
                    </button>
                `;
                helper.style.display = 'none';
            }
        }

        // Toggle item selection in share mode (max 9)
        window.toggleYouSelect = function(docId) {
            const idx = youSelectedItems.indexOf(docId);
            if (idx >= 0) {
                youSelectedItems.splice(idx, 1);
            } else if (youSelectedItems.length < 9) {
                youSelectedItems.push(docId);
            }
            updateYouShareUI();
            renderYouTab();
        };

        // ===== Share Bottom Sheet =====
        window.openShareSheet = function() {
            if (youSelectedItems.length === 0) return;

            const myItems = allFeedItems.filter(i => i.userId === currentUserId);
            const selected = youSelectedItems.map(id => myItems.find(i => i.docId === id)).filter(Boolean);
            const totalPoints = selected.reduce((sum, i) => sum + (i.points || 0), 0);
            const cols = Math.min(selected.length, 3);

            // Preview grid
            const previewGrid = document.getElementById('sharePreviewGrid');
            previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            previewGrid.innerHTML = selected.map(item =>
                `<img src="${item.image}" alt="${item.name}">`
            ).join('');

            document.getElementById('shareSummaryTitle').textContent =
                `${selected.length} Item${selected.length > 1 ? 's' : ''} lighter. One a day. It adds up with Declutter Daily.`;

            document.getElementById('shareSheetOverlay').classList.add('active');
            document.getElementById('shareSheet').style.display = 'block';
        };

        window.closeShareSheet = function() {
            document.getElementById('shareSheetOverlay').classList.remove('active');
            document.getElementById('shareSheet').style.display = 'none';
        };

        // ===== Share Image Generation (1080×1350 Canvas) =====
        async function generateShareImage() {
            const myItems = allFeedItems.filter(i => i.userId === currentUserId);
            const selected = youSelectedItems.map(id => myItems.find(i => i.docId === id)).filter(Boolean);
            const totalPoints = selected.reduce((sum, i) => sum + (i.points || 0), 0);

            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1350;
            const ctx = canvas.getContext('2d');

            // Background
            ctx.fillStyle = '#FAFAFA';
            ctx.fillRect(0, 0, 1080, 1350);

            // App name at top
            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Declutter Daily', 540, 100);

            // Subtitle
            ctx.fillStyle = '#999';
            ctx.font = '28px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText('One item at a time', 540, 145);

            // Load and draw images in grid (3 cols)
            const cols = Math.min(selected.length, 3);
            const rows = Math.ceil(selected.length / cols);
            const gridTop = 200;
            const gridPad = 40;
            const cellGap = 8;
            const gridWidth = 1080 - gridPad * 2;
            const cellSize = (gridWidth - (cols - 1) * cellGap) / cols;
            const gridHeight = rows * cellSize + (rows - 1) * cellGap;

            // Draw rounded rect background for grid
            const gridRadius = 24;
            ctx.fillStyle = '#E8E8E8';
            roundRect(ctx, gridPad - 4, gridTop - 4, gridWidth + 8, gridHeight + 8, gridRadius);
            ctx.fill();

            // Load images via proxy to avoid CORS canvas tainting
            const PROXY_URL = 'https://us-central1-declutter-challenge-94366.cloudfunctions.net/imageProxy?url=';
            const images = await Promise.all(selected.map(item => {
                return new Promise(async (resolve) => {
                    try {
                        const response = await fetch(PROXY_URL + encodeURIComponent(item.image));
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const img = new Image();
                        img.onload = () => {
                            URL.revokeObjectURL(blobUrl);
                            resolve(img);
                        };
                        img.onerror = () => {
                            URL.revokeObjectURL(blobUrl);
                            resolve(null);
                        };
                        img.src = blobUrl;
                    } catch (e) {
                        resolve(null);
                    }
                });
            }));

            images.forEach((img, idx) => {
                const col = idx % cols;
                const row = Math.floor(idx / cols);
                const x = gridPad + col * (cellSize + cellGap);
                const y = gridTop + row * (cellSize + cellGap);

                ctx.save();
                // Clip to rounded cell
                roundRect(ctx, x, y, cellSize, cellSize, 4);
                ctx.clip();

                if (img) {
                    // Draw image cover-fit
                    const scale = Math.max(cellSize / img.width, cellSize / img.height);
                    const sw = cellSize / scale;
                    const sh = cellSize / scale;
                    const sx = (img.width - sw) / 2;
                    const sy = (img.height - sh) / 2;
                    ctx.drawImage(img, sx, sy, sw, sh, x, y, cellSize, cellSize);
                } else {
                    // Fallback gray if image failed to load
                    ctx.fillStyle = '#ddd';
                    ctx.fillRect(x, y, cellSize, cellSize);
                }
                ctx.restore();
            });

            // Bottom section
            const bottomY = gridTop + gridHeight + 60;

            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 44px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${selected.length} Item${selected.length > 1 ? 's' : ''} lighter.`, 540, bottomY);

            ctx.fillStyle = '#666';
            ctx.font = '32px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText('One a day. It adds up with Declutter Daily.', 540, bottomY + 50);

            // App URL at bottom
            ctx.fillStyle = '#BBB';
            ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText('declutterdaily.app', 540, 1310);

            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
        }

        // Helper: draw rounded rect path
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        // Share to Instagram (uses native share with file)
        window.shareToInstagram = async function() {
            try {
                const blob = await generateShareImage();
                if (!blob) { alert('이미지 생성에 실패했습니다. 다시 시도해주세요.'); return; }
                const file = new File([blob], 'declutter-daily.jpg', { type: 'image/jpeg' });
                const myItems = allFeedItems.filter(i => i.userId === currentUserId);
                const count = youSelectedItems.length;

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'My Declutter Journey',
                        text: `${count} Item${count > 1 ? 's' : ''} lighter. One a day. It adds up with Declutter Daily.`,
                    });
                } else {
                    // Fallback: download
                    await saveShareImageFromBlob(blob);
                    alert('Image saved! You can now share it to Instagram manually.');
                }
                closeShareSheet();
            } catch (err) {
                if (err.name !== 'AbortError') console.error('Share failed:', err);
            }
        };

        // More options (native share sheet)
        window.shareMore = async function() {
            try {
                const blob = await generateShareImage();
                if (!blob) { alert('이미지 생성에 실패했습니다. 다시 시도해주세요.'); return; }
                const file = new File([blob], 'declutter-daily.jpg', { type: 'image/jpeg' });
                const count = youSelectedItems.length;

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'My Declutter Journey',
                        text: `${count} Item${count > 1 ? 's' : ''} lighter. One a day. It adds up with Declutter Daily.`,
                    });
                } else {
                    await saveShareImageFromBlob(blob);
                    alert('Image saved! Share it from your gallery.');
                }
                closeShareSheet();
            } catch (err) {
                if (err.name !== 'AbortError') console.error('Share failed:', err);
            }
        };

        // Save image to gallery (download)
        window.saveShareImage = async function() {
            try {
                const blob = await generateShareImage();
                if (!blob) { alert('이미지 생성에 실패했습니다. 다시 시도해주세요.'); return; }
                await saveShareImageFromBlob(blob);
                closeShareSheet();
            } catch (err) {
                console.error('Save failed:', err);
            }
        };

        function saveShareImageFromBlob(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'declutter-daily.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===== "Before & After" Tab =====
        function renderBAItems() {
            const listElement = document.getElementById('baItemList');
            const items = allFeedItems.filter(i => i.hasBeforeAfter);

            if (items.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📸</div>
                        <div>No Before & After posts yet</div>
                        <div style="font-size: 14px; margin-top: 10px;">Be the first to share a transformation!</div>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = items.map(item => {
                const date = item.createdAt?.toDate() || new Date();
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isMyItem = item.userId === currentUserId;
                const isLiked = (item.likes || []).includes(currentUserId);
                const likeCount = item.likeCount || 0;
                const comments = item.comments || [];
                const hasNote = item.note && item.note.trim();
                const basePoints = (item.points || 0) - (item.bonusPoints || 0);
                const feedAvatar = getUserAvatarHTML(item.userName, item.userPhotoURL, 30);

                return `
                    <div class="item ba-item" style="${isMyItem ? 'background: #FAFAFA;' : ''}">
                        <div class="item-header">
                            <div class="ba-thumb-wrap" onclick="toggleBASlider('ba_${item.id}')">
                                <img src="${item.image}" alt="${item.name}" class="item-image">
                                <div class="ba-thumb-badge">
                                    <span class="ba-photo-badge-icon"><span class="half-warm"></span><span class="half-green"></span></span>
                                    B&A
                                </div>
                            </div>
                            <div class="item-info">
                                <div class="item-name">${item.name} <span class="ba-badge">B&A</span></div>
                                <div class="item-date" style="display:flex;align-items:center;gap:6px;">${feedAvatar} ${item.userName || 'Anonymous'} &bull; ${dateStr}</div>
                                ${hasNote ? `<div class="item-note">"${item.note}"</div>` : ''}
                            </div>
                            <div class="ba-points-display">
                                <span class="base-pts">+${basePoints}</span>
                                <span class="bonus-pts">+${item.bonusPoints || 30} bonus</span>
                            </div>
                        </div>
                        <div class="ba-expand-section" id="ba-expand-ba_${item.id}">
                            <div class="ba-expand-header">
                                <span class="ba-expand-label">Before &amp; After</span>
                                <button class="ba-expand-close" onclick="toggleBASlider('ba_${item.id}')" aria-label="Close slider">&#10005;</button>
                            </div>
                            <div class="ba-slider-container" id="slider-ba_${item.id}" style="--slider-pos: 80%"
                                 onpointerdown="startSlider(event, 'ba_${item.id}')"
                                 onpointermove="moveSlider(event, 'ba_${item.id}')"
                                 onpointerup="endSlider(event, 'ba_${item.id}')">
                                <img src="${item.beforePhotoURL}" alt="Cluttered" class="ba-slider-before">
                                <img src="${item.afterPhotoURL}" alt="Cleared" class="ba-slider-after">
                                <div class="ba-slider-divider"></div>
                                <div class="ba-slider-handle">&#9664; &#9654;</div>
                                <div class="ba-slider-label left" id="label-left-ba_${item.id}">CLUTTERED</div>
                                <div class="ba-slider-label right" id="label-right-ba_${item.id}">CLEARED</div>
                                <div class="ba-slider-hint" id="hint-ba_${item.id}"><span class="hint-emoji">&#128072;</span> Slide to reveal</div>
                                <div class="ba-slider-celebration" id="celebration-ba_${item.id}">&#10024;</div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${item.id}', '${item.docId}')">
                                &#10084;&#65039; ${likeCount}
                            </button>
                            <button class="comment-btn" onclick="toggleComments('ba_${item.id}')">
                                &#128172; ${comments.length}
                            </button>
                            ${isMyItem ? `<button class="delete-btn" onclick="deleteItem('${item.docId}', '${item.userId}', ${item.points})">&#128465;&#65039; Delete</button>` : ''}
                        </div>
                        <div class="comments-section" id="comments-ba_${item.id}">
                            ${comments.map(c => renderComment(c)).join('')}
                            <div class="comment-input">
                                <input type="text" id="comment-input-ba_${item.id}" placeholder="Add comment...">
                                <button onclick="addComment('ba_${item.id}', '${item.docId}')">Post</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Interactive Slider Logic (unified for feed and popup)
        const activeSliders = {};
        function getSliderElement(id) {
            if (id.endsWith('_popup')) {
                return document.getElementById('popup-slider-' + id.replace('_popup', ''));
            }
            return document.getElementById('slider-' + id);
        }

        window.startSlider = function(e, id) {
            const container = getSliderElement(id);
            if (!container) return;
            container.setPointerCapture(e.pointerId);
            activeSliders[id] = true;
            const hint = document.getElementById('hint-' + id);
            if (hint) hint.style.display = 'none';
        };

        window.moveSlider = function(e, id) {
            if (!activeSliders[id]) return;
            const container = getSliderElement(id);
            if (!container) return;
            const rect = container.getBoundingClientRect();
            let pos = ((e.clientX - rect.left) / rect.width) * 100;
            pos = Math.max(2, Math.min(98, pos));
            container.style.setProperty('--slider-pos', pos + '%');

            // Label fading: CLUTTERED fades when slider < 25%, CLEARED fades when slider > 75%
            const baseId = id.endsWith('_popup') ? id.replace('_popup', '') : id;
            const leftLabel = document.getElementById('label-left-' + baseId) || container.querySelector('.ba-slider-label.left');
            const rightLabel = document.getElementById('label-right-' + baseId) || container.querySelector('.ba-slider-label.right');
            if (leftLabel) {
                leftLabel.style.opacity = pos < 25 ? String(pos / 25) : '1';
            }
            if (rightLabel) {
                rightLabel.style.opacity = pos > 75 ? String((100 - pos) / 25) : '1';
            }

            // Show sparkle when slider passes 30%
            const celebration = document.getElementById('celebration-' + id);
            if (celebration) {
                celebration.classList.toggle('show', pos <= 30);
            }
        };

        window.endSlider = function(e, id) {
            activeSliders[id] = false;
        };

        // Toggle B&A slider expand/collapse
        window.toggleBASlider = function(id) {
            const section = document.getElementById('ba-expand-' + id);
            if (!section) return;
            section.classList.toggle('expanded');
        };

        async function loadMyItems() {
            const listElement = document.getElementById('itemList');

            try {
                const itemsQuery = query(collection(db, 'items'), limit(50));

                onSnapshot(itemsQuery, (snapshot) => {
                    const items = [];
                    let myScore = 0;
                    let myItemCount = 0;

                    snapshot.forEach((doc) => {
                        const item = doc.data();
                        items.push({
                            ...item,
                            id: doc.id,
                            docId: doc.id
                        });
                        if (item.userId === currentUserId) {
                            myScore += item.points || 0;
                            myItemCount++;
                        }
                    });

                    // Update header items count
                    const hdrItems = document.getElementById('headerItems');
                    if (hdrItems) hdrItems.textContent = myItemCount;

                    items.sort((a, b) => {
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });

                    totalScore = myScore;
                    document.getElementById('totalScore').textContent = totalScore;
                    updateHeaderStats();

                    allFeedItems = items;
                    // Render the currently active feed sub-tab
                    if (currentFeedFilter === 'you') {
                        renderYouTab();
                    } else if (currentFeedFilter === 'ba') {
                        renderBAItems();
                    } else {
                        renderFeedItems();
                    }
                });
            } catch (error) {
                console.error('Items load failed:', error);
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <div>Data load failed</div>
                    </div>
                `;
            }
        }

        async function loadLeaderboard() {
            const leaderboardElement = document.getElementById('leaderboardList');

            try {
                const usersQuery = query(collection(db, 'users'), orderBy('score', 'desc'), limit(20));

                onSnapshot(usersQuery, (snapshot) => {
                    const users = [];

                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        users.push(user);
                    });

                    if (users.length === 0) {
                        leaderboardElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">🏆</div>
                                <div>No participants yet</div>
                            </div>
                        `;
                        return;
                    }

                    const topScore = users[0].score || 1;

                    leaderboardElement.innerHTML = users.map((user, index) => {
                        const isCurrentUser = user.userId === currentUserId;
                        const rank = index + 1;
                        const isTop3 = rank <= 3;
                        const tierClass = isTop3 ? 'top3' : 'regular';
                        const userStreak = user.streak || 0;
                        const userPoints = user.score || 0;
                        const barPercent = userPoints > 0 ? Math.max(3, (userPoints / topScore) * 100) : 0;

                        // Rank display: medal emoji for top 3, number for others
                        const medals = ['🥇', '🥈', '🥉'];
                        const rankDisplay = isTop3
                            ? `<span class="ranking-rank-medal">${medals[rank - 1]}</span>`
                            : `<span class="ranking-rank-num">${rank}</span>`;

                        // Name with optional YOU badge and streak
                        const youBadge = isCurrentUser ? '<span class="ranking-you-badge">YOU</span>' : '';
                        const streakEmoji = userStreak > 0 ? '<span class="ranking-streak">🔥</span>' : '';

                        // Bar color class
                        let barClass = 'others';
                        if (rank === 1) barClass = 'rank-1';
                        else if (rank === 2) barClass = 'rank-2';
                        else if (rank === 3) barClass = 'rank-3';
                        else if (isCurrentUser) barClass = 'current-user';

                        const rankAvatar = getUserAvatarHTML(user.name, user.photoURL, 28);

                        return `
                            <div class="ranking-row">
                                <div class="ranking-row-top">
                                    <div class="ranking-rank">${rankDisplay}</div>
                                    ${rankAvatar}
                                    <div class="ranking-name ${tierClass}">${user.name || 'Anonymous'}${youBadge}${streakEmoji}</div>
                                    <div class="ranking-points ${tierClass}">${userPoints}</div>
                                </div>
                                <div class="ranking-bar-wrapper ${tierClass}">
                                    <div class="ranking-bar ${barClass}" style="width: ${barPercent}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('Leaderboard load failed:', error);
            }
        }

        window.switchTab = function(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(t => {
                t.classList.remove('active');
                t.style.display = 'none';
            });

            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Map tab names to tab element IDs
            const tabMap = {
                'add': 'addTab',
                'coach': 'coachTab',
                'feed': 'historyTab',
                'history': 'historyTab',
                'calendar': 'calendarTab',
                'leaderboard': 'leaderboardTab',
                'share': 'shareTab'
            };

            // Show selected tab
            const tabId = tabMap[tab] || (tab + 'Tab');
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }

            // Activate nav item (map 'history' to 'feed' for nav)
            const navTab = (tab === 'history') ? 'feed' : tab;
            const navItem = document.querySelector(`[data-tab="${navTab}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Update specific tab content if needed
            if (tab === 'add') updateSpaceHint();
            if (tab === 'coach') loadCoachUsage();
            if (tab === 'feed' || tab === 'history') loadMyItems();
            if (tab === 'calendar') renderCalendar();
            if (tab === 'leaderboard') loadLeaderboard();
        };

        document.getElementById('itemSpace').addEventListener('change', updateSpaceHint);
        document.getElementById('achievementOverlay').addEventListener('click', hideAchievement);

        let currentCalendarYear = 2026;
        let currentCalendarMonth = 1;
        let userItemDates = {};

        async function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthEl = document.getElementById('calendarMonth');

            const year = currentCalendarYear;
            const month = currentCalendarMonth;

            // Set month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthEl.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            // Get day of week for first day (0 = Sunday, convert to Monday = 0)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6; // Sunday becomes 6

            // Fetch items from Firebase
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);

            userItemDates = {};

            itemsSnapshot.forEach(doc => {
                const item = doc.data();
                if (item.createdAt) {
                    const date = item.createdAt.toDate();
                    const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;

                    if (!userItemDates[dateKey]) {
                        userItemDates[dateKey] = {
                            count: 0,
                            points: 0
                        };
                    }
                    userItemDates[dateKey].count += 1;
                    userItemDates[dateKey].points += item.points || 0;
                }
            });

            grid.innerHTML = '';

            // Add empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }

            // Track monthly stats
            const now = new Date();
            const today = now.getDate();
            const isCurrentMonth = now.getMonth() === month && now.getFullYear() === year;
            let monthItemCount = 0;
            let monthPointCount = 0;
            let activeDaysCount = 0;

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';

                // Check if this day has activity
                const dateKey = `${year}-${month}-${day}`;
                const dayData = userItemDates[dateKey] || { count: 0, points: 0 };

                if (dayData.count > 0) {
                    dayCell.classList.add('active');
                    monthItemCount += dayData.count;
                    monthPointCount += dayData.points;
                    activeDaysCount++;
                }

                if (isCurrentMonth && day === today) {
                    dayCell.classList.add('today');
                }

                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Icon - trash can for active days
                if (dayData.count > 0) {
                    const icon = document.createElement('div');
                    icon.className = 'day-icon';
                    icon.textContent = '🗑️';
                    dayCell.appendChild(icon);
                }

                grid.appendChild(dayCell);
            }

            // Update stats
            document.getElementById('calendarStreakValue').textContent =
                userStreak > 0 ? `${userStreak} Day${userStreak !== 1 ? 's' : ''}` : '0 Days';
            document.getElementById('calendarMonthCount').textContent =
                `${monthItemCount} Item${monthItemCount !== 1 ? 's' : ''}`;

            // Update month summary
            document.getElementById('monthItems').textContent = monthItemCount;
            document.getElementById('monthPoints').textContent = monthPointCount;
            document.getElementById('monthDays').textContent = activeDaysCount;
        }

        window.changeMonth = function(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        };

        window.shareProgress = function() {
            const monthItemsEl = document.getElementById('monthItems');
            const monthPointsEl = document.getElementById('monthPoints');
            const monthItems = monthItemsEl ? monthItemsEl.textContent : '0';
            const monthPointsVal = monthPointsEl ? monthPointsEl.textContent : '0';
            const streak = userStreak;

            const text = `This month on Declutter Daily:\n🗑️ ${monthItems} items\n⭐ ${monthPointsVal} points\n🔥 ${streak} day streak`;

            if (navigator.share) {
                navigator.share({
                    title: 'My Declutter Progress',
                    text: text,
                    url: window.location.href
                }).catch(() => {
                    navigator.clipboard.writeText(text);
                    alert('Progress copied to clipboard!');
                });
            } else {
                navigator.clipboard.writeText(text);
                alert('Progress copied to clipboard!');
            }
        };

        window.generateStoryTemplate = async function(template) {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            const userData = userSnapshot.empty ? {} : userSnapshot.docs[0].data();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            const userItems = [];
            itemsSnapshot.forEach(doc => userItems.push(doc.data()));
            
            if (template === 'minimal') {
                drawMinimalTemplate(ctx, userData, userItems);
            } else if (template === 'stats') {
                drawStatsTemplate(ctx, userData, userItems);
            } else if (template === 'streak') {
                drawStreakTemplate(ctx, userData);
            } else if (template === 'grid') {
                await drawGridTemplate(ctx, userData, userItems);
            }
            
            canvas.style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        };

        function drawMinimalTemplate(ctx, userData, items) {
            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 80px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Declutter Daily', 540, 300);

            ctx.font = 'bold 180px sans-serif';
            ctx.fillText(userData.score || 0, 540, 800);

            ctx.font = '60px sans-serif';
            ctx.fillText('POINTS', 540, 900);

            ctx.font = 'bold 50px sans-serif';
            ctx.fillText(`${items.length} items decluttered`, 540, 1100);

            ctx.font = '50px sans-serif';
            ctx.fillText(`${userData.streak || 0} day streak`, 540, 1200);

            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);

            ctx.font = '40px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText('Practicing Minimal Life', 540, 1700);
        }

        function drawStatsTemplate(ctx, userData, items) {
            ctx.fillStyle = '#FAFAFA';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 400);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('My Declutter Stats', 540, 250);
            
            const categoryCount = {};
            items.forEach(item => {
                categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
            });
            
            const categories = [
                { key: 'furniture', name: 'Furniture', emoji: '🛋️' },
                { key: 'electronics', name: 'Electronics', emoji: '📱' },
                { key: 'books', name: 'Books', emoji: '📚' },
                { key: 'clothes', name: 'Clothing', emoji: '👕' },
                { key: 'kitchen', name: 'Kitchenware', emoji: '🍳' },
                { key: 'shoes', name: 'Shoes', emoji: '👟' },
                { key: 'food', name: 'Food', emoji: '🍔' },
                { key: 'toys', name: 'Toys', emoji: '🧸' },
                { key: 'sports', name: 'Sports Equipment', emoji: '🏋️' },
                { key: 'digital', name: 'Digital Photos/Docs', emoji: '📄' },
                { key: 'etc', name: 'Other', emoji: '📦' }
            ];
            
            let y = 550;
            ctx.textAlign = 'left';
            categories.forEach(cat => {
                const count = categoryCount[cat.key] || 0;
                
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(0,0,0,0.05)';
                ctx.shadowBlur = 10;
                ctx.fillRect(80, y - 80, 920, 120);
                ctx.shadowBlur = 0;

                ctx.font = '60px sans-serif';
                ctx.fillText(cat.emoji, 120, y);

                ctx.fillStyle = '#1C1C1E';
                ctx.font = 'bold 50px sans-serif';
                ctx.fillText(cat.name, 220, y);

                ctx.fillStyle = '#1C1C1E';
                ctx.font = 'bold 60px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${count}`, 950, y);
                ctx.textAlign = 'left';
                
                y += 180;
            });
            
            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 55px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`Total ${items.length} items • ${userData.score || 0} pts`, 540, 1750);
        }

        function drawStreakTemplate(ctx, userData) {
            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 200px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(userData.streak || 0, 540, 800);

            ctx.font = 'bold 80px sans-serif';
            ctx.fillText('Day Streak', 540, 940);

            ctx.font = '50px sans-serif';
            const streak = userData.streak || 0;
            let message = 'Practicing daily!';
            if (streak >= 30) message = 'One month achieved!';
            else if (streak >= 7) message = 'One week achieved!';
            else if (streak >= 3) message = 'Building good habits!';

            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText(message, 540, 1200);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);
        }

        async function drawGridTemplate(ctx, userData, items) {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 1080, 1920);

            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1080, 350);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${items.length} items decluttered!`, 540, 220);
            
            const recentItems = items.slice(0, 6);
            const gridSize = 320;
            const gap = 30;
            const startX = 60;
            const startY = 400;
            
            for (let i = 0; i < 6; i++) {
                const row = Math.floor(i / 3);
                const col = i % 3;
                const x = startX + col * (gridSize + gap);
                const y = startY + row * (gridSize + gap);
                
                if (i < recentItems.length && recentItems[i].image) {
                    try {
                        const storyProxyUrl = 'https://us-central1-declutter-challenge-94366.cloudfunctions.net/imageProxy?url=';
                        const response = await fetch(storyProxyUrl + encodeURIComponent(recentItems[i].image));
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const img = new Image();
                        img.src = blobUrl;
                        await new Promise(resolve => {
                            img.onload = () => {
                                ctx.save();
                                ctx.beginPath();
                                ctx.roundRect(x, y, gridSize, gridSize, 20);
                                ctx.clip();
                                ctx.drawImage(img, x, y, gridSize, gridSize);
                                ctx.restore();
                                URL.revokeObjectURL(blobUrl);
                                resolve();
                            };
                            img.onerror = () => {
                                URL.revokeObjectURL(blobUrl);
                                resolve();
                            };
                        });
                    } catch (e) {
                        ctx.fillStyle = '#E5E5E5';
                        ctx.beginPath();
                        ctx.roundRect(x, y, gridSize, gridSize, 20);
                        ctx.fill();
                    }
                } else {
                    ctx.fillStyle = '#F5F5F5';
                    ctx.beginPath();
                    ctx.roundRect(x, y, gridSize, gridSize, 20);
                    ctx.fill();
                }
            }
            
            ctx.fillStyle = '#1C1C1E';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${userData.score || 0} pts`, 270, 1650);
            ctx.fillText(`${userData.streak || 0} days`, 810, 1650);

            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1800);
        }

        window.downloadStoryImage = function() {
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = `declutter-story-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        // ===== Before & After Popup =====
        let baPopupIndex = 0;
        let baPopupItems = [];

        function checkBAPopup() {
            const today = new Date().toISOString().split('T')[0];
            const lastDate = localStorage.getItem('lastBAPopupDate');
            if (lastDate === today) return;

            // Get B&A items from feed
            const baItems = allFeedItems.filter(i => i.hasBeforeAfter).slice(0, 3);
            if (baItems.length === 0) return;

            baPopupItems = baItems;
            baPopupIndex = 0;
            localStorage.setItem('lastBAPopupDate', today);

            setTimeout(() => {
                renderBAPopupCard();
                document.getElementById('baPopupOverlay').classList.add('show');
            }, 600);
        }

        function renderBAPopupCard() {
            const item = baPopupItems[baPopupIndex];
            if (!item) return;

            const date = item.createdAt?.toDate() || new Date();
            const now = new Date();
            const diffMs = now - date;
            const diffH = Math.floor(diffMs / (1000 * 60 * 60));
            const timeAgo = diffH < 1 ? 'Just now' : diffH < 24 ? `${diffH}h ago` : `${Math.floor(diffH / 24)}d ago`;

            const spaceName = getSpaceName(item.space);
            const initial = (item.userName || 'A').charAt(0).toUpperCase();
            const likeCount = item.likeCount || 0;
            const sliderId = 'popup-slider-' + item.id;
            const baPopupAvatarStyle = item.userPhotoURL ? `background-image:url(${item.userPhotoURL});background-size:cover;background-position:center;` : '';

            const container = document.getElementById('baPopupCardContainer');
            container.innerHTML = `
                <div class="ba-popup-card">
                    <div class="ba-popup-user-info">
                        <div class="ba-popup-avatar" style="${baPopupAvatarStyle}">${item.userPhotoURL ? '' : initial}</div>
                        <div>
                            <div class="ba-popup-user-name">${item.userName || 'Anonymous'} &bull; ${timeAgo}</div>
                            <div class="ba-popup-user-meta">${spaceName}</div>
                        </div>
                    </div>
                    <div style="position:relative;width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;margin-bottom:8px;">
                        <img src="${item.image}" alt="${item.name || 'Item'}" style="width:100%;height:100%;object-fit:cover;">
                        <span style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.6);color:white;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600;">&#128247; Item</span>
                    </div>
                    <div class="ba-slider-container" id="${sliderId}" style="--slider-pos: 80%"
                         onpointerdown="startSlider(event, '${sliderId.replace('popup-slider-', '')}_popup')"
                         onpointermove="moveSlider(event, '${sliderId.replace('popup-slider-', '')}_popup')"
                         onpointerup="endSlider(event, '${sliderId.replace('popup-slider-', '')}_popup')">
                        <img src="${item.beforePhotoURL}" alt="Cluttered" class="ba-slider-before">
                        <img src="${item.afterPhotoURL}" alt="Cleared" class="ba-slider-after">
                        <div class="ba-slider-divider"></div>
                        <div class="ba-slider-handle">&#9664; &#9654;</div>
                        <div class="ba-slider-label left" id="label-left-${item.id}">CLUTTERED</div>
                        <div class="ba-slider-label right" id="label-right-${item.id}">CLEARED</div>
                        <div class="ba-slider-hint" id="hint-${sliderId.replace('popup-slider-', '')}_popup"><span class="hint-emoji">&#128072;</span> Slide to reveal</div>
                        <div class="ba-slider-celebration" id="celebration-${sliderId.replace('popup-slider-', '')}_popup">&#10024;</div>
                    </div>
                    <div class="ba-popup-reactions">
                        <button class="ba-popup-reaction-btn">&#128525;</button>
                        <button class="ba-popup-reaction-btn">&#128293;</button>
                        <button class="ba-popup-reaction-btn">&#128079;</button>
                        <span class="ba-popup-likes">&#10084;&#65039; ${likeCount}</span>
                    </div>
                </div>
            `;

            // Auto-animate slider hint
            const sliderEl = document.getElementById(sliderId);
            if (sliderEl) {
                setTimeout(() => {
                    let pos = 80;
                    const target = 55;
                    const step = () => {
                        pos -= 0.5;
                        if (pos <= target) {
                            pos = target;
                            sliderEl.style.setProperty('--slider-pos', pos + '%');
                            return;
                        }
                        sliderEl.style.setProperty('--slider-pos', pos + '%');
                        requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                }, 800);
            }

            // Dots
            const dotsEl = document.getElementById('baPopupDots');
            dotsEl.innerHTML = baPopupItems.map((_, i) =>
                `<div class="ba-popup-dot ${i === baPopupIndex ? 'active' : ''}"></div>`
            ).join('');

            // Buttons
            const buttonsEl = document.getElementById('baPopupButtons');
            const isLast = baPopupIndex === baPopupItems.length - 1;
            if (isLast) {
                buttonsEl.innerHTML = `<button class="ba-popup-cta" onclick="closeBAPopup(); switchTab('add');">Start Decluttering &#10024;</button>`;
            } else {
                buttonsEl.innerHTML = `
                    <button class="ba-popup-skip" onclick="closeBAPopup()">Skip</button>
                    <button class="ba-popup-next" onclick="nextBAPopupCard()">Next &rarr;</button>
                `;
            }

        }

        window.nextBAPopupCard = function() {
            if (baPopupIndex < baPopupItems.length - 1) {
                baPopupIndex++;
                renderBAPopupCard();
            }
        };

        window.closeBAPopup = function() {
            document.getElementById('baPopupOverlay').classList.remove('show');
        };

        // ===== Dream Home Vision =====
        let dreamVisionText = '';

        function renderDreamVision(vision) {
            dreamVisionText = vision || '';
            const card = document.getElementById('dreamVisionCard');
            const line = document.getElementById('dreamVisionLine');

            if (!dreamVisionText) {
                // Show onboarding card
                card.style.display = 'block';
                line.style.display = 'none';
                document.getElementById('dreamVisionInput').value = '';
                document.getElementById('dreamSetBtn').classList.remove('active');
            } else {
                // Show one-liner
                card.style.display = 'none';
                line.style.display = 'block';
                line.innerHTML = '🏡 "<span class="dream-vision-text">' + escapeHtml(dreamVisionText) + '</span>"';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onDreamVisionInput = function() {
            const val = document.getElementById('dreamVisionInput').value.trim();
            const btn = document.getElementById('dreamSetBtn');
            if (val) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        };

        window.selectDreamChip = function(chip) {
            const input = document.getElementById('dreamVisionInput');
            input.value = chip.textContent;
            onDreamVisionInput();
        };

        window.setDreamVision = async function() {
            const val = document.getElementById('dreamVisionInput').value.trim();
            if (!val || !currentUserId) return;
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), { dreamVision: val });
                }
                renderDreamVision(val);
            } catch (error) {
                console.error('Failed to save dream vision:', error);
            }
        };

        window.editDreamVision = function() {
            const line = document.getElementById('dreamVisionLine');
            line.innerHTML = '🏡 "<input type="text" class="dream-vision-line-edit" id="dreamVisionEditInput" value="' + escapeHtml(dreamVisionText).replace(/"/g, '&quot;') + '">"';
            const input = document.getElementById('dreamVisionEditInput');
            input.focus();
            input.addEventListener('blur', saveDreamVisionEdit);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
            });
        };

        async function saveDreamVisionEdit() {
            const input = document.getElementById('dreamVisionEditInput');
            if (!input) return;
            const val = input.value.trim();
            if (!val || !currentUserId) {
                renderDreamVision(dreamVisionText);
                return;
            }
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), { dreamVision: val });
                }
                renderDreamVision(val);
            } catch (error) {
                console.error('Failed to update dream vision:', error);
                renderDreamVision(dreamVisionText);
            }
        }

        // ===== Profile Photo Upload =====
        window.openProfilePhotoSheet = function() {
            const overlay = document.getElementById('photoSheetOverlay');
            const sheet = document.getElementById('photoSheet');
            const preview = document.getElementById('photoSheetPreview');
            const buttonsDiv = document.getElementById('photoSheetButtons');

            if (userProfilePhotoURL) {
                preview.style.display = 'block';
                preview.style.backgroundImage = `url(${userProfilePhotoURL})`;
                buttonsDiv.innerHTML = `
                    <button class="photo-sheet-btn primary" onclick="triggerProfilePhotoInput()">
                        <svg viewBox="0 0 24 24"><path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        Change Photo
                    </button>
                    <button class="photo-sheet-btn danger" onclick="removeProfilePhoto()">Remove Photo</button>
                    <button class="photo-sheet-btn cancel" onclick="closeProfilePhotoSheet()">Cancel</button>
                `;
            } else {
                preview.style.display = 'none';
                buttonsDiv.innerHTML = `
                    <button class="photo-sheet-btn primary" onclick="triggerProfilePhotoInput()">
                        <svg viewBox="0 0 24 24"><path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        Upload Photo
                    </button>
                    <button class="photo-sheet-btn cancel" onclick="closeProfilePhotoSheet()">Cancel</button>
                `;
            }

            overlay.style.display = 'block';
            sheet.style.display = 'block';
            requestAnimationFrame(() => {
                sheet.style.transform = 'translateX(-50%) translateY(0)';
            });
        };

        window.closeProfilePhotoSheet = function() {
            const overlay = document.getElementById('photoSheetOverlay');
            const sheet = document.getElementById('photoSheet');
            sheet.style.transform = 'translateX(-50%) translateY(100%)';
            setTimeout(() => {
                overlay.style.display = 'none';
                sheet.style.display = 'none';
            }, 300);
        };

        window.triggerProfilePhotoInput = function() {
            document.getElementById('profilePhotoInput').click();
        };

        window.handleProfilePhotoSelect = async function(event) {
            const file = event.target.files[0];
            if (!file || !currentUserId) return;

            closeProfilePhotoSheet();

            try {
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar) {
                    profileAvatar.textContent = '...';
                    profileAvatar.style.fontSize = '14px';
                }

                const compressed = await compressImage(file, 400);
                const storageRef = ref(storage, `profilePhotos/${currentUserId}/avatar.jpg`);
                await uploadBytes(storageRef, compressed);
                const downloadURL = await getDownloadURL(storageRef);

                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), { photoURL: downloadURL });
                }

                userProfilePhotoURL = downloadURL;
                localStorage.setItem('userProfilePhotoURL', downloadURL);
                updateProfileUI();
            } catch (error) {
                console.error('Profile photo upload failed:', error);
                updateProfileUI();
            }

            event.target.value = '';
        };

        window.removeProfilePhoto = async function() {
            if (!currentUserId) return;
            closeProfilePhotoSheet();

            try {
                const storageRef = ref(storage, `profilePhotos/${currentUserId}/avatar.jpg`);
                try {
                    await deleteObject(storageRef);
                } catch (e) {
                    // File may not exist, continue
                }

                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), { photoURL: null });
                }

                userProfilePhotoURL = '';
                localStorage.removeItem('userProfilePhotoURL');
                updateProfileUI();
            } catch (error) {
                console.error('Profile photo remove failed:', error);
            }
        };

        function getUserAvatarHTML(name, photoURL, size) {
            const initial = (name || 'U').charAt(0).toUpperCase();
            const sizeClass = size === 30 ? 'feed-user-avatar' : size === 26 ? 'comment-user-avatar' : size === 28 ? 'ranking-avatar' : 'feed-user-avatar';
            if (photoURL) {
                return `<div class="${sizeClass}" style="background-image:url(${photoURL})"></div>`;
            }
            return `<div class="${sizeClass}">${initial}</div>`;
        }

        async function initApp() {
            if (!currentUserId) return;
            updateProfileUI();
            await updateUserProfile();
            await loadMyItems();

            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            if (!userSnapshot.empty) {
                const userData = userSnapshot.docs[0].data();
                userStreak = userData.streak || 0;
                userBadges = userData.badges || [];

                // Load profile photo URL
                if (userData.photoURL) {
                    userProfilePhotoURL = userData.photoURL;
                    localStorage.setItem('userProfilePhotoURL', userData.photoURL);
                } else {
                    userProfilePhotoURL = '';
                    localStorage.removeItem('userProfilePhotoURL');
                }
                updateProfileUI();

                const streakBadge = document.getElementById('streakBadge');
                if (streakBadge) streakBadge.textContent = `${userStreak} Day Streak`;

                // Update header items count
                const headerItems = document.getElementById('headerItems');
                if (headerItems) headerItems.textContent = userData.itemCount || 0;

                updateHeaderStats();
                renderBadges();

                // Load dream vision
                renderDreamVision(userData.dreamVision || '');
            }

            // Check B&A popup after data loads
            setTimeout(() => checkBAPopup(), 300);
        }

        (async function checkAuthState() {
            // Handle redirect result first (when returning from signInWithRedirect)
            try {
                const redirectResult = await getRedirectResult(auth);
                if (redirectResult && redirectResult.user) {
                    handleGoogleLoginSuccess(redirectResult.user);
                    return;
                }
            } catch (error) {
                console.error('Redirect result error:', error);
            }

            // Normal auth state check from localStorage
            const savedUserId = localStorage.getItem('userId');
            const savedProvider = localStorage.getItem('authProvider');

            if (savedUserId && savedProvider) {
                currentUserId = savedUserId;
                userName = localStorage.getItem('userName') || '';
                hideLoginScreen();
                initApp();
            } else {
                showLoginScreen();
            }
        })();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>

    <!-- Settings Bottom Sheet -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
    <div class="settings-sheet" id="settingsSheet">
        <div class="settings-sheet-header">
            <h3>Settings</h3>
            <button class="settings-close-btn" onclick="closeSettings()">&times;</button>
        </div>

        <div class="settings-section-label">Display Name</div>
        <input type="text" class="settings-name-input" id="settingsNameInput" maxlength="20" placeholder="Enter display name" oninput="onSettingsNameInput()">
        <button class="settings-save-btn" id="settingsSaveBtn" onclick="saveDisplayName()">Save</button>

        <hr class="settings-divider">

        <button class="settings-logout-btn" onclick="handleSettingsLogout()">Logout</button>
    </div>

    <!-- Profile Photo Bottom Sheet -->
    <div class="photo-sheet-overlay" id="photoSheetOverlay" onclick="closeProfilePhotoSheet()"></div>
    <div class="photo-sheet" id="photoSheet">
        <div class="photo-sheet-grab"></div>
        <div class="photo-sheet-title">Profile Photo</div>
        <div class="photo-sheet-preview" id="photoSheetPreview"></div>
        <div id="photoSheetButtons"></div>
    </div>

    <!-- Before & After Popup -->
    <div class="ba-popup-overlay" id="baPopupOverlay" onclick="closeBAPopup()">
        <div class="ba-popup-sheet" onclick="event.stopPropagation()">
            <div class="ba-popup-handle"></div>
            <div class="ba-popup-header">
                <div>
                    <div class="ba-popup-supertitle">&#128293; Trending Now</div>
                    <div class="ba-popup-title">Who's Feeling Lighter?</div>
                </div>
                <button class="ba-popup-close" onclick="closeBAPopup()">&times;</button>
            </div>
            <div id="baPopupCardContainer">
                <!-- Dynamically filled -->
            </div>
            <div class="ba-popup-dots" id="baPopupDots"></div>
            <div class="ba-popup-buttons" id="baPopupButtons"></div>
        </div>
    </div>

</body>

</html>


