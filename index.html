<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë¹„ìš°ê¸°">
    <meta name="description" content="ë¬¼ê±´ì„ ë¹„ìš°ê³  ì ìˆ˜ë¥¼ ëª¨ìœ¼ëŠ” ë¯¸ë‹ˆë©€ë¦¬ì¦˜ ì±Œë¦°ì§€">
    <title>ë¬¼ê±´ ë¹„ìš°ê¸° ì±Œë¦°ì§€ (ì˜¨ë¼ì¸)</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            padding-top: 50px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: center;
            position: relative;
        }

        .online-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #48bb78;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
            margin-top: 25px;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #4a5568;
            margin: 20px 0;
        }

        .score-label {
            color: #718096;
            font-size: 14px;
        }

        .streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .username-input {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 0;
            font-size: 14px;
            text-align: center;
            width: 200px;
            display: inline-block;
        }

        .username-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        .badges-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .badge {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge.locked {
            background: #e2e8f0;
            color: #a0aec0;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 10px 4px;
            background: none;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #718096;
            white-space: nowrap;
            min-width: 60px;
        }

        .tab.active {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #4a5568;
            background: #f7fafc;
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: #4a5568;
            padding: 0;
        }

        .preview-image {
            width: 100%;
            border-radius: 15px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4a5568;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 55, 72, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .item-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .item-date {
            font-size: 12px;
            color: #a0aec0;
        }

        .item-note {
            font-size: 13px;
            color: #4a5568;
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #48bb78;
        }

        .item-points {
            font-weight: bold;
            color: #48bb78;
            font-size: 18px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .like-btn {
            background: none;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.3s;
            color: #718096;
        }

        .like-btn:hover {
            border-color: #4a5568;
        }

        .like-btn.liked {
            background: #4a5568;
            color: white;
            border-color: #4a5568;
        }

        .comment-btn {
            background: none;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.3s;
            color: #718096;
        }

        .comment-btn:hover {
            border-color: #48bb78;
        }

        .delete-btn {
            background: none;
            border: 2px solid #fc8181;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #fc8181;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #fc8181;
            color: white;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment {
            padding: 10px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #2d3748;
            font-size: 14px;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
        }

        .comment-input button {
            padding: 10px 20px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .rank.top3 {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #2d3748;
        }

        .leaderboard-items {
            font-size: 12px;
            color: #a0aec0;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #4a5568;
            font-size: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .category-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: inherit;
            background: white;
        }

        .category-select:focus {
            outline: none;
            border-color: #4a5568;
        }

        .points-info {
            background: #f7fafc;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #48bb78;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4a5568;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version {
            text-align: center;
            color: white;
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }

        .badge-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .badge-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .badge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .badge-modal-overlay.show {
            display: block;
        }

        .badge-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .badge-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .badge-desc {
            color: #718096;
            margin-bottom: 20px;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 40px 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #718096;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            margin-bottom: 12px;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .social-btn:active {
            transform: translateY(0);
        }

        .social-btn-google {
            background: white;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .social-btn-google svg {
            width: 20px;
            height: 20px;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #f7fafc;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: #e2e8f0;
            color: #4a5568;
        }

        .user-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4a5568;
        }

        .user-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .user-provider-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            background: #4285F4;
            color: white;
        }

        .lang-switch {
            text-align: center;
            margin-top: 10px;
        }

        .lang-switch a {
            color: white;
            opacity: 0.7;
            font-size: 12px;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .lang-switch a:hover {
            opacity: 1;
        }

        /* Space Bingo Styles */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            position: relative;
        }

        .bingo-cell.completed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-color: #38a169;
            color: white;
        }

        .bingo-cell .cell-emoji {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .bingo-cell .cell-name {
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
        }

        .bingo-cell.completed .cell-name {
            color: white;
        }

        .bingo-cell .cell-count {
            font-size: 10px;
            color: #718096;
            margin-top: 2px;
        }

        .bingo-cell.completed .cell-count {
            color: rgba(255, 255, 255, 0.9);
        }

        .bingo-cell .cell-progress {
            width: 80%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .bingo-cell.completed .cell-progress {
            background: rgba(255, 255, 255, 0.3);
        }

        .bingo-cell .cell-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .bingo-cell.completed .cell-progress-bar {
            background: white;
        }

        .bingo-lines-info {
            background: #f7fafc;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .bingo-lines-info .line-count {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .bingo-lines-info .line-label {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .bingo-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bingo-stat {
            background: #f7fafc;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
        }

        .bingo-stat .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }

        .bingo-stat .stat-label {
            font-size: 11px;
            color: #718096;
            margin-top: 4px;
        }

        .bingo-reset-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .space-hint {
            font-size: 13px;
            color: #48bb78;
            font-weight: 600;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f0fff4;
            border-radius: 8px;
            display: none;
        }

        /* Achievement Animation */
        .achievement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .achievement-overlay.show {
            display: flex;
        }

        .achievement-badge {
            font-size: 120px;
            animation: spinBadge 2s ease-in-out infinite;
        }

        @keyframes spinBadge {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .achievement-title {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }

        .achievement-subtitle {
            color: white;
            font-size: 18px;
            margin-top: 10px;
            text-align: center;
        }

        .achievement-points {
            color: #48bb78;
            font-size: 36px;
            font-weight: bold;
            margin-top: 15px;
        }

        .achievement-dismiss {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 30px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 3001;
            pointer-events: none;
            animation: confettiFall 3s ease-in-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
```

</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">ğŸ¯</div>
            <div class="login-title">ë¬¼ê±´ ë¹„ìš°ê¸° ì±Œë¦°ì§€</div>
            <div class="login-subtitle">ì†Œì…œ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”</div>

            <button class="social-btn social-btn-google" id="googleLoginBtn">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Googleë¡œ ì‹œì‘í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            <div class="online-badge">
                <div class="online-dot"></div>
                ì˜¨ë¼ì¸
            </div>
            <h1>ğŸ¯ ë¬¼ê±´ ë¹„ìš°ê¸° ì±Œë¦°ì§€</h1>
            <div class="score-display" id="totalScore">0</div>
            <div class="score-label">ì´ íšë“ í¬ì¸íŠ¸</div>
            <div class="streak-badge" id="streakBadge">ğŸ”¥ 0ì¼ ì—°ì†</div>
            <div class="user-profile" id="userProfile">
                <div class="user-avatar-placeholder" id="userAvatar">?</div>
                <input type="text" class="username-input" id="usernameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="15">
                <span class="user-provider-badge" id="providerBadge"></span>
            </div>
            <div class="badges-container" id="badgesContainer"></div>
        </div>

        <div class="tabs">
            <button class="tab active" id="addTabBtn">â• ë¹„ìš°ê¸°</button>
            <button class="tab" id="bingoTabBtn">ğŸ² ë¹™ê³ </button>
            <button class="tab" id="historyTabBtn">ğŸ“‹ ê¸°ë¡</button>
            <button class="tab" id="calendarTabBtn">ğŸ“… ìº˜ë¦°ë”</button>
            <button class="tab" id="leaderboardTabBtn">ğŸ† ìˆœìœ„</button>
            <button class="tab" id="shareTabBtn">ğŸ“¤ ê³µìœ </button>
        </div>

        <div id="addTab" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ë¹„ìš°ê¸° ì¸ì¦</h2>
                
                <div class="upload-area" id="uploadArea">
                    <img id="previewImage" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°">
                    <div id="uploadPrompt">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div style="color: #667eea; font-weight: 600;">ì‚¬ì§„ ì¶”ê°€</div>
                        <div style="color: #999; font-size: 14px; margin-top: 5px;">ë¹„ìš´ ë¬¼ê±´ì„ ì¸ì¦í•˜ì„¸ìš”</div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*">

                <input type="text" id="itemName" placeholder="ë¬¼ê±´ ì´ë¦„ (ì˜ˆ: ì˜¤ë˜ëœ ì˜·)">
                
                <select class="category-select" id="itemCategory">
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                    <option value="clothes">ì˜ë¥˜ (+10ì )</option>
                    <option value="books">ì±…/ì¡ì§€ (+15ì )</option>
                    <option value="electronics">ì „ìì œí’ˆ (+20ì )</option>
                    <option value="furniture">ê°€êµ¬ (+30ì )</option>
                    <option value="kitchen">ì£¼ë°©ìš©í’ˆ (+10ì )</option>
                    <option value="shoes">ì‹ ë°œ (+10ì )</option>
                    <option value="food">ìŒì‹ (+5ì )</option>
                    <option value="toys">ì¥ë‚œê° (+5ì )</option>
                    <option value="sports">ìš´ë™ìš©í’ˆ (+15ì )</option>
                    <option value="digital">ë””ì§€í„¸ ì‚¬ì§„/ë¬¸ì„œ (+5ì )</option>
                    <option value="etc">ê¸°íƒ€ (+5ì )</option>
                </select>

                <select class="category-select" id="itemSpace">
                    <option value="">ê³µê°„ ì„ íƒ (í•„ìˆ˜)</option>
                    <option value="kitchen_space">ğŸ³ ì£¼ë°©</option>
                    <option value="bathroom">ğŸš¿ ìš•ì‹¤</option>
                    <option value="bedroom">ğŸ›ï¸ ì¹¨ì‹¤</option>
                    <option value="living">ğŸ›‹ï¸ ê±°ì‹¤</option>
                    <option value="kids_room">ğŸ§’ ì•„ì´ë°©</option>
                    <option value="closet">ğŸ‘” ì˜·ì¥</option>
                    <option value="office">ğŸ’» ì„œì¬</option>
                    <option value="garage">ğŸ”§ ì°½ê³ </option>
                    <option value="pantry">ğŸ¥« íŒ¬íŠ¸ë¦¬</option>
                </select>
                <div class="space-hint" id="spaceHint"></div>

                <div class="points-info" id="pointsInfo" style="display: none;">
                    ì˜ˆìƒ íšë“ í¬ì¸íŠ¸: <span id="expectedPoints">0</span>ì 
                </div>

                <textarea id="itemNote" placeholder="ëŠë‚€ì  (ì„ íƒ)"></textarea>

                <button class="btn" id="submitBtn">âœ… ë¹„ìš°ê¸° ì™„ë£Œ!</button>
            </div>
        </div>

        <div id="bingoTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ² ê³µê°„ ë¹™ê³ </h2>
                <p style="color: #666; margin-bottom: 15px; text-align: center; font-size: 14px;">ê° ê³µê°„ì—ì„œ 10ê°œë¥¼ ë¹„ìš°ë©´ ë¹™ê³ ! ì¤„ì„ ì™„ì„±í•˜ì„¸ìš”!</p>

                <div class="bingo-stats">
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoCompleted">0</div>
                        <div class="stat-label">ì™„ë£Œ ê³µê°„</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoLines">0</div>
                        <div class="stat-label">ë¹™ê³  ì¤„</div>
                    </div>
                    <div class="bingo-stat">
                        <div class="stat-value" id="bingoPoints">0</div>
                        <div class="stat-label">ë¹™ê³  ì ìˆ˜</div>
                    </div>
                </div>

                <div class="bingo-grid" id="bingoGrid"></div>

                <div class="bingo-lines-info" id="bingoLinesInfo">
                    <div class="line-count" id="bingoLineCount">0 / 8 ì¤„</div>
                    <div class="line-label">ê°€ë¡œ 3ì¤„ + ì„¸ë¡œ 3ì¤„ + ëŒ€ê°ì„  2ì¤„</div>
                </div>

                <button class="bingo-reset-btn" id="bingoResetBtn">ğŸ”„ ë¹™ê³  ë¦¬ì…‹í•˜ê¸°</button>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ëª¨ë‘ì˜ ë¹„ìš°ê¸° ê¸°ë¡</h2>
                <div class="item-list" id="itemList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
        </div>

        <div id="calendarTab" class="tab-content">
            <div class="card" style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <button id="prevMonthBtn" style="background: none; border: 2px solid #667eea; color: #667eea; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">â†</button>
                    <h2 id="calendarTitle" style="color: #333; margin: 0; font-size: 16px;">2026ë…„ 2ì›”</h2>
                    <button id="nextMonthBtn" style="background: none; border: 2px solid #667eea; color: #667eea; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">â†’</button>
                </div>
                <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;"></div>
                <div style="margin-top: 12px; padding: 10px; background: #f8f9ff; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; justify-content: center; font-size: 11px;">
                        <span>ğŸ”¥ ë¹„ìš´ ë‚ </span>
                        <span style="color: #999;">âšª ì•ˆ ë¹„ìš´ ë‚ </span>
                    </div>
                </div>
                <div id="monthStats" style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; text-align: center;">
                    <div style="font-size: 11px; opacity: 0.9;">ì´ë²ˆ ë‹¬ í†µê³„</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 6px 0;" id="monthItemCount">0</div>
                    <div style="font-size: 11px; opacity: 0.9;">ê°œ ë¹„ì›€ â€¢ <span id="monthPoints">0</span>ì  íšë“</div>
                </div>
            </div>
        </div>

        <div id="leaderboardTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ì „ì²´ ìˆœìœ„</h2>
                <div id="leaderboardList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
        </div>

        <div id="shareTab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“¤ ìŠ¤í† ë¦¬ ê³µìœ </h2>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">í…œí”Œë¦¿ì„ ì„ íƒí•˜ê³  ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•´ì„œ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ì— ê³µìœ í•˜ì„¸ìš”!</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button id="minimalBtn" style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        âœ¨ ë¯¸ë‹ˆë©€
                    </button>
                    <button id="statsBtn" style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        ğŸ“Š í†µê³„
                    </button>
                    <button id="streakBtn" style="padding: 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        ğŸ”¥ ì—°ì†ê¸°ë¡
                    </button>
                    <button id="gridBtn" style="padding: 15px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        ğŸ“¸ ì‚¬ì§„ê·¸ë¦¬ë“œ
                    </button>
                </div>

                <canvas id="storyCanvas" style="width: 100%; max-width: 400px; margin: 0 auto; display: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);"></canvas>
                
                <div id="downloadSection" style="display: none; text-align: center; margin-top: 20px;">
                    <button id="downloadBtn" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;">
                        ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <p style="color: #999; font-size: 13px; margin-top: 10px;">ë‹¤ìš´ë¡œë“œ í›„ ì¸ìŠ¤íƒ€ê·¸ë¨ ìŠ¤í† ë¦¬ì— ì—…ë¡œë“œí•˜ì„¸ìš”!</p>
                </div>
            </div>
        </div>

        <div class="version">v2.4 - ê³µê°„ ë¹™ê³  ì¶”ê°€</div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal-overlay" id="badgeOverlay"></div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-icon" id="badgeModalIcon">ğŸ†</div>
        <div class="badge-title" id="badgeModalTitle">ìƒˆ ë°°ì§€ íšë“!</div>
        <div class="badge-desc" id="badgeModalDesc">ì²« ë¬¼ê±´ ë¹„ìš°ê¸° ì„±ê³µ!</div>
        <button class="btn" id="closeModalBtn">í™•ì¸</button>
    </div>

    <!-- Achievement Overlay -->
    <div class="achievement-overlay" id="achievementOverlay">
        <div class="achievement-badge" id="achievementBadge">ğŸ†</div>
        <div class="achievement-title" id="achievementTitle">ê³µê°„ ì™„ë£Œ!</div>
        <div class="achievement-subtitle" id="achievementSubtitle">ì£¼ë°© 10ê°œ ë¹„ìš°ê¸° ë‹¬ì„±!</div>
        <div class="achievement-points" id="achievementPoints">+100ì </div>
        <div class="achievement-dismiss">íƒ­í•˜ì—¬ ë‹«ê¸°</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion, arrayRemove, increment, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCgRc0r845aR7tTS7GNUmm8TMdLtSzeljY",
            authDomain: "declutter-challenge-94366.firebaseapp.com",
            projectId: "declutter-challenge-94366",
            storageBucket: "declutter-challenge-94366.firebasestorage.app",
            messagingSenderId: "781105372309",
            appId: "1:781105372309:web:4ce495d1dc8eac2b0d8f9c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUserId = localStorage.getItem('userId') || null;
        let userName = localStorage.getItem('userName') || '';
        let totalScore = 0;
        let currentImage = null;
        let userStreak = 0;
        let userBadges = [];
        let bingoProgress = {};

        const bingoSpaces = [
            { key: 'kitchen_space', name: 'ì£¼ë°©', emoji: 'ğŸ³' },
            { key: 'bathroom', name: 'ìš•ì‹¤', emoji: 'ğŸš¿' },
            { key: 'bedroom', name: 'ì¹¨ì‹¤', emoji: 'ğŸ›ï¸' },
            { key: 'living', name: 'ê±°ì‹¤', emoji: 'ğŸ›‹ï¸' },
            { key: 'kids_room', name: 'ì•„ì´ë°©', emoji: 'ğŸ§’' },
            { key: 'closet', name: 'ì˜·ì¥', emoji: 'ğŸ‘”' },
            { key: 'office', name: 'ì„œì¬', emoji: 'ğŸ’»' },
            { key: 'garage', name: 'ì°½ê³ ', emoji: 'ğŸ”§' },
            { key: 'pantry', name: 'íŒ¬íŠ¸ë¦¬', emoji: 'ğŸ¥«' }
        ];

        const bingoLines = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        function getSpaceName(spaceKey) {
            const space = bingoSpaces.find(s => s.key === spaceKey);
            return space ? space.name : spaceKey;
        }

        function countBingoLines() {
            let count = 0;
            for (const line of bingoLines) {
                const allComplete = line.every(i => (bingoProgress[bingoSpaces[i].key] || 0) >= 10);
                if (allComplete) count++;
            }
            return count;
        }

        function countCompletedSpaces() {
            return bingoSpaces.filter(s => (bingoProgress[s.key] || 0) >= 10).length;
        }

        function renderBingoGrid() {
            const grid = document.getElementById('bingoGrid');
            if (!grid) return;

            const completedCount = countCompletedSpaces();
            const lineCount = countBingoLines();
            const bingoPointsEarned = completedCount * 100 + lineCount * 500 + (completedCount === 9 ? 3000 : 0);

            document.getElementById('bingoCompleted').textContent = completedCount;
            document.getElementById('bingoLines').textContent = lineCount;
            document.getElementById('bingoPoints').textContent = bingoPointsEarned;
            document.getElementById('bingoLineCount').textContent = `${lineCount} / 8 ì¤„`;

            const resetBtn = document.getElementById('bingoResetBtn');
            resetBtn.style.display = completedCount === 9 ? 'block' : 'none';

            grid.innerHTML = bingoSpaces.map(space => {
                const count = bingoProgress[space.key] || 0;
                const isComplete = count >= 10;
                const percent = Math.min(100, (count / 10) * 100);

                return `
                    <div class="bingo-cell ${isComplete ? 'completed' : ''}">
                        <div class="cell-emoji">${space.emoji}</div>
                        <div class="cell-name">${space.name}</div>
                        <div class="cell-count">${count} / 10</div>
                        <div class="cell-progress">
                            <div class="cell-progress-bar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSpaceHint() {
            const spaceSelect = document.getElementById('itemSpace');
            const hint = document.getElementById('spaceHint');
            const spaceKey = spaceSelect.value;

            if (spaceKey) {
                const count = bingoProgress[spaceKey] || 0;
                const space = bingoSpaces.find(s => s.key === spaceKey);
                if (count >= 10) {
                    hint.textContent = `${space.name}: âœ… ì™„ë£Œ! ë¹™ê³  ë‹¬ì„±!`;
                } else {
                    const remaining = 10 - count;
                    hint.textContent = `${space.name}: ${count}/10 - ${remaining}ê°œ ë”! ğŸ¯`;
                }
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }

        function showAchievement(title, subtitle, points) {
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementSubtitle').textContent = subtitle;
            document.getElementById('achievementPoints').textContent = `+${points}ì `;
            document.getElementById('achievementOverlay').classList.add('show');

            playVictorySound();
            spawnConfetti();
        }

        function hideAchievement() {
            document.getElementById('achievementOverlay').classList.remove('show');
        }

        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                const now = audioContext.currentTime;

                const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.12);
                    gain.gain.setValueAtTime(0.3, now + i * 0.12);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.12 + 0.2);
                    osc.start(now + i * 0.12);
                    osc.stop(now + i * 0.12 + 0.2);
                });
            } catch (error) {
                console.error('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', error);
            }
        }

        function spawnConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#48bb78', '#4299e1', '#ed64a6', '#ecc94b', '#9f7aea', '#fc8181', '#68d391', '#63b3ed'];
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 8 + 6) + 'px';
                confetti.style.height = (Math.random() * 8 + 6) + 'px';
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        async function loadBingoProgress() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    bingoProgress = userData.bingoProgress || {};
                } else {
                    bingoProgress = {};
                }
                renderBingoGrid();
                updateSpaceHint();
            } catch (error) {
                console.error('ë¹™ê³  ì§„í–‰ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function updateBingoProgress(spaceKey) {
            const oldCount = bingoProgress[spaceKey] || 0;
            const oldLines = countBingoLines();
            const oldCompleted = countCompletedSpaces();

            bingoProgress[spaceKey] = oldCount + 1;
            const newCount = bingoProgress[spaceKey];

            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: bingoProgress
                    });
                }
            } catch (error) {
                console.error('ë¹™ê³  ì§„í–‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }

            if (newCount === 10) {
                const spaceName = getSpaceName(spaceKey);
                let bonusPoints = 100;
                totalScore += bonusPoints;

                await saveBonusPoints(bonusPoints);

                const newLines = countBingoLines();
                const linesEarned = newLines - oldLines;
                if (linesEarned > 0) {
                    const lineBonus = linesEarned * 500;
                    totalScore += lineBonus;
                    bonusPoints += lineBonus;
                    await saveBonusPoints(lineBonus);
                }

                const newCompleted = countCompletedSpaces();
                if (newCompleted === 9 && oldCompleted < 9) {
                    const allBonus = 3000;
                    totalScore += allBonus;
                    bonusPoints += allBonus;
                    await saveBonusPoints(allBonus);
                }

                document.getElementById('totalScore').textContent = totalScore;

                setTimeout(() => {
                    if (newCompleted === 9 && oldCompleted < 9) {
                        showAchievement('ğŸ‰ ë¹™ê³  ì˜¬í´ë¦¬ì–´!', 'ëª¨ë“  9ê°œ ê³µê°„ ì™„ë£Œ!', bonusPoints);
                    } else if (linesEarned > 0) {
                        showAchievement('ğŸ² ë¹™ê³ !', `${spaceName} ì™„ë£Œ + ${linesEarned}ì¤„ ë¹™ê³ !`, bonusPoints);
                    } else {
                        showAchievement('âœ¨ ê³µê°„ ì™„ë£Œ!', `${spaceName} 10ê°œ ë¹„ìš°ê¸° ë‹¬ì„±!`, bonusPoints);
                    }
                }, 500);
            }

            renderBingoGrid();
            updateSpaceHint();
        }

        async function saveBonusPoints(points) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore
                    });
                }
            } catch (error) {
                console.error('ë³´ë„ˆìŠ¤ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        async function resetBingo() {
            if (!confirm('ë¹™ê³ ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;

            bingoProgress = {};
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        bingoProgress: {}
                    });
                }
            } catch (error) {
                console.error('ë¹™ê³  ë¦¬ì…‹ ì‹¤íŒ¨:', error);
            }
            renderBingoGrid();
        }

        // ëª…ì–¸ ë°°ì—´
        const declutterQuotes = [
            "ìˆìœ¼ë©´ ìˆœê°„ í¸í•˜ì§€ë§Œ\nì—†ìœ¼ë©´ í‰ìƒ í¸í•˜ë‹¤",
            "ì‚¬ì§€ ì•Šìœ¼ë©´\në²„ë¦´ ê²ƒë„ ì—†ë‹¤",
            "ì‚¬ëŒì€ ì‚¬ë‘í•˜ê³ \në¬¼ê±´ì€ ì‚¬ìš©í•˜ë¼",
            "ì‚´ë• ë³´ë¬¼\níŒ”ë• ê³ ë¬¼",
            "ë¹„ì›€ì€ ì±„ì›€ì˜ ì‹œì‘ì´ë‹¤",
            "ì†Œìœ ê°€ ì ì„ìˆ˜ë¡ ììœ ë¡­ë‹¤",
            "ë¬¼ê±´ì´ ì¤„ë©´ ë§ˆìŒì´ ê°€ë²¼ì›Œì§„ë‹¤",
            "Less is more",
            "ë‹¨ìˆœí•¨ì´ ìµœê³ ì˜ ì•„ë¦„ë‹¤ì›€ì´ë‹¤",
            "í•„ìš”í•œ ê²ƒë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ë²„ë ¤ë¼",
            "ì •ë¦¬ëŠ” ì¸ìƒì„ ë°”ê¾¸ëŠ” ë§ˆë²•ì´ë‹¤"
        ];

        function getRandomQuote() {
            return declutterQuotes[Math.floor(Math.random() * declutterQuotes.length)];
        }

        function showQuoteModal(quote, points, aiMessage, totalScore) {
            document.getElementById('badgeModalIcon').textContent = 'âœ¨';
            document.getElementById('badgeModalTitle').innerHTML = quote.replace(/\n/g, '<br>');
            document.getElementById('badgeModalDesc').innerHTML = `
                ğŸ‰ +${points}ì  íšë“!<br><br>
                ${aiMessage}<br><br>
                <strong>ì´ ${totalScore}ì </strong>
            `;
            document.getElementById('badgeModal').classList.add('show');
            document.getElementById('badgeOverlay').classList.add('show');
        }

        const categoryPoints = {
            'clothes': 10,
            'books': 15,
            'electronics': 20,
            'furniture': 30,
            'kitchen': 10,
            'shoes': 10,
            'food': 5,
            'toys': 5,
            'sports': 15,
            'digital': 5,
            'etc': 5
        };

        const badges = {
            'first_item': { icon: 'ğŸ¯', name: 'ì²« ê±¸ìŒ', desc: 'ì²« ë¬¼ê±´ ë¹„ìš°ê¸°', condition: (count) => count >= 1 },
            'five_items': { icon: 'â­', name: 'ì—´ì •', desc: '5ê°œ ë¹„ìš°ê¸°', condition: (count) => count >= 5 },
            'ten_items': { icon: 'ğŸ’', name: 'ê²°ë‹¨ë ¥', desc: '10ê°œ ë¹„ìš°ê¸°', condition: (count) => count >= 10 },
            'twenty_items': { icon: 'ğŸ‘‘', name: 'ë¹„ìš°ê¸°ì™•', desc: '20ê°œ ë¹„ìš°ê¸°', condition: (count) => count >= 20 },
            'streak_3': { icon: 'ğŸ”¥', name: 'ê¾¸ì¤€í•¨', desc: '3ì¼ ì—°ì†', condition: (streak) => streak >= 3, isStreak: true },
            'streak_7': { icon: 'ğŸ’ª', name: 'ìŠµê´€', desc: '7ì¼ ì—°ì†', condition: (streak) => streak >= 7, isStreak: true },
            'streak_30': { icon: 'ğŸ…', name: 'ë‹¬ì¸', desc: '30ì¼ ì—°ì†', condition: (streak) => streak >= 30, isStreak: true }
        };

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function hideLoginScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
        }

        function updateProfileUI() {
            const provider = localStorage.getItem('authProvider');
            const photo = localStorage.getItem('userPhoto');
            const avatarEl = document.getElementById('userAvatar');
            const badgeEl = document.getElementById('providerBadge');

            if (photo) {
                avatarEl.outerHTML = `<img src="${photo}" alt="í”„ë¡œí•„" class="user-avatar" id="userAvatar" referrerpolicy="no-referrer">`;
            } else {
                avatarEl.outerHTML = `<div class="user-avatar-placeholder" id="userAvatar">${(userName || '?').charAt(0)}</div>`;
            }

            if (provider === 'google') {
                badgeEl.textContent = 'Google';
                badgeEl.style.display = 'inline-block';
            }
        }

        async function handleGoogleLogin() {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                currentUserId = 'google_' + user.uid;
                userName = user.displayName || 'Googleì‚¬ìš©ì';
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('userName', userName);
                localStorage.setItem('authProvider', 'google');
                localStorage.setItem('userPhoto', user.photoURL || '');
                document.getElementById('usernameInput').value = userName;
                updateProfileUI();
                hideLoginScreen();
                await initApp();
            } catch (error) {
                console.error('Google ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ Google ë¡œê·¸ì¸ì„ í™œì„±í™”í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Googleë¡œ ì‹œì‘í•˜ê¸°`;
            }
        }

        async function handleLogout() {
            if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const provider = localStorage.getItem('authProvider');

            try {
                if (provider === 'google') {
                    await signOut(auth);
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
            }

            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('authProvider');
            localStorage.removeItem('userPhoto');
            currentUserId = null;
            userName = '';
            totalScore = 0;
            userStreak = 0;
            userBadges = [];
            showLoginScreen();
        }

        async function updateUserProfile() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: 0,
                        itemCount: 0,
                        streak: 0,
                        lastDeclutterDate: null,
                        badges: [],
                        bingoProgress: {},
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        async function generateAIEncouragement(itemName, category, points, totalScore, streak) {
            try {
                const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
                const itemsSnapshot = await getDocs(itemsQuery);
                
                const categoryCount = {};
                itemsSnapshot.forEach(doc => {
                    const data = doc.data();
                    categoryCount[data.category] = (categoryCount[data.category] || 0) + 1;
                });

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 150,
                        messages: [{
                            role: 'user',
                            content: `ì‚¬ìš©ìê°€ ë¯¸ë‹ˆë©€ë¦¬ì¦˜ ì±Œë¦°ì§€ì—ì„œ "${itemName}" (${getCategoryName(category)})ì„ ë¹„ì› ìŠµë‹ˆë‹¤.

í˜„ì¬ ìƒíƒœ:
- íšë“ ì ìˆ˜: ${points}ì 
- ì´ ì ìˆ˜: ${totalScore}ì 
- ì—°ì† ì¼ìˆ˜: ${streak}ì¼
- ì¹´í…Œê³ ë¦¬ë³„ í†µê³„: ${JSON.stringify(categoryCount)}

ì§§ê³  ë”°ëœ»í•œ ì‘ì› ë©”ì‹œì§€ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ì´ëª¨ì§€ 1-2ê°œ í¬í•¨. 
ìŠ¤íƒ€ì¼: ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤, êµ¬ì²´ì ì¸ ì¹­ì°¬, ê°€ë” ë‹¤ìŒ ì¶”ì²œ.`
                        }]
                    })
                });

                if (!response.ok) throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                const data = await response.json();
                return data.content[0].text.trim();
            } catch (error) {
                console.error('AI ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨:', error);
                const defaultMessages = [
                    "ì •ë¦¬ ì™„ë£Œ! í•œ ê±¸ìŒì”© ë‚˜ì•„ê°€ê³  ìˆì–´ìš” âœ¨",
                    "ë©‹ì ¸ìš”! ë¹„ìš°ëŠ” ìŠµê´€ì´ ëª¸ì— ë°°ê³  ìˆë„¤ìš” ğŸ’ª",
                    "ëŒ€ë‹¨í•´ìš”! ê³µê°„ë„ ë§ˆìŒë„ ê°€ë²¼ì›Œì§€ê³  ìˆì–´ìš” ğŸˆ",
                    "ì˜í•˜ê³  ìˆì–´ìš”! ì´ ì†ë„ë©´ ë¯¸ë‹ˆë©€ ë‹¬ì¸ ğŸŒŸ",
                    "í›Œë¥­í•´ìš”! ì •ë¦¬ì˜ ì¦ê±°ì›€ì„ ëŠë¼ê³  ê³„ì‹œë„¤ìš” ğŸ¯"
                ];
                return defaultMessages[Math.floor(Math.random() * defaultMessages.length)];
            }
        }

        function getCategoryName(category) {
            const names = {
                'clothes': 'ì˜ë¥˜',
                'books': 'ì±…/ì¡ì§€',
                'electronics': 'ì „ìì œí’ˆ',
                'furniture': 'ê°€êµ¬',
                'kitchen': 'ì£¼ë°©ìš©í’ˆ',
                'shoes': 'ì‹ ë°œ',
                'food': 'ìŒì‹',
                'toys': 'ì¥ë‚œê°',
                'sports': 'ìš´ë™ìš©í’ˆ',
                'digital': 'ë””ì§€í„¸ ì‚¬ì§„/ë¬¸ì„œ',
                'etc': 'ê¸°íƒ€'
            };
            return names[category] || category;
        }

        async function calculateStreak() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const lastDate = userData.lastDeclutterDate?.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (lastDate) {
                        const lastDateOnly = new Date(lastDate);
                        lastDateOnly.setHours(0, 0, 0, 0);
                        
                        const diffTime = today - lastDateOnly;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            userStreak = userData.streak || 0;
                        } else if (diffDays === 1) {
                            userStreak = (userData.streak || 0) + 1;
                        } else {
                            userStreak = 1;
                        }
                    } else {
                        userStreak = 1;
                    }
                    
                    await updateDoc(doc(db, 'users', userSnapshot.docs[0].id), {
                        streak: userStreak,
                        lastDeclutterDate: serverTimestamp()
                    });
                    
                    document.getElementById('streakBadge').textContent = `ğŸ”¥ ${userStreak}ì¼ ì—°ì†`;
                    checkBadges(null, userStreak);
                }
            } catch (error) {
                console.error('ìŠ¤íŠ¸ë¦­ ê³„ì‚° ì‹¤íŒ¨:', error);
            }
        }

        async function checkBadges(itemCount = null, streak = null) {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    userBadges = userData.badges || [];
                    
                    const currentCount = itemCount !== null ? itemCount : userData.itemCount || 0;
                    const currentStreak = streak !== null ? streak : userData.streak || 0;
                    
                    for (const [key, badge] of Object.entries(badges)) {
                        if (!userBadges.includes(key)) {
                            const earned = badge.isStreak 
                                ? badge.condition(currentStreak)
                                : badge.condition(currentCount);
                                
                            if (earned) {
                                userBadges.push(key);
                                await updateDoc(doc(db, 'users', userDoc.id), {
                                    badges: arrayUnion(key)
                                });
                                showBadgeModal(badge);
                            }
                        }
                    }
                    
                    renderBadges();
                }
            } catch (error) {
                console.error('ë°°ì§€ ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }

        function renderBadges() {
            const container = document.getElementById('badgesContainer');
            container.innerHTML = Object.entries(badges).map(([key, badge]) => {
                const earned = userBadges.includes(key);
                return `
                    <div class="badge ${earned ? '' : 'locked'}" title="${badge.desc}">
                        ${badge.icon} ${badge.name}
                    </div>
                `;
            }).join('');
        }

        function showBadgeModal(badge) {
            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalTitle').textContent = `${badge.name} ë°°ì§€ íšë“!`;
            document.getElementById('badgeModalDesc').textContent = badge.desc;
            document.getElementById('badgeModal').classList.add('show');
            document.getElementById('badgeOverlay').classList.add('show');
        }

        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.remove('show');
            document.getElementById('badgeOverlay').classList.remove('show');
        }

        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.type = 'square';
                osc1.frequency.setValueAtTime(523.25, now);
                gain1.gain.setValueAtTime(0.3, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(659.25, now + 0.15);
                gain2.gain.setValueAtTime(0.3, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
                
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.type = 'square';
                osc3.frequency.setValueAtTime(783.99, now + 0.3);
                gain3.gain.setValueAtTime(0.3, now + 0.3);
                gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                osc3.start(now + 0.3);
                osc3.stop(now + 0.45);
                
                const osc4 = audioContext.createOscillator();
                const gain4 = audioContext.createGain();
                osc4.connect(gain4);
                gain4.connect(audioContext.destination);
                osc4.type = 'square';
                osc4.frequency.setValueAtTime(1046.50, now + 0.45);
                gain4.gain.setValueAtTime(0.35, now + 0.45);
                gain4.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc4.start(now + 0.45);
                osc4.stop(now + 0.9);
            } catch (error) {
                console.error('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', error);
            }
        }

        function compressImage(file, maxSizeKB = 500) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 800;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.7;
                        let compressed = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressed = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const space = document.getElementById('itemSpace').value;
            const note = document.getElementById('itemNote').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!name) {
                alert('ë¬¼ê±´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!category) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!space) {
                alert('ê³µê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!currentImage) {
                alert('ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                const points = categoryPoints[category];

                await addDoc(collection(db, 'items'), {
                    userId: currentUserId,
                    userName: userName,
                    name: name,
                    category: category,
                    space: space,
                    note: note,
                    image: currentImage,
                    points: points,
                    likes: [],
                    likeCount: 0,
                    comments: [],
                    createdAt: serverTimestamp()
                });

                totalScore += points;
                await updateUserScore();
                await calculateStreak();
                await updateBingoProgress(space);

                playSuccessSound();

                const aiMessage = await generateAIEncouragement(name, category, points, totalScore, userStreak);

                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemSpace').value = '';
                document.getElementById('itemNote').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('previewImage').classList.remove('show');
                document.getElementById('uploadPrompt').style.display = 'block';
                document.getElementById('uploadArea').classList.remove('has-image');
                document.getElementById('pointsInfo').style.display = 'none';
                document.getElementById('spaceHint').style.display = 'none';
                currentImage = null;

                const quote = getRandomQuote();
                showQuoteModal(quote, points, aiMessage, totalScore);

                switchTab('history');
            } catch (error) {
                console.error('ì•„ì´í…œ ì¶”ê°€ ì‹¤íŒ¨:', error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… ë¹„ìš°ê¸° ì™„ë£Œ!';
            }
        }

        async function updateUserScore() {
            try {
                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newItemCount = (userData.itemCount || 0) + 1;
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: totalScore,
                        itemCount: newItemCount,
                        name: userName,
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(newItemCount);
                } else {
                    await addDoc(collection(db, 'users'), {
                        userId: currentUserId,
                        name: userName,
                        score: totalScore,
                        itemCount: 1,
                        streak: 0,
                        badges: [],
                        createdAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });
                    
                    checkBadges(1);
                }
                
                document.getElementById('totalScore').textContent = totalScore;
            } catch (error) {
                console.error('ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        async function toggleLike(itemId, itemDocId) {
            try {
                const itemRef = doc(db, 'items', itemDocId);
                const itemSnapshot = await getDocs(query(collection(db, 'items'), where('__name__', '==', itemDocId)));
                
                if (!itemSnapshot.empty) {
                    const itemData = itemSnapshot.docs[0].data();
                    const likes = itemData.likes || [];
                    
                    if (likes.includes(currentUserId)) {
                        await updateDoc(itemRef, {
                            likes: arrayRemove(currentUserId),
                            likeCount: increment(-1)
                        });
                    } else {
                        await updateDoc(itemRef, {
                            likes: arrayUnion(currentUserId),
                            likeCount: increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:', error);
            }
        }

        function toggleComments(itemId) {
            const commentsSection = document.getElementById(`comments-${itemId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('show');
            }
        }

        async function addComment(itemId, itemDocId) {
            const input = document.getElementById(`comment-input-${itemId}`);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            try {
                const itemRef = doc(db, 'items', itemDocId);
                await updateDoc(itemRef, {
                    comments: arrayUnion({
                        userId: currentUserId,
                        userName: userName,
                        text: commentText,
                        createdAt: new Date().toISOString()
                    })
                });
                
                input.value = '';
            } catch (error) {
                console.error('ëŒ“ê¸€ ì¶”ê°€ ì‹¤íŒ¨:', error);
            }
        }

        async function deleteItem(itemDocId, itemUserId, itemPoints) {
            if (itemUserId !== currentUserId) {
                alert('ë³¸ì¸ì˜ ë¬¼ê±´ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }

            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'items', itemDocId));

                const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newScore = Math.max(0, (userData.score || 0) - itemPoints);
                    const newItemCount = Math.max(0, (userData.itemCount || 0) - 1);
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        score: newScore,
                        itemCount: newItemCount
                    });

                    totalScore = newScore;
                    document.getElementById('totalScore').textContent = totalScore;
                }

                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function loadMyItems() {
            const listElement = document.getElementById('itemList');
            
            try {
                const itemsQuery = query(collection(db, 'items'), orderBy('createdAt', 'desc'), limit(50));

                onSnapshot(itemsQuery, (snapshot) => {
                    const items = [];
                    let myScore = 0;
                    
                    snapshot.forEach((docSnapshot) => {
                        const item = docSnapshot.data();
                        items.push({
                            ...item,
                            id: docSnapshot.id,
                            docId: docSnapshot.id
                        });
                        if (item.userId === currentUserId) {
                            myScore += item.points || 0;
                        }
                    });

                    totalScore = myScore;
                    document.getElementById('totalScore').textContent = totalScore;

                    if (items.length === 0) {
                        listElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ“¦</div>
                                <div>ì•„ì§ ë¹„ìš´ ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                <div style="font-size: 14px; margin-top: 10px;">ì²« ë¬¼ê±´ì„ ë¹„ì›Œë³´ì„¸ìš”!</div>
                            </div>
                        `;
                        return;
                    }

                    listElement.innerHTML = items.map(item => {
                        const date = item.createdAt?.toDate() || new Date();
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        const isMyItem = item.userId === currentUserId;
                        const isLiked = (item.likes || []).includes(currentUserId);
                        const likeCount = item.likeCount || 0;
                        const comments = item.comments || [];
                        const hasNote = item.note && item.note.trim();
                        
                        return `
                            <div class="item" style="${isMyItem ? 'background: #f8f9ff;' : ''}">
                                <div class="item-header">
                                    <img src="${item.image}" alt="${item.name}" class="item-image">
                                    <div class="item-info">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-date">${item.userName || 'ìµëª…'} â€¢ ${dateStr}</div>
                                        ${hasNote ? `<div class="item-note">ğŸ’­ "${item.note}"</div>` : ''}
                                    </div>
                                    <div class="item-points">+${item.points}</div>
                                </div>
                                <div class="item-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="window.toggleLike('${item.id}', '${item.docId}')">
                                        â¤ï¸ ${likeCount}
                                    </button>
                                    <button class="comment-btn" onclick="window.toggleComments('${item.id}')">
                                        ğŸ’¬ ${comments.length}
                                    </button>
                                    ${isMyItem ? `<button class="delete-btn" onclick="window.deleteItem('${item.docId}', '${item.userId}', ${item.points})">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
                                </div>
                                <div class="comments-section" id="comments-${item.id}">
                                    ${comments.map(c => `
                                        <div class="comment">
                                            <div class="comment-author">${c.userName}</div>
                                            <div class="comment-text">${c.text}</div>
                                        </div>
                                    `).join('')}
                                    <div class="comment-input">
                                        <input type="text" id="comment-input-${item.id}" placeholder="ëŒ“ê¸€ ì…ë ¥...">
                                        <button onclick="window.addComment('${item.id}', '${item.docId}')">ë“±ë¡</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('ì•„ì´í…œ ë¡œë“œ ì‹¤íŒ¨:', error);
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
                    </div>
                `;
            }
        }

        async function loadLeaderboard() {
            const leaderboardElement = document.getElementById('leaderboardList');
            
            try {
                const usersQuery = query(collection(db, 'users'), orderBy('score', 'desc'), limit(20));

                onSnapshot(usersQuery, (snapshot) => {
                    const users = [];
                    
                    snapshot.forEach((docSnapshot) => {
                        const user = docSnapshot.data();
                        users.push(user);
                    });

                    if (users.length === 0) {
                        leaderboardElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ†</div>
                                <div>ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            </div>
                        `;
                        return;
                    }

                    leaderboardElement.innerHTML = users.map((user, index) => {
                        const isCurrentUser = user.userId === currentUserId;
                        const rank = index + 1;
                        const rankClass = rank <= 3 ? 'top3' : '';
                        const userStreakVal = user.streak || 0;
                        
                        return `
                            <div class="leaderboard-item" style="${isCurrentUser ? 'background: #f8f9ff;' : ''}">
                                <div class="rank ${rankClass}">${rank}</div>
                                <div class="leaderboard-info">
                                    <div class="leaderboard-name">${user.name || 'ìµëª…'}${isCurrentUser ? ' ğŸ‘¤' : ''}</div>
                                    <div class="leaderboard-items">${user.itemCount || 0}ê°œ ë¹„ì›€ â€¢ ğŸ”¥ ${userStreakVal}ì¼</div>
                                </div>
                                <div class="leaderboard-score">${user.score || 0}</div>
                            </div>
                        `;
                    }).join('');
                });
            } catch (error) {
                console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'add') {
                document.getElementById('addTabBtn').classList.add('active');
                document.getElementById('addTab').classList.add('active');
                updateSpaceHint();
            } else if (tab === 'bingo') {
                document.getElementById('bingoTabBtn').classList.add('active');
                document.getElementById('bingoTab').classList.add('active');
                loadBingoProgress();
            } else if (tab === 'history') {
                document.getElementById('historyTabBtn').classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                loadMyItems();
            } else if (tab === 'calendar') {
                document.getElementById('calendarTabBtn').classList.add('active');
                document.getElementById('calendarTab').classList.add('active');
                renderCalendar();
            } else if (tab === 'leaderboard') {
                document.getElementById('leaderboardTabBtn').classList.add('active');
                document.getElementById('leaderboardTab').classList.add('active');
                loadLeaderboard();
            } else if (tab === 'share') {
                document.getElementById('shareTabBtn').classList.add('active');
                document.getElementById('shareTab').classList.add('active');
            }
        }

        let currentCalendarYear = 2026;
        let currentCalendarMonth = 1;
        let userItemDates = {};

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendarTitle');
            
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            title.textContent = `${currentCalendarYear}ë…„ ${monthNames[currentCalendarMonth]}`;
            
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            
            userItemDates = {};
            let monthItemCount = 0;
            let monthPoints = 0;
            
            itemsSnapshot.forEach(docSnapshot => {
                const item = docSnapshot.data();
                if (item.createdAt) {
                    const date = item.createdAt.toDate();
                    const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                    
                    if (!userItemDates[dateKey]) {
                        userItemDates[dateKey] = {
                            count: 0,
                            points: 0
                        };
                    }
                    userItemDates[dateKey].count += 1;
                    userItemDates[dateKey].points += item.points || 0;
                    
                    if (date.getFullYear() === currentCalendarYear && date.getMonth() === currentCalendarMonth) {
                        monthItemCount += 1;
                        monthPoints += item.points || 0;
                    }
                }
            });
            
            document.getElementById('monthItemCount').textContent = monthItemCount;
            document.getElementById('monthPoints').textContent = monthPoints;
            
            calendar.innerHTML = '';
            
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayNames.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = 'text-align: center; font-weight: 600; padding: 4px 2px; color: #666; font-size: 10px;';
                if (index === 0) dayHeader.style.color = '#ff4444';
                if (index === 6) dayHeader.style.color = '#4444ff';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentCalendarYear}-${currentCalendarMonth}-${day}`;
                const hasItem = userItemDates[dateKey];
                const isToday = new Date().getDate() === day && 
                               new Date().getMonth() === currentCalendarMonth && 
                               new Date().getFullYear() === currentCalendarYear;
                
                const dayCell = document.createElement('div');
                dayCell.style.cssText = `
                    aspect-ratio: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    border-radius: 6px;
                    position: relative;
                    cursor: pointer;
                    transition: all 0.3s;
                    ${hasItem ? 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);' : 'background: #f0f0f0;'}
                    ${isToday ? 'border: 2px solid #667eea;' : ''}
                    font-size: 10px;
                `;
                
                const dayNumber = document.createElement('div');
                dayNumber.style.cssText = `
                    font-size: 11px;
                    font-weight: 600;
                    ${hasItem ? 'color: white;' : 'color: #999;'}
                `;
                dayNumber.textContent = day;
                
                if (hasItem) {
                    const flame = document.createElement('div');
                    flame.style.cssText = 'font-size: 14px; margin-top: 1px; line-height: 1;';
                    flame.textContent = 'ğŸ”¥';
                    dayCell.appendChild(dayNumber);
                    dayCell.appendChild(flame);
                    
                    if (hasItem.count > 1) {
                        const count = document.createElement('div');
                        count.style.cssText = 'font-size: 8px; color: white; font-weight: 600; line-height: 1;';
                        count.textContent = `${hasItem.count}`;
                        dayCell.appendChild(count);
                    }
                } else {
                    dayCell.appendChild(dayNumber);
                }
                
                calendar.appendChild(dayCell);
            }
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        async function generateStoryTemplate(template) {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            const userData = userSnapshot.empty ? {} : userSnapshot.docs[0].data();
            
            const itemsQuery = query(collection(db, 'items'), where('userId', '==', currentUserId));
            const itemsSnapshot = await getDocs(itemsQuery);
            const userItems = [];
            itemsSnapshot.forEach(docSnapshot => userItems.push(docSnapshot.data()));
            
            if (template === 'minimal') {
                drawMinimalTemplate(ctx, userData, userItems);
            } else if (template === 'stats') {
                drawStatsTemplate(ctx, userData, userItems);
            } else if (template === 'streak') {
                drawStreakTemplate(ctx, userData);
            } else if (template === 'grid') {
                await drawGridTemplate(ctx, userData, userItems);
            }
            
            canvas.style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        }

        function drawMinimalTemplate(ctx, userData, items) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ¯ ë¹„ìš°ê¸° ì±Œë¦°ì§€', 540, 300);
            
            ctx.font = 'bold 180px sans-serif';
            ctx.fillText(userData.score || 0, 540, 800);
            
            ctx.font = '60px sans-serif';
            ctx.fillText('POINTS', 540, 900);
            
            ctx.font = 'bold 50px sans-serif';
            ctx.fillText(`${items.length}ê°œ ë¹„ì›€`, 540, 1100);
            
            ctx.font = '50px sans-serif';
            ctx.fillText(`ğŸ”¥ ${userData.streak || 0}ì¼ ì—°ì†`, 540, 1200);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1500);
            
            ctx.font = '40px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText('ë¯¸ë‹ˆë©€ë¼ì´í”„ ì‹¤ì²œ ì¤‘', 540, 1700);
        }

        function drawStatsTemplate(ctx, userData, items) {
            ctx.fillStyle = '#f8f9ff';
            ctx.fillRect(0, 0, 1080, 1920);
            
            const headerGradient = ctx.createLinearGradient(0, 0, 0, 400);
            headerGradient.addColorStop(0, '#667eea');
            headerGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = headerGradient;
            ctx.fillRect(0, 0, 1080, 400);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ“Š ë‚˜ì˜ ë¹„ìš°ê¸° í†µê³„', 540, 250);
            
            const categoryCount = {};
            items.forEach(item => {
                categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
            });
            
            const categories = [
                { key: 'furniture', name: 'ê°€êµ¬', emoji: 'ğŸ›‹ï¸' },
                { key: 'electronics', name: 'ì „ìì œí’ˆ', emoji: 'ğŸ“±' },
                { key: 'books', name: 'ì±…/ì¡ì§€', emoji: 'ğŸ“š' },
                { key: 'clothes', name: 'ì˜ë¥˜', emoji: 'ğŸ‘•' },
                { key: 'kitchen', name: 'ì£¼ë°©ìš©í’ˆ', emoji: 'ğŸ³' },
                { key: 'shoes', name: 'ì‹ ë°œ', emoji: 'ğŸ‘Ÿ' },
                { key: 'food', name: 'ìŒì‹', emoji: 'ğŸ”' },
                { key: 'toys', name: 'ì¥ë‚œê°', emoji: 'ğŸ§¸' },
                { key: 'sports', name: 'ìš´ë™ìš©í’ˆ', emoji: 'ğŸ‹ï¸' },
                { key: 'digital', name: 'ë””ì§€í„¸ ì‚¬ì§„/ë¬¸ì„œ', emoji: 'ğŸ“„' },
                { key: 'etc', name: 'ê¸°íƒ€', emoji: 'ğŸ“¦' }
            ];
            
            let y = 550;
            ctx.textAlign = 'left';
            categories.forEach(cat => {
                const count = categoryCount[cat.key] || 0;
                
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 20;
                ctx.fillRect(80, y - 80, 920, 120);
                ctx.shadowBlur = 0;
                
                ctx.font = '60px sans-serif';
                ctx.fillText(cat.emoji, 120, y);
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 50px sans-serif';
                ctx.fillText(cat.name, 220, y);
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 60px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${count}ê°œ`, 950, y);
                ctx.textAlign = 'left';
                
                y += 180;
            });
            
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 55px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`ì´ ${items.length}ê°œ â€¢ ${userData.score || 0}ì `, 540, 1750);
        }

        function drawStreakTemplate(ctx, userData) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
            gradient.addColorStop(0, '#f093fb');
            gradient.addColorStop(1, '#f5576c');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            ctx.font = '300px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ”¥', 540, 650);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 200px sans-serif';
            ctx.fillText(userData.streak || 0, 540, 1000);
            
            ctx.font = 'bold 80px sans-serif';
            ctx.fillText('ì¼ ì—°ì†', 540, 1120);
            
            ctx.font = '50px sans-serif';
            const streakVal = userData.streak || 0;
            let message = 'ë§¤ì¼ ì¡°ê¸ˆì”© ì‹¤ì²œ ì¤‘!';
            if (streakVal >= 30) message = 'í•œ ë‹¬ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!';
            else if (streakVal >= 7) message = 'ì¼ì£¼ì¼ ë‹¬ì„±! ë©‹ì ¸ìš”!';
            else if (streakVal >= 3) message = 'ì¢‹ì€ ìŠµê´€ ë§Œë“œëŠ” ì¤‘!';
            
            ctx.fillText(message, 540, 1400);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1650);
        }

        async function drawGridTemplate(ctx, userData, items) {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 1080, 1920);
            
            const headerGradient = ctx.createLinearGradient(0, 0, 0, 350);
            headerGradient.addColorStop(0, '#43e97b');
            headerGradient.addColorStop(1, '#38f9d7');
            ctx.fillStyle = headerGradient;
            ctx.fillRect(0, 0, 1080, 350);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`ğŸ“¸ ${items.length}ê°œ ë¹„ì› ì–´ìš”!`, 540, 220);
            
            const recentItems = items.slice(0, 6);
            const gridSize = 320;
            const gap = 30;
            const startX = 60;
            const startY = 400;
            
            for (let i = 0; i < 6; i++) {
                const row = Math.floor(i / 3);
                const col = i % 3;
                const x = startX + col * (gridSize + gap);
                const y = startY + row * (gridSize + gap);
                
                if (i < recentItems.length && recentItems[i].image) {
                    try {
                        const img = new Image();
                        img.src = recentItems[i].image;
                        await new Promise(resolve => {
                            img.onload = () => {
                                ctx.save();
                                ctx.beginPath();
                                ctx.roundRect(x, y, gridSize, gridSize, 20);
                                ctx.clip();
                                ctx.drawImage(img, x, y, gridSize, gridSize);
                                ctx.restore();
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) {
                        ctx.fillStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.roundRect(x, y, gridSize, gridSize, 20);
                        ctx.fill();
                    }
                } else {
                    ctx.fillStyle = '#f0f0f0';
                    ctx.beginPath();
                    ctx.roundRect(x, y, gridSize, gridSize, 20);
                    ctx.fill();
                }
            }
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`ğŸ† ${userData.score || 0}ì `, 270, 1650);
            ctx.fillText(`ğŸ”¥ ${userData.streak || 0}ì¼`, 810, 1650);
            
            ctx.font = 'bold 55px sans-serif';
            ctx.fillText(`- ${userName} -`, 540, 1800);
        }

        function downloadStoryImage() {
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = `declutter-story-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function initApp() {
            if (!currentUserId) return;
            document.getElementById('usernameInput').value = userName;
            updateProfileUI();
            await updateUserProfile();
            await loadMyItems();

            const userQuery = query(collection(db, 'users'), where('userId', '==', currentUserId));
            const userSnapshot = await getDocs(userQuery);
            if (!userSnapshot.empty) {
                const userData = userSnapshot.docs[0].data();
                userStreak = userData.streak || 0;
                userBadges = userData.badges || [];
                bingoProgress = userData.bingoProgress || {};
                document.getElementById('streakBadge').textContent = `ğŸ”¥ ${userStreak}ì¼ ì—°ì†`;
                renderBadges();
                renderBingoGrid();
            }
        }

        // Event Listeners
        document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('closeModalBtn').addEventListener('click', closeBadgeModal);
        document.getElementById('badgeOverlay').addEventListener('click', closeBadgeModal);
        document.getElementById('submitBtn').addEventListener('click', addItem);
        
        document.getElementById('usernameInput').addEventListener('change', function(e) {
            userName = e.target.value.trim() || userName;
            localStorage.setItem('userName', userName);
            if (currentUserId) {
                updateUserProfile();
            }
        });

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                currentImage = await compressImage(file, 500);
                
                const preview = document.getElementById('previewImage');
                const uploadArea = document.getElementById('uploadArea');
                const uploadPrompt = document.getElementById('uploadPrompt');
                
                preview.src = currentImage;
                preview.classList.add('show');
                uploadPrompt.style.display = 'none';
                uploadArea.classList.add('has-image');
            }
        });

        document.getElementById('uploadArea').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('itemCategory').addEventListener('change', function(e) {
            const pointsInfo = document.getElementById('pointsInfo');
            const expectedPoints = document.getElementById('expectedPoints');
            
            if (e.target.value) {
                expectedPoints.textContent = categoryPoints[e.target.value];
                pointsInfo.style.display = 'block';
            } else {
                pointsInfo.style.display = 'none';
            }
        });

        document.getElementById('addTabBtn').addEventListener('click', () => switchTab('add'));
        document.getElementById('bingoTabBtn').addEventListener('click', () => switchTab('bingo'));
        document.getElementById('historyTabBtn').addEventListener('click', () => switchTab('history'));
        document.getElementById('calendarTabBtn').addEventListener('click', () => switchTab('calendar'));
        document.getElementById('leaderboardTabBtn').addEventListener('click', () => switchTab('leaderboard'));
        document.getElementById('shareTabBtn').addEventListener('click', () => switchTab('share'));

        document.getElementById('itemSpace').addEventListener('change', updateSpaceHint);
        document.getElementById('achievementOverlay').addEventListener('click', hideAchievement);
        document.getElementById('bingoResetBtn').addEventListener('click', resetBingo);

        document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
        document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonth(1));

        document.getElementById('minimalBtn').addEventListener('click', () => generateStoryTemplate('minimal'));
        document.getElementById('statsBtn').addEventListener('click', () => generateStoryTemplate('stats'));
        document.getElementById('streakBtn').addEventListener('click', () => generateStoryTemplate('streak'));
        document.getElementById('gridBtn').addEventListener('click', () => generateStoryTemplate('grid'));
        document.getElementById('downloadBtn').addEventListener('click', downloadStoryImage);

        // Global functions
        window.toggleLike = toggleLike;
        window.toggleComments = toggleComments;
        window.addComment = addComment;
        window.deleteItem = deleteItem;

        // Check auth state
        (function checkAuthState() {
            const savedUserId = localStorage.getItem('userId');
            const savedProvider = localStorage.getItem('authProvider');

            if (savedUserId && savedProvider) {
                currentUserId = savedUserId;
                userName = localStorage.getItem('userName') || '';
                hideLoginScreen();
                initApp();
            } else {
                showLoginScreen();
            }
        })();
    </script>
</body>
</html>
